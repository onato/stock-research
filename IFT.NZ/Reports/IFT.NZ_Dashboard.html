<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infratil Limited (IFT.NZ) Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4aa, #00b894);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .header p {
            color: #888;
            font-size: 1.1rem;
        }
        /* Investment Overview Section */
        .overview-section {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        .overview-toggle {
            width: 100%;
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 12px;
            padding: 16px 24px;
            color: #00d4aa;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        .overview-toggle:hover {
            background: rgba(0, 212, 170, 0.2);
        }
        .overview-toggle .arrow {
            transition: transform 0.3s ease;
        }
        .overview-toggle.active .arrow {
            transform: rotate(180deg);
        }
        .overview-content {
            display: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 30px;
            margin-top: -12px;
        }
        .overview-content.active {
            display: block;
        }
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        .overview-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .overview-card h3 {
            color: #00d4aa;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .overview-card p {
            margin-bottom: 12px;
            line-height: 1.6;
        }
        .overview-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .overview-card li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            line-height: 1.5;
        }
        .overview-card li:last-child {
            border-bottom: none;
        }
        .overview-card.bull h3 { color: #00d4aa; }
        .overview-card.bear h3 { color: #ff6b6b; }
        .overview-card.risks h3 { color: #fdcb6e; }
        .risk-high { color: #ff6b6b; }
        .risk-moderate { color: #fdcb6e; }
        .risk-low { color: #00d4aa; }
        .revenue-stream {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .revenue-stream .percent {
            color: #00d4aa;
            font-weight: 600;
        }
        .trend-growing { color: #00d4aa; }
        .trend-stable { color: #888; }
        .trend-declining { color: #ff6b6b; }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        .kpi-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 170, 0.2);
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00d4aa;
            margin-bottom: 5px;
        }
        .kpi-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .kpi-change {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .kpi-change.positive { color: #00d4aa; }
        .kpi-change.negative { color: #ff6b6b; }
        /* Guidance Section */
        .guidance-section {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        .guidance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .guidance-header h3 {
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .guidance-header h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d4aa, #00b894);
            border-radius: 2px;
        }
        .guidance-meta {
            font-size: 0.85rem;
            color: #888;
        }
        .guidance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .guidance-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
        }
        .guidance-card:hover {
            transform: translateY(-2px);
        }
        .guidance-metric {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .guidance-target {
            font-size: 1.4rem;
            font-weight: 600;
            color: #00d4aa;
            margin-bottom: 6px;
        }
        .guidance-period {
            font-size: 0.85rem;
            color: #e0e0e0;
            margin-bottom: 8px;
        }
        .guidance-vs-prior {
            display: inline-block;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .guidance-vs-prior.raised {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
        }
        .guidance-vs-prior.lowered {
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
        }
        .guidance-vs-prior.maintained {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }
        .guidance-vs-prior.new {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }
        .guidance-vs-prior[class*="revised"] {
            background: rgba(253, 203, 110, 0.15);
            color: #fdcb6e;
        }
        .guidance-vs-prior[class*="tightened"] {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }
        .guidance-notes {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }
        .guidance-commentary {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 16px 20px;
            border-left: 3px solid #00d4aa;
            font-style: italic;
            color: #b0b0b0;
            line-height: 1.6;
        }
        .guidance-commentary::before {
            content: '"';
            font-size: 1.5rem;
            color: #00d4aa;
            margin-right: 4px;
        }
        .section-title {
            font-size: 1.5rem;
            color: #fff;
            margin: 40px auto 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 212, 170, 0.3);
            max-width: 1400px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .chart-header h3 {
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-header h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d4aa, #00b894);
            border-radius: 2px;
        }
        .help-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 212, 170, 0.2);
            border: 1px solid #00d4aa;
            color: #00d4aa;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .help-btn:hover {
            background: #00d4aa;
            color: #1a1a2e;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: linear-gradient(135deg, #1e2a4a 0%, #16213e 100%);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(0, 212, 170, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            color: #00d4aa;
            font-size: 1.4rem;
            margin: 0;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: #ff6b6b;
            color: #fff;
        }
        .modal-body {
            padding: 25px;
            line-height: 1.7;
        }
        .modal-body p { margin-bottom: 15px; }
        .modal-body strong { color: #00d4aa; }
        .modal-body ul { margin: 15px 0; padding-left: 20px; }
        .modal-body li { margin-bottom: 8px; }
        .metric-highlight {
            background: rgba(0, 212, 170, 0.1);
            border-left: 3px solid #00d4aa;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        /* DCF Valuation Section */
        .dcf-section {
            max-width: 1400px;
            margin: 0 auto 40px;
        }
        .dcf-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dcf-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        .dcf-card:hover {
            transform: translateY(-3px);
        }
        .dcf-card.highlight {
            background: rgba(0, 212, 170, 0.1);
            border-color: rgba(0, 212, 170, 0.3);
        }
        .dcf-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .dcf-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #00d4aa;
        }
        .dcf-card:not(.highlight) .dcf-value {
            color: #fff;
        }
        .dcf-change {
            font-size: 1rem;
            margin-top: 8px;
            font-weight: 600;
        }
        .dcf-change.positive { color: #00d4aa; }
        .dcf-change.negative { color: #ff6b6b; }
        .dcf-sublabel {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
        }
        .dcf-warning {
            background: rgba(253, 203, 110, 0.15);
            border: 1px solid rgba(253, 203, 110, 0.4);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fdcb6e;
        }
        .warning-icon {
            font-size: 1.2rem;
        }
        /* DCF Inputs Display */
        .dcf-inputs {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .dcf-inputs h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .dcf-inputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .dcf-input-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .dcf-input-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .dcf-input-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #00d4aa;
        }
        .dcf-input-note {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }
        .fcf-projections h5 {
            color: #b0b0b0;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .fcf-projection-table {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px;
        }
        .fcf-projection-item {
            text-align: center;
        }
        .fcf-projection-item.header {
            font-size: 0.75rem;
            color: #888;
            font-weight: 600;
        }
        .fcf-projection-item .year {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 2px;
        }
        .fcf-projection-item .fcf-value {
            font-size: 1rem;
            color: #e0e0e0;
            font-weight: 500;
        }
        .fcf-projection-item .growth-rate {
            font-size: 0.75rem;
            color: #00d4aa;
            margin-top: 2px;
        }
        .dcf-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .slider-group label {
            font-size: 0.95rem;
            color: #e0e0e0;
            display: flex;
            justify-content: space-between;
        }
        .slider-group label span {
            color: #00d4aa;
            font-weight: 600;
        }
        .slider-group input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00d4aa;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00d4aa;
            cursor: pointer;
            border: none;
        }
        .slider-hint {
            font-size: 0.8rem;
            color: #666;
        }
        .scenario-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .scenario-tab {
            padding: 10px 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .scenario-tab:hover {
            border-color: rgba(0, 212, 170, 0.5);
            color: #e0e0e0;
        }
        .scenario-tab.active {
            background: rgba(0, 212, 170, 0.15);
            border-color: #00d4aa;
            color: #00d4aa;
        }
        .scenario-details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .scenario-details h4 {
            color: #00d4aa;
            margin-bottom: 15px;
        }
        .assumption-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .assumption-item {
            text-align: center;
        }
        .assumption-item .label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 4px;
        }
        .assumption-item .value {
            font-size: 1.1rem;
            color: #e0e0e0;
            font-weight: 500;
        }
        .sensitivity-section {
            margin-bottom: 30px;
        }
        .sensitivity-section h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        .sensitivity-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
        }
        .sensitivity-table th,
        .sensitivity-table td {
            padding: 12px 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .sensitivity-table th {
            background: rgba(0, 212, 170, 0.1);
            color: #00d4aa;
            font-weight: 600;
        }
        .sensitivity-table td {
            color: #e0e0e0;
        }
        .sensitivity-table td.highlight {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
            font-weight: 600;
        }
        .sensitivity-table td.below-current {
            color: #ff6b6b;
        }
        .sensitivity-table td.above-current {
            color: #00d4aa;
        }
        .historical-growth {
            margin-bottom: 30px;
        }
        .historical-growth h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        .growth-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        .growth-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .growth-item .metric {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 6px;
        }
        .growth-item .rate {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .growth-item .rate.positive { color: #00d4aa; }
        .growth-item .rate.negative { color: #ff6b6b; }
        .growth-item.selected {
            border-color: #00d4aa;
            background: rgba(0, 212, 170, 0.1);
        }
        .dcf-download {
            text-align: center;
            margin-top: 30px;
        }
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            background: rgba(0, 212, 170, 0.15);
            border: 1px solid #00d4aa;
            border-radius: 8px;
            color: #00d4aa;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        .download-btn:hover {
            background: #00d4aa;
            color: #1a1a2e;
        }
        .download-icon {
            font-size: 1.2rem;
        }
        @media (max-width: 768px) {
            .charts-container { grid-template-columns: 1fr; }
            .overview-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Infratil Limited (IFT.NZ)</h1>
        <p>Infrastructure Investment Company | New Zealand</p>
    </div>

    <!-- Investment Overview Section -->
    <div class="overview-section">
        <button class="overview-toggle" onclick="toggleOverview()">
            <span>Investment Overview & Analysis</span>
            <span class="arrow">▼</span>
        </button>
        <div class="overview-content" id="overviewContent">
            <div class="overview-grid">
                <!-- Company Overview -->
                <div class="overview-card">
                    <h3>Company Overview</h3>
                    <p>Infratil is a New Zealand-based infrastructure investment company that owns and operates a diversified portfolio of 15 infrastructure assets across four key sectors: Digital Infrastructure (66%), Renewable Energy (21%), Healthcare (8%), and Airports (5%). The company operates globally with investments in 18 countries across Australasia, North America, Asia, Europe, and the UK.</p>
                </div>

                <!-- Business Model -->
                <div class="overview-card">
                    <h3>Business Model</h3>
                    <p>Infratil generates returns through capital appreciation, dividends from portfolio companies, and active portfolio management. Externally managed by Morrison & Co, targeting 11-15% annual shareholder returns.</p>
                    <ul>
                        <li class="revenue-stream"><span>CDC Data Centres</span> <span class="percent">41%</span> <span class="trend-growing">↑</span></li>
                        <li class="revenue-stream"><span>One NZ (Telecom)</span> <span class="percent">20%</span> <span class="trend-stable">→</span></li>
                        <li class="revenue-stream"><span>Longroad Energy</span> <span class="percent">12%</span> <span class="trend-growing">↑</span></li>
                        <li class="revenue-stream"><span>Contact Energy</span> <span class="percent">9%</span> <span class="trend-growing">↑</span></li>
                        <li class="revenue-stream"><span>Wellington Airport</span> <span class="percent">5%</span> <span class="trend-stable">→</span></li>
                        <li class="revenue-stream"><span>Healthcare</span> <span class="percent">5%</span> <span class="trend-stable">→</span></li>
                        <li class="revenue-stream"><span>Other investments</span> <span class="percent">8%</span> <span class="trend-growing">↑</span></li>
                    </ul>
                </div>

                <!-- Competitive Position -->
                <div class="overview-card">
                    <h3>Competitive Position</h3>
                    <p><strong>Main Competitors:</strong> Brookfield Asset Management, Macquarie Infrastructure, First Sentier Investors</p>
                    <p><strong>Market Position:</strong> Leading infrastructure investor in NZ, NZ$10B market cap, included in MSCI Global Standard Index and ASX 200</p>
                    <p><strong>Moat Factors:</strong></p>
                    <ul>
                        <li><strong>Scale advantages</strong> - CDC top-tier data centre operator in Australasia with contracted growth</li>
                        <li><strong>Long-term contracts</strong> - Data centre 10-15 years, renewable PPAs 15-25 years</li>
                        <li><strong>Morrison & Co expertise</strong> - 30+ years infrastructure investment experience</li>
                        <li><strong>Regulatory barriers</strong> - Spectrum licenses, airport monopoly, grid connections</li>
                    </ul>
                </div>

                <!-- Growth Drivers -->
                <div class="overview-card">
                    <h3>Growth Drivers</h3>
                    <ul>
                        <li>AI-driven data centre demand - CDC targeting to double FY25 EBITDAF by FY27</li>
                        <li>US renewable energy build-out - Longroad growing from 3.5GW to 10GW by 2028</li>
                        <li>Energy transition - Contact-Manawa merger adding 500MW capacity</li>
                        <li>Portfolio optimization - NZ$1B divestment program (58% complete)</li>
                        <li>Digital-renewable synergies - Longroad supplying power to data centres</li>
                        <li>New growth platforms - Advanced logistics, transportation, financial systems</li>
                    </ul>
                </div>

                <!-- Key Risks -->
                <div class="overview-card risks">
                    <h3>Key Risks</h3>
                    <ul>
                        <li><span class="risk-high">HIGH:</span> CDC concentration risk (41% of portfolio value)</li>
                        <li><span class="risk-high">HIGH:</span> NZ economic weakness affecting One NZ, Wellington Airport</li>
                        <li><span class="risk-high">HIGH:</span> Interest rate sensitivity (NZ$2.2B net debt)</li>
                        <li><span class="risk-moderate">MODERATE:</span> Data centre demand volatility from AI cycle uncertainty</li>
                        <li><span class="risk-moderate">MODERATE:</span> US renewable policy changes (IRA tax credits)</li>
                        <li><span class="risk-moderate">MODERATE:</span> Foreign currency exposure (65% offshore assets)</li>
                        <li><span class="risk-moderate">MODERATE:</span> Complex development projects (Gurin's US$2-3B Project Vanda)</li>
                    </ul>
                </div>

                <!-- Bull Case -->
                <div class="overview-card bull">
                    <h3>Bull Case</h3>
                    <ul>
                        <li>AI-driven data centre supercycle - CDC perfectly positioned with 1,600MW pipeline</li>
                        <li>Unique convergence play - Scale positions in both data centres and renewables</li>
                        <li>Portfolio rerating potential - Analyst consensus NZ$13.58 implies 20%+ upside</li>
                        <li>Proven track record - 18% annualized returns since inception, 17% over past 10 years</li>
                        <li>Free cash flow inflection - CDC/Longroad build programs completing</li>
                        <li>Structural tailwinds - Digitization, energy transition, aging populations</li>
                    </ul>
                </div>

                <!-- Bear Case -->
                <div class="overview-card bear">
                    <h3>Bear Case</h3>
                    <ul>
                        <li>CDC concentration risk - 41% portfolio weight creates volatility exposure</li>
                        <li>NZ economic malaise - Persistent recession impacts 35%+ of portfolio</li>
                        <li>Higher-for-longer rates - Refinancing costs, valuation compression</li>
                        <li>Execution risks - CDC A$250M, Longroad US$110M, Gurin US$2-3B</li>
                        <li>Management fee drag - External management structure reduces net returns</li>
                        <li>Portfolio simplification challenge - NZ$1B divestment in tough M&A market</li>
                    </ul>
                </div>

                <!-- Recent Developments -->
                <div class="overview-card">
                    <h3>Recent Developments</h3>
                    <ul>
                        <li><strong>Nov 2025:</strong> Sale of 20% Fortysouth (>NZ$200M) and legacy property (NZ$55M)</li>
                        <li><strong>Oct 2025:</strong> CDC announced 140MW new contracts, Perth expansion (200MW)</li>
                        <li><strong>Oct 2025:</strong> Acquired 4.92% Contact Energy stake for NZ$438M</li>
                        <li><strong>Sep 2025:</strong> Strategic review of Qscan (57% stake, NZ$487M)</li>
                        <li><strong>Aug 2025:</strong> Sale of 50% RetireAustralia for NZ$331M to Invesco</li>
                        <li><strong>Jul 2025:</strong> Added to S&P/ASX 200 Index</li>
                        <li><strong>May 2025:</strong> FY2025 results - EBITDAF NZ$986M (up 8.6%), 10-yr TSR 17.0% p.a.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- Management Guidance Section -->
    <div class="guidance-section" id="guidanceSection">
        <div class="guidance-header">
            <h3>Management Guidance</h3>
            <span class="guidance-meta">As of <span id="guidanceAsOf">HY FY2026 Results (November 2025)</span> | <span id="guidanceFY">FY2026</span></span>
        </div>
        <div class="guidance-grid" id="guidanceGrid"></div>
        <div class="guidance-commentary" id="guidanceCommentary"></div>
    </div>

    <!-- Charts -->
    <h2 class="section-title">Operational Performance</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Share of EBITDAF</h3>
                <button class="help-btn" onclick="openModal('shareOfEBITDAF')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="shareOfEBITDAFChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-header">
                <h3>Net Parent Surplus</h3>
                <button class="help-btn" onclick="openModal('netParentSurplus')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="netParentSurplusChart"></canvas>
            </div>
        </div>
    </div>

    <h2 class="section-title">Portfolio Composition</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Portfolio Company Contributions (FY2025)</h3>
                <button class="help-btn" onclick="openModal('portfolioComposition')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="portfolioCompositionChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-header">
                <h3>CDC Data Centres Contribution</h3>
                <button class="help-btn" onclick="openModal('cdcContribution')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="cdcContributionChart"></canvas>
            </div>
        </div>
    </div>

    <h2 class="section-title">Financial Health</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Total Equity / NAV</h3>
                <button class="help-btn" onclick="openModal('totalEquity')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="totalEquityChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-header">
                <h3>Net Debt</h3>
                <button class="help-btn" onclick="openModal('netDebt')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="netDebtChart"></canvas>
            </div>
        </div>
    </div>

    <h2 class="section-title">Shareholder Returns</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Dividend Per Share</h3>
                <button class="help-btn" onclick="openModal('dividendPerShare')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="dividendPerShareChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-header">
                <h3>Portfolio Value Growth</h3>
                <button class="help-btn" onclick="openModal('portfolioValue')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="portfolioValueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- DCF Valuation Section -->
    <h2 class="section-title">DCF Valuation</h2>
    <div class="dcf-section">
        <!-- Valuation Summary Cards -->
        <div class="dcf-summary">
            <div class="dcf-card highlight">
                <div class="dcf-label">Intrinsic Value</div>
                <div class="dcf-value" id="dcfIV">NZ$10.33</div>
                <div class="dcf-change" id="dcfUpside">-6% downside</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Entry Price (15% CAGR)</div>
                <div class="dcf-value" id="dcfEntry">NZ$7.81</div>
                <div class="dcf-sublabel">Buy below for 15% annual return</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Current Price</div>
                <div class="dcf-value" id="dcfCurrent">NZ$11.03</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Prob-Weighted IV</div>
                <div class="dcf-value" id="dcfWeighted">NZ$11.10</div>
                <div class="dcf-sublabel">30% Bull / 50% Base / 20% Bear</div>
            </div>
        </div>

        <!-- Growth Rate Warning -->
        <div class="dcf-warning" id="growthWarning">
            <span class="warning-icon">&#9888;</span>
            <span id="warningText">Infratil as an investment holding company has volatile net income/FCF due to revaluations. Using ShareOfEBITDAF (21.8% CAGR) and TotalEquity (28.6% CAGR) as primary growth indicators.</span>
        </div>

        <!-- DCF Inputs Display -->
        <div class="dcf-inputs">
            <h4>DCF Model Inputs</h4>
            <div class="dcf-inputs-grid">
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Base Year FCF</div>
                    <div class="dcf-input-value" id="baseFCF">NZ$600M</div>
                    <div class="dcf-input-note">Normalized from historical surplus</div>
                </div>
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Shares Outstanding</div>
                    <div class="dcf-input-value" id="sharesOut">979.6M</div>
                </div>
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Net Debt</div>
                    <div class="dcf-input-value" id="netDebt">NZ$2,622M</div>
                    <div class="dcf-input-note">Corporate + portfolio level</div>
                </div>
            </div>
            <div class="fcf-projections">
                <h5>Projected FCF (5-Year)</h5>
                <div class="fcf-projection-table" id="fcfProjectionTable"></div>
            </div>
        </div>

        <!-- Interactive Sliders -->
        <div class="dcf-controls">
            <div class="slider-group">
                <label>Growth Rate: <span id="growthValue">18%</span></label>
                <input type="range" id="growthSlider" min="0" max="30" value="18" step="1">
                <div class="slider-hint" id="growthHint">Based on equity CAGR adjusted</div>
            </div>
            <div class="slider-group">
                <label>WACC: <span id="waccValue">10.5%</span></label>
                <input type="range" id="waccSlider" min="6" max="18" value="10.5" step="0.5">
            </div>
            <div class="slider-group">
                <label>Terminal Growth: <span id="terminalValue">3.0%</span></label>
                <input type="range" id="terminalSlider" min="0" max="5" value="3.0" step="0.5">
            </div>
        </div>

        <!-- Scenario Tabs -->
        <div class="scenario-tabs">
            <button class="scenario-tab active" data-scenario="base" onclick="switchScenario('base')">Base Case</button>
            <button class="scenario-tab" data-scenario="bull" onclick="switchScenario('bull')">Bull Case</button>
            <button class="scenario-tab" data-scenario="bear" onclick="switchScenario('bear')">Bear Case</button>
        </div>

        <!-- Scenario Details -->
        <div class="scenario-details" id="scenarioDetails">
            <div class="scenario-assumptions">
                <h4>Assumptions</h4>
                <div class="assumption-grid" id="assumptionGrid"></div>
            </div>
        </div>

        <!-- Sensitivity Table -->
        <div class="sensitivity-section">
            <h4>Sensitivity Analysis: Intrinsic Value by WACC & Terminal Growth</h4>
            <table class="sensitivity-table" id="sensitivityMatrix"></table>
        </div>

        <!-- Historical Growth Rates -->
        <div class="historical-growth">
            <h4>Historical Growth Rates (CAGR)</h4>
            <div class="growth-grid" id="growthGrid"></div>
        </div>
    </div>

    <!-- Modal for metric descriptions -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // EMBEDDED CSV DATA
        const csvData = `Period,ShareOfEBITDAF,NetParentSurplus,TotalAssets,TotalEquity,NetDebt,DividendPerShare,SharesOutstanding,PortfolioValue,CDCContribution,OneNZContribution,WellingtonAirportContribution,LongroadContribution,RetireAustraliaContribution,ManawaEnergyContribution,QscanContribution,RHCNZContribution
H1-FY2022,265.5,1080.6,,6340.5,622.6,,723.0,6621.4,38.3,120.4,20.8,13.7,6.3,54.4,18.7,13.6
FY2022,507.0,1169.3,,7679.2,622.6,,724.0,8301.8,82.2,243.8,37.3,15.1,16.9,83.9,33.9,32.9
H1-FY2023,277.4,350.5,,8332.7,1012.1,,724.0,9344.8,51.9,128.8,26.5,21.7,10.9,35.7,15.2,26.6
FY2023,533.3,643.1,,9182.3,724.6,,724.0,9906.9,113.7,263.6,59.1,16.4,6.1,69.9,33.8,54.4
H1-FY2024,399.6,1149.9,,10408.0,2082.7,6.75,831.9,12490.7,64.3,225.1,33.4,34.6,6.3,39.8,18.2,30.7
FY2024,863.8,769.9,,11944.3,2264.8,12.5,832.6,14209.1,140.8,545.5,70.7,33.4,12.1,74.1,40.6,58.1
H1-FY2025,478.8,-247.3,,13958.2,1292.6,7.0,966.5,15250.8,83.7,304.0,41.6,22.1,17.3,23.3,23.8,31.6
FY2025,917.8,-286.3,18303.7,16115.9,2187.8,14.5,968.1,18303.7,173.9,604.0,86.1,27.3,21.6,46.6,48.7,63.2
H1-FY2026,499.7,605.7,19038.7,15231.6,2622.2,,979.6,19038.7,99.9,295.3,43.3,51.9,11.6,12.5,26.3,32.8`;

        // EMBEDDED ANALYSIS JSON
        const analysis = {
  "ticker": "IFT.NZ",
  "company_name": "Infratil Limited",
  "analysis_date": "2026-02-03",
  "overview": "Infratil is a New Zealand-based infrastructure investment company that owns and operates a diversified portfolio of 15 infrastructure assets across four key sectors: Digital Infrastructure (66%), Renewable Energy (21%), Healthcare (8%), and Airports (5%). The company operates globally with investments in 18 countries across Australasia, North America, Asia, Europe, and the UK. Infratil's strategy focuses on 'ideas that matter' - infrastructure sectors shaped by enduring social and economic trends including digitization, decarbonization, and aging populations.",
  "business_model": {
    "summary": "Infratil generates returns through a combination of capital appreciation, dividends from portfolio companies, and active portfolio management. The company is externally managed by Morrison & Co under a management agreement, targeting 11-15% annual shareholder returns over a ten-year rolling basis.",
    "revenue_streams": [
      {
        "name": "CDC Data Centres",
        "percent": 41,
        "trend": "growing"
      },
      {
        "name": "One NZ (Telecommunications)",
        "percent": 20,
        "trend": "stable"
      },
      {
        "name": "Longroad Energy (US Renewables)",
        "percent": 12,
        "trend": "growing"
      },
      {
        "name": "Contact Energy (NZ power generation)",
        "percent": 9,
        "trend": "growing"
      },
      {
        "name": "Wellington Airport",
        "percent": 5,
        "trend": "stable"
      },
      {
        "name": "Healthcare (Qscan, RHCNZ)",
        "percent": 5,
        "trend": "stable"
      },
      {
        "name": "Other investments (Kao Data, Galileo, Gurin, Mint)",
        "percent": 8,
        "trend": "growing"
      }
    ],
    "customer_type": "Mix of B2B (data centres, wholesale energy, telecom infrastructure) and B2C (retail telecommunications, medical imaging, airport services)",
    "geographic_mix": "New Zealand 35%, Australia 30%, United States 20%, Asia 10%, Europe/UK 5%",
    "portfolio_structure": "Three-pillar approach: Pillar 1 (cash generators: One NZ, Contact Energy, Wellington Airport), Pillar 2 (mature growth: CDC, Longroad), Pillar 3 (future growth: Gurin, Galileo, Kao Data, Mint)"
  },
  "guidance": {
    "as_of": "HY FY2026 Results (November 2025)",
    "fiscal_year": "FY2026",
    "items": [
      {
        "metric": "Proportionate Operational EBITDAF",
        "target": "NZ$960-1,000 million",
        "period": "FY2026",
        "vs_prior": "revised down",
        "notes": "Originally NZ$1,000-1,050m on like-for-like basis excluding Manawa. Revised down to reflect RetireAustralia and Fortysouth divestments. Implies 9% growth on like-for-like basis vs FY2025"
      },
      {
        "metric": "Development EBITDAF Loss",
        "target": "NZ$85-100 million loss",
        "period": "FY2026",
        "vs_prior": "tightened range",
        "notes": "Relates to renewable development businesses (Gurin Energy, Galileo, Mint Renewables) investing in early-stage development. Originally NZ$85-105m loss"
      },
      {
        "metric": "Proportionate Capital Expenditure",
        "target": "NZ$2.2-2.6 billion",
        "period": "FY2026",
        "vs_prior": "maintained",
        "notes": "CDC and Longroad account for 69% of capex. Major programs: CDC capacity expansion, Longroad construction, Contact/Manawa integration projects"
      },
      {
        "metric": "CDC Investment",
        "target": "A$250 million",
        "period": "Next 12 months",
        "vs_prior": "new",
        "notes": "Additional equity injection into CDC alongside partner contributions to fund capacity expansion and contract deliveries. CDC targeting to double FY25 EBITDAF by FY27"
      },
      {
        "metric": "Longroad Investment",
        "target": "US$110 million committed",
        "period": "Through 2027",
        "vs_prior": "maintained",
        "notes": "Funding Longroad's build program. Longroad targeting growth from 3.5GW to 10GW operating capacity by 2028"
      },
      {
        "metric": "Asset Divestments",
        "target": "NZ$1 billion+ proceeds",
        "period": "Next 2-3 years",
        "vs_prior": "new strategic target",
        "notes": "Portfolio simplification program. 58% complete with RetireAustralia (NZ$331m), Fortysouth (>NZ$200m), property (NZ$55m) sales announced. Qscan under strategic review"
      },
      {
        "metric": "Operating Cash Flow Balance",
        "target": "Distributions to cover fixed costs and dividends",
        "period": "Next 2-3 years",
        "vs_prior": "new strategic target",
        "notes": "Pillar 1 distributions expected to cover annual fixed outgoings and dividends as CDC/Longroad build programs complete and One NZ free cash flow grows"
      }
    ],
    "management_commentary": "Chair Alison Gerry and CEO Jason Boyes emphasize confidence in navigating market volatility through focus on quality assets in structural growth sectors. CDC demand remains robust with contract momentum. Portfolio evolution underway to simplify holdings and concentrate on scaling core platforms. Target inclusion in ASX 200 index within next year to broaden shareholder base"
  }
};

        // EMBEDDED DCF JSON
        const dcfData = {
  "ticker": "IFT.NZ",
  "valuation_date": "2026-02-03",
  "current_price": 11.03,

  "inputs": {
    "shares_outstanding": 979.6,
    "net_debt": 2622.2,
    "last_fcf": 600.0,
    "currency": "NZD",
    "units": "millions",
    "notes": "Infratil is an investment holding company. FCF based on normalized NetParentSurplus (FY2025 was negative due to revaluations). Using FY2022-2024 average adjusted for portfolio growth."
  },

  "historical_growth": {
    "revenue_3yr_cagr": 21.8,
    "revenue_5yr_cagr": 21.8,
    "eps_3yr_cagr": -100.0,
    "eps_5yr_cagr": -100.0,
    "equity_3yr_cagr": 28.6,
    "equity_5yr_cagr": 28.6,
    "fcf_3yr_cagr": -100.0,
    "fcf_5yr_cagr": -100.0,
    "selected_growth_rate": 20.0,
    "growth_rate_source": "equity_3yr_cagr_adjusted",
    "growth_divergence_warning": "Infratil as an investment holding company has volatile net income/FCF due to revaluations. Using ShareOfEBITDAF (21.8% CAGR) and TotalEquity (28.6% CAGR) as primary growth indicators. Selected 20% conservative rate given strong CDC/Longroad growth drivers."
  },

  "assumptions": {
    "base": {
      "growth_rates": [18, 16, 14, 12, 10],
      "fcf_margin": null,
      "wacc": 10.5,
      "terminal_growth": 3.0,
      "notes": "Base case reflects CDC doubling EBITDAF by FY27, Longroad scaling to 10GW by 2028, but tempered by NZ economic weakness and interest rate headwinds"
    },
    "bull": {
      "growth_rates": [25, 22, 20, 18, 15],
      "fcf_margin": null,
      "wacc": 9.5,
      "terminal_growth": 3.5,
      "notes": "Bull case: AI data centre supercycle sustained, CDC pipeline conversion accelerates, Longroad-Meta synergies expand, portfolio NAV discount narrows with ASX 200 inclusion"
    },
    "bear": {
      "growth_rates": [10, 8, 6, 5, 4],
      "fcf_margin": null,
      "wacc": 12.0,
      "terminal_growth": 2.0,
      "notes": "Bear case: AI bubble deflates impacting CDC valuations, NZ recession deepens, higher-for-longer interest rates compress multiples, execution risks on US$2-3bn Gurin project"
    }
  },

  "projections": {
    "base": {
      "years": ["Y1", "Y2", "Y3", "Y4", "Y5"],
      "revenue": [917.8, 1083.0, 1256.3, 1432.2, 1604.0, 1764.4],
      "fcf": [600.0, 708.0, 821.3, 936.3, 1048.6, 1153.5],
      "discount_factors": [0.905, 0.819, 0.741, 0.671, 0.607],
      "pv_fcf": [640.7, 672.6, 693.8, 703.8, 700.3]
    },
    "bull": {
      "years": ["Y1", "Y2", "Y3", "Y4", "Y5"],
      "revenue": [917.8, 1147.3, 1399.3, 1679.1, 1981.4, 2278.6],
      "fcf": [600.0, 750.0, 915.0, 1098.0, 1295.6, 1490.0],
      "discount_factors": [0.913, 0.834, 0.762, 0.695, 0.635],
      "pv_fcf": [685.0, 763.1, 836.6, 900.4, 946.2]
    },
    "bear": {
      "years": ["Y1", "Y2", "Y3", "Y4", "Y5"],
      "revenue": [917.8, 1009.6, 1090.4, 1155.8, 1213.6, 1262.1],
      "fcf": [600.0, 660.0, 712.8, 755.5, 792.8, 824.5],
      "discount_factors": [0.893, 0.797, 0.712, 0.636, 0.567],
      "pv_fcf": [589.3, 568.1, 538.2, 503.9, 467.8]
    }
  },

  "valuation": {
    "base": {
      "sum_pv_fcf": 3411.2,
      "terminal_value": 15376.7,
      "pv_terminal": 9333.7,
      "enterprise_value": 12744.9,
      "equity_value": 10122.7,
      "intrinsic_value": 10.33,
      "upside": -6.3
    },
    "bull": {
      "sum_pv_fcf": 4131.3,
      "terminal_value": 22984.6,
      "pv_terminal": 14595.0,
      "enterprise_value": 18726.3,
      "equity_value": 16104.1,
      "intrinsic_value": 16.44,
      "upside": 49.0
    },
    "bear": {
      "sum_pv_fcf": 2667.3,
      "terminal_value": 8245.0,
      "pv_terminal": 4675.1,
      "enterprise_value": 7342.4,
      "equity_value": 4720.2,
      "intrinsic_value": 4.82,
      "upside": -56.3
    }
  },

  "entry_price": {
    "base": {
      "terminal_value_per_share": 15.70,
      "years_to_terminal": 5,
      "entry_price": 7.81,
      "entry_discount_from_current": -29.2
    },
    "bull": {
      "terminal_value_per_share": 23.46,
      "years_to_terminal": 5,
      "entry_price": 11.66,
      "entry_discount_from_current": 5.7
    },
    "bear": {
      "terminal_value_per_share": 8.42,
      "years_to_terminal": 5,
      "entry_price": 4.19,
      "entry_discount_from_current": -62.0
    }
  },

  "sensitivity": {
    "wacc_range": [8.5, 9.5, 10.5, 11.5, 12.5],
    "terminal_growth_range": [2.0, 2.5, 3.0, 3.5, 4.0],
    "matrix": [
      [14.85, 16.23, 17.95, 20.21, 23.32],
      [12.68, 13.76, 15.05, 16.64, 18.68],
      [11.05, 11.88, 12.88, 14.09, 15.63],
      [9.77, 10.44, 11.23, 12.17, 13.32],
      [8.75, 9.30, 9.95, 10.72, 11.65]
    ]
  },

  "probability_weighted": {
    "weights": {"bull": 0.30, "base": 0.50, "bear": 0.20},
    "weighted_iv": 11.10
  }
};

        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
                return obj;
            });
        }

        const data = parseCSV(csvData);

        // Sort data chronologically (oldest first)
        data.sort((a, b) => {
            const parseDate = (p) => {
                const year = parseInt(p.match(/\d{4}/)?.[0] || '0');
                const isH1 = p.includes('H1');
                const isH2 = p.includes('H2');
                const isFY = p.startsWith('FY');
                const subOrder = isH1 ? 1 : isH2 ? 2 : isFY ? 3 : 0;
                return year * 10 + subOrder;
            };
            return parseDate(a.Period) - parseDate(b.Period);
        });

        // Filter for annual data (FY periods)
        const fyData = data.filter(d => d.Period.startsWith('FY'));

        // Helper function to format numbers
        const formatNum = (n, decimals = 0) => {
            if (!n || n === '') return 'N/A';
            const num = parseFloat(n);
            if (isNaN(num)) return 'N/A';
            return num.toFixed(decimals);
        };

        const formatCurrency = (n) => {
            if (!n || n === '') return 'N/A';
            const num = parseFloat(n);
            if (isNaN(num)) return 'N/A';
            if (Math.abs(num) >= 1000) return 'NZ$' + (num/1000).toFixed(1) + 'B';
            return 'NZ$' + num.toFixed(0) + 'M';
        };

        // YoY calculation
        function calcYoYChange(current, previous) {
            if (!previous || !current || previous === '' || current === '') return null;
            const curr = parseFloat(current);
            const prev = parseFloat(previous);
            if (isNaN(curr) || isNaN(prev) || prev === 0) return null;
            return ((curr - prev) / Math.abs(prev) * 100).toFixed(1);
        }

        // Render KPI cards
        function renderKPIs() {
            const latest = data[data.length - 1];
            const previous = data[data.length - 2];

            const kpis = [
                {
                    label: 'Share of EBITDAF',
                    value: formatCurrency(latest.ShareOfEBITDAF),
                    change: calcYoYChange(latest.ShareOfEBITDAF, previous.ShareOfEBITDAF)
                },
                {
                    label: 'Total Equity / NAV',
                    value: formatCurrency(latest.TotalEquity),
                    change: calcYoYChange(latest.TotalEquity, previous.TotalEquity)
                },
                {
                    label: 'Net Debt',
                    value: formatCurrency(latest.NetDebt),
                    change: calcYoYChange(latest.NetDebt, previous.NetDebt)
                },
                {
                    label: 'Dividend Per Share',
                    value: latest.DividendPerShare ? 'NZ$' + formatNum(latest.DividendPerShare, 2) : 'N/A',
                    change: calcYoYChange(latest.DividendPerShare, previous.DividendPerShare)
                },
                {
                    label: 'Intrinsic Value (DCF)',
                    value: 'NZ$' + dcfData.valuation.base.intrinsic_value.toFixed(2),
                    change: dcfData.valuation.base.upside.toFixed(1)
                },
                {
                    label: 'Entry Price (15% CAGR)',
                    value: 'NZ$' + dcfData.entry_price.base.entry_price.toFixed(2),
                    change: dcfData.entry_price.base.entry_discount_from_current.toFixed(1)
                }
            ];

            const grid = document.getElementById('kpiGrid');
            grid.innerHTML = kpis.map(kpi => {
                let changeHtml = '';
                if (kpi.change !== null) {
                    const changeClass = parseFloat(kpi.change) >= 0 ? 'positive' : 'negative';
                    const changeSign = parseFloat(kpi.change) >= 0 ? '+' : '';
                    changeHtml = `<div class="kpi-change ${changeClass}">${changeSign}${kpi.change}%</div>`;
                }
                return `
                    <div class="kpi-card">
                        <div class="kpi-value">${kpi.value}</div>
                        <div class="kpi-label">${kpi.label}</div>
                        ${changeHtml}
                    </div>
                `;
            }).join('');
        }

        // Render guidance section
        function renderGuidance() {
            if (!analysis.guidance || !analysis.guidance.items || analysis.guidance.items.length === 0) {
                document.getElementById('guidanceSection').style.display = 'none';
                return;
            }

            const guidance = analysis.guidance;
            document.getElementById('guidanceAsOf').textContent = guidance.as_of || '';
            document.getElementById('guidanceFY').textContent = guidance.fiscal_year || '';

            const grid = document.getElementById('guidanceGrid');
            grid.innerHTML = guidance.items.map(item => {
                const vsClass = item.vs_prior ? item.vs_prior.toLowerCase().replace(/ /g, '-') : 'new';
                const vsLabel = item.vs_prior ? item.vs_prior.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : 'New';
                return `
                    <div class="guidance-card">
                        <div class="guidance-metric">${item.metric}</div>
                        <div class="guidance-target">${item.target}</div>
                        <div class="guidance-period">${item.period}</div>
                        <span class="guidance-vs-prior ${vsClass}">${vsLabel}</span>
                        ${item.notes ? `<div class="guidance-notes">${item.notes}</div>` : ''}
                    </div>
                `;
            }).join('');

            const commentary = document.getElementById('guidanceCommentary');
            if (guidance.management_commentary) {
                commentary.textContent = guidance.management_commentary;
                commentary.style.display = 'block';
            } else {
                commentary.style.display = 'none';
            }
        }

        // Chart defaults
        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#e0e0e0', font: { size: 11 } } }
            },
            scales: {
                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        };

        // Color palette
        const colors = {
            primary: '#00d4aa',
            secondary: '#00b894',
            tertiary: '#0984e3',
            quaternary: '#6c5ce7',
            warning: '#fdcb6e',
            danger: '#ff6b6b',
            purple: '#a29bfe',
            orange: '#fab1a0'
        };

        // Create charts
        function createCharts() {
            // Share of EBITDAF
            new Chart(document.getElementById('shareOfEBITDAFChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.Period),
                    datasets: [{
                        label: 'Share of EBITDAF (NZ$M)',
                        data: data.map(d => parseFloat(d.ShareOfEBITDAF) || 0),
                        backgroundColor: colors.primary,
                        borderColor: colors.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartDefaults,
                    plugins: {
                        ...chartDefaults.plugins,
                        title: { display: false }
                    }
                }
            });

            // Net Parent Surplus
            new Chart(document.getElementById('netParentSurplusChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.Period),
                    datasets: [{
                        label: 'Net Parent Surplus (NZ$M)',
                        data: data.map(d => parseFloat(d.NetParentSurplus) || 0),
                        backgroundColor: data.map(d => parseFloat(d.NetParentSurplus) >= 0 ? colors.primary : colors.danger),
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartDefaults,
                    plugins: {
                        ...chartDefaults.plugins,
                        title: { display: false }
                    }
                }
            });

            // Portfolio Composition (FY2025)
            const fy2025 = data.find(d => d.Period === 'FY2025');
            new Chart(document.getElementById('portfolioCompositionChart'), {
                type: 'doughnut',
                data: {
                    labels: ['CDC', 'One NZ', 'Wellington Airport', 'Longroad', 'Qscan', 'RHCNZ', 'Other'],
                    datasets: [{
                        data: [
                            parseFloat(fy2025.CDCContribution) || 0,
                            parseFloat(fy2025.OneNZContribution) || 0,
                            parseFloat(fy2025.WellingtonAirportContribution) || 0,
                            parseFloat(fy2025.LongroadContribution) || 0,
                            parseFloat(fy2025.QscanContribution) || 0,
                            parseFloat(fy2025.RHCNZContribution) || 0,
                            (parseFloat(fy2025.RetireAustraliaContribution) || 0) +
                            (parseFloat(fy2025.ManawaEnergyContribution) || 0)
                        ],
                        backgroundColor: [
                            colors.primary,
                            colors.secondary,
                            colors.tertiary,
                            colors.quaternary,
                            colors.warning,
                            colors.purple,
                            colors.orange
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0', font: { size: 11 } },
                            position: 'right'
                        }
                    }
                }
            });

            // CDC Contribution
            new Chart(document.getElementById('cdcContributionChart'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.Period),
                    datasets: [{
                        label: 'CDC Contribution (NZ$M)',
                        data: data.map(d => parseFloat(d.CDCContribution) || 0),
                        borderColor: colors.primary,
                        backgroundColor: colors.primary + '40',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartDefaults
            });

            // Total Equity / NAV
            new Chart(document.getElementById('totalEquityChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.Period),
                    datasets: [{
                        label: 'Total Equity (NZ$M)',
                        data: data.map(d => parseFloat(d.TotalEquity) || 0),
                        backgroundColor: colors.secondary,
                        borderColor: colors.secondary,
                        borderWidth: 1
                    }]
                },
                options: chartDefaults
            });

            // Net Debt
            new Chart(document.getElementById('netDebtChart'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.Period),
                    datasets: [{
                        label: 'Net Debt (NZ$M)',
                        data: data.map(d => parseFloat(d.NetDebt) || 0),
                        borderColor: colors.warning,
                        backgroundColor: colors.warning + '40',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartDefaults
            });

            // Dividend Per Share
            const dividendData = data.filter(d => d.DividendPerShare && d.DividendPerShare !== '');
            new Chart(document.getElementById('dividendPerShareChart'), {
                type: 'bar',
                data: {
                    labels: dividendData.map(d => d.Period),
                    datasets: [{
                        label: 'Dividend Per Share (NZ$)',
                        data: dividendData.map(d => parseFloat(d.DividendPerShare) || 0),
                        backgroundColor: colors.tertiary,
                        borderColor: colors.tertiary,
                        borderWidth: 1
                    }]
                },
                options: chartDefaults
            });

            // Portfolio Value Growth
            new Chart(document.getElementById('portfolioValueChart'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.Period),
                    datasets: [{
                        label: 'Portfolio Value (NZ$M)',
                        data: data.map(d => parseFloat(d.PortfolioValue) || 0),
                        borderColor: colors.quaternary,
                        backgroundColor: colors.quaternary + '40',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartDefaults
            });
        }

        // Metric descriptions
        const metricDescriptions = {
            shareOfEBITDAF: {
                title: "Share of EBITDAF",
                content: `
                    <p><strong>Share of EBITDAF</strong> is Infratil's proportionate share of EBITDAF (Earnings Before Interest, Tax, Depreciation, Amortization, and Fair Value movements) from its portfolio companies.</p>
                    <div class="metric-highlight">
                        <strong>For Infratil:</strong> This is the key operating performance metric for an infrastructure holding company. Unlike traditional revenue, Share of EBITDAF reflects Infratil's economic interest in the operating cash flow generation of its investments.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Steady growth indicates portfolio companies are generating more operating cash flow</li>
                        <li>CDC and One NZ are the largest contributors (together ~60% of total)</li>
                        <li>Target: 9% like-for-like growth in FY2026</li>
                        <li>Development businesses (Gurin, Galileo, Mint) currently have negative EBITDAF as they invest in early-stage projects</li>
                    </ul>
                `
            },
            netParentSurplus: {
                title: "Net Parent Surplus",
                content: `
                    <p><strong>Net Parent Surplus</strong> is Infratil's bottom-line profit attributable to shareholders after all expenses, revaluations, and taxes.</p>
                    <div class="metric-highlight">
                        <strong>For Infratil:</strong> This metric is highly volatile due to fair value revaluations of portfolio assets. Positive revaluations boost surplus, negative revaluations create losses. FY2025 showed NZ$286M loss despite strong operating performance due to lower asset revaluations.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Don't focus on short-term volatility - revaluations reflect mark-to-market changes, not operating performance</li>
                        <li>Share of EBITDAF is a better indicator of underlying business health</li>
                        <li>Management targets long-term total shareholder return (TSR) of 11-15% p.a., not quarterly profit</li>
                        <li>10-year TSR is 17.0% p.a. despite volatile Net Parent Surplus</li>
                    </ul>
                `
            },
            portfolioComposition: {
                title: "Portfolio Company Contributions",
                content: `
                    <p><strong>Portfolio Composition</strong> shows the relative contribution of each investment to Infratil's total operating performance.</p>
                    <div class="metric-highlight">
                        <strong>For Infratil:</strong> This reveals concentration risk and growth drivers. CDC (41%) and One NZ (20%) dominate the portfolio. Understanding the mix helps assess diversification and future growth trajectory.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>CDC concentration at 41% creates single-asset risk but also drives growth (targeting to double EBITDAF by FY27)</li>
                        <li>Three-pillar strategy: Pillar 1 (cash generators), Pillar 2 (mature growth like CDC/Longroad), Pillar 3 (future growth)</li>
                        <li>NZ$1B divestment program will shift mix toward higher-growth assets</li>
                        <li>Geographic diversification: 65% of portfolio value is offshore (Australia, US, Asia, Europe)</li>
                    </ul>
                `
            },
            cdcContribution: {
                title: "CDC Data Centres Contribution",
                content: `
                    <p><strong>CDC Data Centres</strong> is Infratil's largest investment and key growth driver, operating hyperscale data centres in Australia, New Zealand, and Malaysia.</p>
                    <div class="metric-highlight">
                        <strong>For Infratil:</strong> CDC represents 41% of portfolio value and is benefiting from AI-driven demand. Management announced 140MW of new contracts in October 2025 and is targeting to double FY25 EBITDAF by FY27. This is the primary growth engine.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Contract announcements - CDC announced 140MW in one month (Oct 2025) including 40MW NVIDIA partnership</li>
                        <li>Development pipeline - 1,600MW future capacity, Perth expansion announced (200MW)</li>
                        <li>Valuation multiples - CDC stake increased at 30%+ premium to prior independent valuation in competitive auction</li>
                        <li>AI demand sustainability - DeepSeek model efficiency concerns caused market volatility in early 2025</li>
                    </ul>
                `
            },
            totalEquity: {
                title: "Total Equity / NAV",
                content: `
                    <p><strong>Total Equity</strong> represents the net asset value (NAV) of Infratil's portfolio - the fair value of all investments minus liabilities.</p>
                    <div class="metric-highlight">
                        <strong>For Infratil:</strong> This is the closest proxy to portfolio value for an investment holding company. Growth in Total Equity reflects both operating performance and asset revaluations. Share price typically trades around NAV per share.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Strong equity growth (28.6% CAGR over 3 years) driven by CDC and Longroad revaluations</li>
                        <li>Share price vs NAV per share - historically trades at small discount or premium</li>
                        <li>Capital raises dilute NAV per share but fund growth capex (NZ$1.275B raise in Dec 2024 for CDC)</li>
                        <li>Independent valuations of portfolio companies provide NAV validation</li>
                    </ul>
                `
            },
            netDebt: {
                title: "Net Debt",
                content: `
                    <p><strong>Net Debt</strong> is Infratil's corporate debt minus cash, excluding portfolio company debt.</p>
                    <div class="metric-highlight">
                        <strong>For Infratil:</strong> NZ$2.6B at H1 FY2026. This is parent-level debt used for acquisitions, capital injections, and working capital. Portfolio companies have separate project-level debt. Total look-through debt across all investments is much higher.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Interest rate sensitivity - Higher rates increase debt servicing costs</li>
                        <li>Liquidity - Infratil maintains strong covenant compliance and diversified funding sources</li>
                        <li>Capital deployment - Debt increases when funding growth (CDC injection, Contact stake increase)</li>
                        <li>Divestment program - NZ$1B asset sales will provide proceeds to reduce debt or fund new investments</li>
                    </ul>
                `
            },
            dividendPerShare: {
                title: "Dividend Per Share",
                content: `
                    <p><strong>Dividend Per Share</strong> is the annual cash dividend paid to Infratil shareholders.</p>
                    <div class="metric-highlight">
                        <strong>For Infratil:</strong> Dividends are funded by distributions from portfolio companies (primarily Pillar 1 cash generators). Management targeting operating distributions to cover fixed costs and dividends within 2-3 years as CDC/Longroad build programs complete.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>FY2025 dividend NZ$0.145 per share implies ~1.3% yield at current price</li>
                        <li>Dividend is subordinate to growth investment - Infratil prioritizes capital appreciation over yield</li>
                        <li>One NZ, Wellington Airport, Contact Energy provide stable distributions</li>
                        <li>CDC and Longroad currently reinvesting cash flow into growth capex rather than distributing</li>
                    </ul>
                `
            },
            portfolioValue: {
                title: "Portfolio Value Growth",
                content: `
                    <p><strong>Portfolio Value</strong> tracks the total market value of Infratil's investment portfolio over time.</p>
                    <div class="metric-highlight">
                        <strong>For Infratil:</strong> This measures total asset growth, combining organic portfolio company growth, capital injections, acquisitions, and revaluations. Grown from NZ$6.6B (H1 FY2022) to NZ$19.0B (H1 FY2026), a 188% increase.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Compound annual growth rate (CAGR) over rolling 10-year periods</li>
                        <li>Value creation from Morrison & Co management - historical track record is strong</li>
                        <li>Capital recycling - Selling mature/lower-return assets to fund higher-growth opportunities</li>
                        <li>Share price correlation - Should track NAV per share over time (adjusting for capital raises)</li>
                    </ul>
                `
            }
        };

        // Modal functions
        function openModal(key) {
            document.getElementById('modalTitle').textContent = metricDescriptions[key].title;
            document.getElementById('modalBody').innerHTML = metricDescriptions[key].content;
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(event) {
            if (event && event.target !== document.getElementById('modalOverlay') &&
                event.target !== document.querySelector('.modal-close')) return;
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        // Toggle overview
        function toggleOverview() {
            const btn = document.querySelector('.overview-toggle');
            const content = document.getElementById('overviewContent');
            btn.classList.toggle('active');
            content.classList.toggle('active');
        }

        // DCF Functions
        let currentScenario = 'base';

        function initDCF() {
            if (!dcfData || !dcfData.valuation) return;

            document.getElementById('dcfCurrent').textContent = 'NZ$' + dcfData.current_price.toFixed(2);

            if (dcfData.historical_growth.growth_divergence_warning) {
                document.getElementById('growthWarning').style.display = 'flex';
                document.getElementById('warningText').textContent = dcfData.historical_growth.growth_divergence_warning;
            }

            const base = dcfData.assumptions.base;
            document.getElementById('growthSlider').value = dcfData.assumptions.base.growth_rates[0];
            document.getElementById('waccSlider').value = base.wacc;
            document.getElementById('terminalSlider').value = base.terminal_growth;

            document.getElementById('growthValue').textContent = dcfData.assumptions.base.growth_rates[0] + '%';
            document.getElementById('waccValue').textContent = base.wacc + '%';
            document.getElementById('terminalValue').textContent = base.terminal_growth + '%';

            document.getElementById('growthHint').textContent =
                'Based on ' + dcfData.historical_growth.growth_rate_source.replace(/_/g, ' ');

            renderDCFInputs();
            renderHistoricalGrowth();
            renderSensitivityMatrix();
            updateDCFDisplay();
            switchScenario('base');
        }

        function renderDCFInputs() {
            const inputs = dcfData.inputs;
            const currency = inputs.currency || 'NZD';
            const units = inputs.units === 'millions' ? 'M' : inputs.units === 'billions' ? 'B' : '';

            const formatNum = (n) => {
                if (Math.abs(n) >= 1000) return currency + '$' + (n/1000).toFixed(1) + 'B';
                return currency + '$' + n.toFixed(0) + units;
            };

            document.getElementById('baseFCF').textContent = formatNum(inputs.last_fcf);

            const shares = inputs.shares_outstanding;
            document.getElementById('sharesOut').textContent = shares >= 1000 ? (shares/1000).toFixed(2) + 'B' : shares.toFixed(1) + 'M';

            const netDebt = inputs.net_debt;
            const netDebtEl = document.getElementById('netDebt');
            netDebtEl.textContent = (netDebt < 0 ? '-' : '') + formatNum(Math.abs(netDebt));
            if (netDebt < 0) netDebtEl.style.color = '#00d4aa';

            renderFCFProjections();
        }

        function renderFCFProjections() {
            const startGrowth = parseFloat(document.getElementById('growthSlider')?.value || dcfData.assumptions.base.growth_rates[0]);
            const baseFCF = dcfData.inputs.last_fcf;
            const currency = dcfData.inputs.currency || 'NZD';

            const formatFCF = (n) => {
                if (Math.abs(n) >= 1000) return currency + '$' + (n/1000).toFixed(1) + 'B';
                return currency + '$' + n.toFixed(0) + 'M';
            };

            const endGrowth = 10;
            const growthRates = [];
            for (let i = 0; i < 5; i++) {
                const rate = startGrowth > endGrowth
                    ? startGrowth - (startGrowth - endGrowth) * (i / 4)
                    : startGrowth;
                growthRates.push(rate);
            }

            let fcf = baseFCF;
            const fcfValues = [baseFCF];

            for (let i = 0; i < 5; i++) {
                fcf = fcf * (1 + growthRates[i] / 100);
                fcfValues.push(fcf);
            }

            let html = `
                <div class="fcf-projection-item header">Base</div>
                <div class="fcf-projection-item header">Year 1</div>
                <div class="fcf-projection-item header">Year 2</div>
                <div class="fcf-projection-item header">Year 3</div>
                <div class="fcf-projection-item header">Year 4</div>
                <div class="fcf-projection-item header">Year 5</div>
            `;

            html += `<div class="fcf-projection-item">
                <div class="fcf-value">${formatFCF(fcfValues[0])}</div>
                <div class="growth-rate">-</div>
            </div>`;

            for (let i = 1; i <= 5; i++) {
                html += `<div class="fcf-projection-item">
                    <div class="fcf-value">${formatFCF(fcfValues[i])}</div>
                    <div class="growth-rate">+${growthRates[i-1].toFixed(0)}%</div>
                </div>`;
            }

            document.getElementById('fcfProjectionTable').innerHTML = html;
        }

        function calculateDCF(startGrowth, wacc, terminalGrowth) {
            const years = 5;
            const fcf = dcfData.inputs.last_fcf;
            let pvFCF = 0;
            let projectedFCF = fcf;

            const endGrowth = 10;

            for (let i = 0; i < years; i++) {
                const yearGrowth = startGrowth > endGrowth
                    ? startGrowth - (startGrowth - endGrowth) * (i / 4)
                    : startGrowth;
                projectedFCF *= (1 + yearGrowth / 100);
                pvFCF += projectedFCF / Math.pow(1 + wacc/100, i + 1);
            }

            const terminalFCF = projectedFCF * (1 + terminalGrowth/100);
            const terminalValue = terminalFCF / (wacc/100 - terminalGrowth/100);
            const pvTerminal = terminalValue / Math.pow(1 + wacc/100, years);

            const enterpriseValue = pvFCF + pvTerminal;
            const equityValue = enterpriseValue - dcfData.inputs.net_debt;
            const iv = equityValue / dcfData.inputs.shares_outstanding;

            const terminalPerShare = terminalValue / dcfData.inputs.shares_outstanding;
            const entryPrice = terminalPerShare / Math.pow(1.15, years);

            return {
                iv: iv,
                entryPrice: entryPrice,
                terminalPerShare: terminalPerShare,
                pvFCF: pvFCF,
                pvTerminal: pvTerminal,
                enterpriseValue: enterpriseValue
            };
        }

        window.updateDCFDisplay = function() {
            const growth = parseFloat(document.getElementById('growthSlider').value);
            const wacc = parseFloat(document.getElementById('waccSlider').value);
            const terminal = parseFloat(document.getElementById('terminalSlider').value);

            document.getElementById('growthValue').textContent = growth + '%';
            document.getElementById('waccValue').textContent = wacc + '%';
            document.getElementById('terminalValue').textContent = terminal + '%';

            renderFCFProjections();

            const result = calculateDCF(growth, wacc, terminal);

            document.getElementById('dcfIV').textContent = 'NZ$' + result.iv.toFixed(2);
            document.getElementById('dcfEntry').textContent = 'NZ$' + result.entryPrice.toFixed(2);

            const upside = ((result.iv - dcfData.current_price) / dcfData.current_price * 100);
            const upsideEl = document.getElementById('dcfUpside');
            upsideEl.textContent = (upside >= 0 ? '+' : '') + upside.toFixed(0) + '% ' + (upside >= 0 ? 'upside' : 'downside');
            upsideEl.className = 'dcf-change ' + (upside >= 0 ? 'positive' : 'negative');

            document.getElementById('dcfWeighted').textContent = 'NZ$' + dcfData.probability_weighted.weighted_iv.toFixed(2);

            const grid = document.getElementById('assumptionGrid');
            if (grid) {
                grid.innerHTML = `
                    <div class="assumption-item">
                        <div class="label">Growth Rate</div>
                        <div class="value">${growth}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">WACC</div>
                        <div class="value">${wacc}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Terminal Growth</div>
                        <div class="value">${terminal}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Intrinsic Value</div>
                        <div class="value" style="color: #00d4aa;">NZ$${result.iv.toFixed(2)}</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Entry Price</div>
                        <div class="value" style="color: #00d4aa;">NZ$${result.entryPrice.toFixed(2)}</div>
                    </div>
                `;
            }
        };

        window.switchScenario = function(scenario) {
            currentScenario = scenario;

            document.querySelectorAll('.scenario-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.scenario === scenario);
            });

            const assumptions = dcfData.assumptions[scenario];
            const valuation = dcfData.valuation[scenario];

            document.getElementById('growthSlider').value = assumptions.growth_rates[0];
            document.getElementById('waccSlider').value = assumptions.wacc;
            document.getElementById('terminalSlider').value = assumptions.terminal_growth;

            const grid = document.getElementById('assumptionGrid');
            grid.innerHTML = `
                <div class="assumption-item">
                    <div class="label">Year 1 Growth</div>
                    <div class="value">${assumptions.growth_rates[0]}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Year 5 Growth</div>
                    <div class="value">${assumptions.growth_rates[4]}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">WACC</div>
                    <div class="value">${assumptions.wacc}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Terminal Growth</div>
                    <div class="value">${assumptions.terminal_growth}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Intrinsic Value</div>
                    <div class="value" style="color: #00d4aa;">NZ$${valuation.intrinsic_value.toFixed(2)}</div>
                </div>
            `;

            updateDCFDisplay();
        };

        function renderHistoricalGrowth() {
            const growth = dcfData.historical_growth;
            const selectedSource = growth.growth_rate_source;
            const grid = document.getElementById('growthGrid');

            const metrics = [
                { key: 'revenue_3yr_cagr', label: 'Share of EBITDAF 3Y' },
                { key: 'revenue_5yr_cagr', label: 'Share of EBITDAF 5Y' },
                { key: 'equity_3yr_cagr', label: 'Equity 3Y' },
                { key: 'equity_5yr_cagr', label: 'Equity 5Y' }
            ];

            grid.innerHTML = metrics.map(m => {
                const rate = growth[m.key];
                const isSelected = m.key === selectedSource || (m.key === 'equity_3yr_cagr' && selectedSource === 'equity_3yr_cagr_adjusted');
                const colorClass = rate >= 0 ? 'positive' : 'negative';
                return `
                    <div class="growth-item ${isSelected ? 'selected' : ''}">
                        <div class="metric">${m.label}</div>
                        <div class="rate ${colorClass}">${rate >= 0 ? '+' : ''}${rate.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');
        }

        function renderSensitivityMatrix() {
            const sens = dcfData.sensitivity;
            const table = document.getElementById('sensitivityMatrix');
            const currentPrice = dcfData.current_price;

            let html = '<tr><th>WACC \\ Term G</th>';
            sens.terminal_growth_range.forEach(tg => {
                html += `<th>${tg}%</th>`;
            });
            html += '</tr>';

            sens.wacc_range.forEach((wacc, i) => {
                html += `<tr><th>${wacc}%</th>`;
                sens.matrix[i].forEach((val, j) => {
                    const isHighlight = wacc === dcfData.assumptions.base.wacc &&
                                       sens.terminal_growth_range[j] === dcfData.assumptions.base.terminal_growth;
                    const colorClass = val >= currentPrice ? 'above-current' : 'below-current';
                    html += `<td class="${isHighlight ? 'highlight' : colorClass}">NZ$${val.toFixed(2)}</td>`;
                });
                html += '</tr>';
            });

            table.innerHTML = html;
        }

        // Initialize dashboard
        renderKPIs();
        renderGuidance();
        createCharts();
        initDCF();

        // Bind slider events
        (function() {
            var growthSlider = document.getElementById('growthSlider');
            var waccSlider = document.getElementById('waccSlider');
            var terminalSlider = document.getElementById('terminalSlider');

            if (growthSlider) {
                growthSlider.oninput = window.updateDCFDisplay;
                growthSlider.onchange = window.updateDCFDisplay;
            }
            if (waccSlider) {
                waccSlider.oninput = window.updateDCFDisplay;
                waccSlider.onchange = window.updateDCFDisplay;
            }
            if (terminalSlider) {
                terminalSlider.oninput = window.updateDCFDisplay;
                terminalSlider.onchange = window.updateDCFDisplay;
            }
        })();
    </script>
</body>
</html>