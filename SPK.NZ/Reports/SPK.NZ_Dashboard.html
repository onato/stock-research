<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spark New Zealand (SPK.NZ) Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4aa, #00b894);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .header p {
            color: #888;
            font-size: 1.1rem;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        .kpi-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 170, 0.2);
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00d4aa;
            margin-bottom: 5px;
        }
        .kpi-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .kpi-change {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .kpi-change.positive { color: #00d4aa; }
        .kpi-change.negative { color: #ff6b6b; }

        /* Guidance Section */
        .guidance-section {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        .guidance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .guidance-header h3 {
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .guidance-header h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d4aa, #00b894);
            border-radius: 2px;
        }
        .guidance-meta {
            font-size: 0.85rem;
            color: #888;
        }
        .guidance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .guidance-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
        }
        .guidance-card:hover {
            transform: translateY(-2px);
        }
        .guidance-metric {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .guidance-target {
            font-size: 1.4rem;
            font-weight: 600;
            color: #00d4aa;
            margin-bottom: 6px;
        }
        .guidance-period {
            font-size: 0.85rem;
            color: #e0e0e0;
            margin-bottom: 8px;
        }
        .guidance-vs-prior {
            display: inline-block;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .guidance-vs-prior.raised {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
        }
        .guidance-vs-prior.lowered {
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
        }
        .guidance-vs-prior.maintained {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }
        .guidance-vs-prior.new {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }
        .guidance-notes {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }
        .guidance-commentary {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 16px 20px;
            border-left: 3px solid #00d4aa;
            font-style: italic;
            color: #b0b0b0;
            line-height: 1.6;
        }
        .guidance-commentary::before {
            content: '"';
            font-size: 1.5rem;
            color: #00d4aa;
            margin-right: 4px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #fff;
            margin: 40px auto 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 212, 170, 0.3);
            max-width: 1400px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .chart-header h3 {
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-header h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d4aa, #00b894);
            border-radius: 2px;
        }
        .help-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 212, 170, 0.2);
            border: 1px solid #00d4aa;
            color: #00d4aa;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .help-btn:hover {
            background: #00d4aa;
            color: #1a1a2e;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: linear-gradient(135deg, #1e2a4a 0%, #16213e 100%);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(0, 212, 170, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            color: #00d4aa;
            font-size: 1.4rem;
            margin: 0;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: #ff6b6b;
            color: #fff;
        }
        .modal-body {
            padding: 25px;
            line-height: 1.7;
        }
        .modal-body p { margin-bottom: 15px; }
        .modal-body strong { color: #00d4aa; }
        .modal-body ul { margin: 15px 0; padding-left: 20px; }
        .modal-body li { margin-bottom: 8px; }
        .metric-highlight {
            background: rgba(0, 212, 170, 0.1);
            border-left: 3px solid #00d4aa;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        /* Investment Overview Section */
        .overview-section {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        .overview-toggle {
            width: 100%;
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 12px;
            padding: 16px 24px;
            color: #00d4aa;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        .overview-toggle:hover {
            background: rgba(0, 212, 170, 0.2);
        }
        .overview-toggle .arrow {
            transition: transform 0.3s ease;
        }
        .overview-toggle.active .arrow {
            transform: rotate(180deg);
        }
        .overview-content {
            display: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 30px;
            margin-top: -12px;
        }
        .overview-content.active {
            display: block;
        }
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        .overview-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .overview-card h3 {
            color: #00d4aa;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .overview-card p {
            margin-bottom: 12px;
            line-height: 1.6;
        }
        .overview-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .overview-card li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            line-height: 1.5;
        }
        .overview-card li:last-child {
            border-bottom: none;
        }
        .overview-card.bull h3 { color: #00d4aa; }
        .overview-card.bear h3 { color: #ff6b6b; }
        .overview-card.risks h3 { color: #fdcb6e; }
        .risk-high { color: #ff6b6b; }
        .risk-moderate { color: #fdcb6e; }
        .risk-low { color: #00d4aa; }
        .revenue-stream {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .revenue-stream .percent {
            color: #00d4aa;
            font-weight: 600;
        }
        .trend-growing { color: #00d4aa; }
        .trend-stable { color: #888; }
        .trend-declining { color: #ff6b6b; }

        /* DCF Valuation Section */
        .dcf-section {
            max-width: 1400px;
            margin: 0 auto 40px;
        }
        .dcf-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dcf-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        .dcf-card:hover {
            transform: translateY(-3px);
        }
        .dcf-card.highlight {
            background: rgba(0, 212, 170, 0.1);
            border-color: rgba(0, 212, 170, 0.3);
        }
        .dcf-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .dcf-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #00d4aa;
        }
        .dcf-card:not(.highlight) .dcf-value {
            color: #fff;
        }
        .dcf-change {
            font-size: 1rem;
            margin-top: 8px;
            font-weight: 600;
        }
        .dcf-change.positive { color: #00d4aa; }
        .dcf-change.negative { color: #ff6b6b; }
        .dcf-sublabel {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
        }
        .dcf-warning {
            background: rgba(253, 203, 110, 0.15);
            border: 1px solid rgba(253, 203, 110, 0.4);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fdcb6e;
        }
        .warning-icon {
            font-size: 1.2rem;
        }

        /* DCF Inputs Display */
        .dcf-inputs {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .dcf-inputs h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .dcf-inputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .dcf-input-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .dcf-input-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .dcf-input-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #00d4aa;
        }
        .dcf-input-note {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }
        .fcf-projections h5 {
            color: #b0b0b0;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .fcf-projection-table {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px;
        }
        .fcf-projection-item {
            text-align: center;
        }
        .fcf-projection-item.header {
            font-size: 0.75rem;
            color: #888;
            font-weight: 600;
        }
        .fcf-projection-item .year {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 2px;
        }
        .fcf-projection-item .fcf-value {
            font-size: 1rem;
            color: #e0e0e0;
            font-weight: 500;
        }
        .fcf-projection-item .growth-rate {
            font-size: 0.75rem;
            color: #00d4aa;
            margin-top: 2px;
        }

        .dcf-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .slider-group label {
            font-size: 0.95rem;
            color: #e0e0e0;
            display: flex;
            justify-content: space-between;
        }
        .slider-group label span {
            color: #00d4aa;
            font-weight: 600;
        }
        .slider-group input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00d4aa;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00d4aa;
            cursor: pointer;
            border: none;
        }
        .slider-hint {
            font-size: 0.8rem;
            color: #666;
        }
        .scenario-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .scenario-tab {
            padding: 10px 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .scenario-tab:hover {
            border-color: rgba(0, 212, 170, 0.5);
            color: #e0e0e0;
        }
        .scenario-tab.active {
            background: rgba(0, 212, 170, 0.15);
            border-color: #00d4aa;
            color: #00d4aa;
        }
        .scenario-details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .scenario-details h4 {
            color: #00d4aa;
            margin-bottom: 15px;
        }
        .assumption-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .assumption-item {
            text-align: center;
        }
        .assumption-item .label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 4px;
        }
        .assumption-item .value {
            font-size: 1.1rem;
            color: #e0e0e0;
            font-weight: 500;
        }
        .sensitivity-section {
            margin-bottom: 30px;
        }
        .sensitivity-section h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        .sensitivity-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
        }
        .sensitivity-table th,
        .sensitivity-table td {
            padding: 12px 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .sensitivity-table th {
            background: rgba(0, 212, 170, 0.1);
            color: #00d4aa;
            font-weight: 600;
        }
        .sensitivity-table td {
            color: #e0e0e0;
        }
        .sensitivity-table td.highlight {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
            font-weight: 600;
        }
        .sensitivity-table td.below-current {
            color: #ff6b6b;
        }
        .sensitivity-table td.above-current {
            color: #00d4aa;
        }
        .historical-growth {
            margin-bottom: 30px;
        }
        .historical-growth h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        .growth-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        .growth-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .growth-item .metric {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 6px;
        }
        .growth-item .rate {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .growth-item .rate.positive { color: #00d4aa; }
        .growth-item .rate.negative { color: #ff6b6b; }
        .growth-item.selected {
            border-color: #00d4aa;
            background: rgba(0, 212, 170, 0.1);
        }
        .dcf-download {
            text-align: center;
            margin-top: 30px;
        }
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            background: rgba(0, 212, 170, 0.15);
            border: 1px solid #00d4aa;
            border-radius: 8px;
            color: #00d4aa;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        .download-btn:hover {
            background: #00d4aa;
            color: #1a1a2e;
        }
        .download-icon {
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .charts-container { grid-template-columns: 1fr; }
            .overview-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Spark New Zealand (SPK.NZ)</h1>
        <p>New Zealand's Largest Telecommunications Provider | All figures in NZ$ millions unless stated</p>
    </div>

    <!-- Investment Overview Section -->
    <div class="overview-section">
        <button class="overview-toggle" onclick="toggleOverview()">
            <span>Investment Overview & Analysis</span>
            <span class="arrow">▼</span>
        </button>
        <div class="overview-content" id="overviewContent">
            <div class="overview-grid">
                <!-- Company Overview -->
                <div class="overview-card">
                    <h3>Company Overview</h3>
                    <p>Spark New Zealand is New Zealand's largest telecommunications company, providing mobile, broadband, cloud, digital services, and data centre infrastructure to consumers, SMEs, and enterprise/government customers across New Zealand. The company operates New Zealand's most reliable mobile network with 42% market share, serving 2.6 million mobile connections and 660,000 broadband connections, and is refocusing on its core connectivity business following a challenging FY25.</p>
                </div>

                <!-- Business Model -->
                <div class="overview-card">
                    <h3>Business Model</h3>
                    <p>Connectivity-focused revenue model with mobile (40% of revenue) and broadband driving 80% of gross margins, complemented by IT services, cloud solutions, and a growing data centre business that was 75% divested to Pacific Equity Partners in August 2025.</p>
                    <ul>
                        <li class="revenue-stream"><span>Mobile</span><span class="percent trend-declining">40% (declining)</span></li>
                        <li class="revenue-stream"><span>Other connectivity</span><span class="percent trend-stable">25% (mixed)</span></li>
                        <li class="revenue-stream"><span>Cloud and IT services</span><span class="percent trend-declining">15% (declining)</span></li>
                        <li class="revenue-stream"><span>Procurement and partners</span><span class="percent trend-stable">15% (stable)</span></li>
                        <li class="revenue-stream"><span>Data centres</span><span class="percent trend-growing">5% (growing)</span></li>
                    </ul>
                </div>

                <!-- Competitive Position -->
                <div class="overview-card">
                    <h3>Competitive Position</h3>
                    <p><strong>Market Position:</strong> #1 in mobile with 42% market share, #1 in broadband, market leader in enterprise/government</p>
                    <p><strong>Key Competitors:</strong> One NZ (formerly Vodafone NZ), 2degrees, MVNOs</p>
                    <p><strong>Competitive Advantages:</strong></p>
                    <ul>
                        <li><strong>Network quality:</strong> Named most reliable mobile network, 99% 4G coverage, 50%+ 5G coverage</li>
                        <li><strong>Scale:</strong> Largest infrastructure (2,262 mobile sites) enabling better unit economics</li>
                        <li><strong>Brand:</strong> Most trusted brand in NZ telco sector</li>
                        <li><strong>Incumbent position:</strong> Largest customer base creates switching costs</li>
                    </ul>
                    <p><strong>Weaknesses:</strong></p>
                    <ul>
                        <li>Small domestic market limits growth opportunities</li>
                        <li>Market saturation in core mobile and broadband</li>
                        <li>1,300 FTE reduction causing organizational disruption</li>
                    </ul>
                </div>

                <!-- Growth Drivers -->
                <div class="overview-card">
                    <h3>Growth Drivers</h3>
                    <ul>
                        <li>5G network expansion and monetization (50% population coverage)</li>
                        <li>IoT business growing rapidly (2.37M+ devices, +16% YoY)</li>
                        <li>Data centre expansion (22MW operational, 118MW+ pipeline) with PEP partnership</li>
                        <li>AI and automation driving efficiency and new services</li>
                        <li>Cost reduction program delivering $110-140M savings by FY27</li>
                        <li>NZ economic recovery expected to improve demand</li>
                    </ul>
                </div>

                <!-- Key Risks -->
                <div class="overview-card risks">
                    <h3>Key Risks</h3>
                    <ul>
                        <li><span class="risk-high">High:</span> Mobile market saturation and intense price competition</li>
                        <li><span class="risk-high">High:</span> Enterprise and Government revenue decline (IT services -7.7%)</li>
                        <li><span class="risk-high">High:</span> Declining profitability (NPAT -33.6% in FY25)</li>
                        <li><span class="risk-high">High:</span> NZ economic weakness (economy contracted 2024)</li>
                        <li><span class="risk-high">High:</span> Organizational capability loss (1,300 FTE cut, engagement 67%→50%)</li>
                        <li><span class="risk-moderate">Moderate:</span> Technology transition execution risk (Nokia, Infosys partnerships)</li>
                        <li><span class="risk-moderate">Moderate:</span> Leverage at 2.3x net debt/EBITDAI</li>
                        <li><span class="risk-moderate">Moderate:</span> Regulatory review underway (6-9 month telecom review)</li>
                    </ul>
                </div>

                <!-- Bull Case -->
                <div class="overview-card bull">
                    <h3>Bull Case</h3>
                    <ul>
                        <li>Market leader (#1 mobile 42% share) with best network quality provides pricing power</li>
                        <li>Cost reduction delivering $110-140M savings, $85M already achieved in H2 FY25</li>
                        <li>Data centre sale to PEP unlocks $705M value while retaining 25% upside</li>
                        <li>NZ economic recovery (RBNZ cutting to 2.25%) should boost demand</li>
                        <li>AI and automation leadership driving efficiency and new revenue</li>
                        <li>IoT growing rapidly (2.37M devices, +16% connections)</li>
                        <li>Asset-light model post-sale improves ROIC (8.7% vs cost of capital)</li>
                        <li>Attractive dividend yield with new transparent FCF-based policy</li>
                    </ul>
                </div>

                <!-- Bear Case -->
                <div class="overview-card bear">
                    <h3>Bear Case</h3>
                    <ul>
                        <li>Core mobile revenue declining (down 2.3% FY25) with no clear growth path</li>
                        <li>Profitability collapse: NPAT -33.6%, EBITDAI -8.9% in FY25</li>
                        <li>Massive disruption (1,300 FTE, engagement 67%→50%) creates execution risk</li>
                        <li>Technology outsourcing to Nokia/Infosys introduces dependency and quality risks</li>
                        <li>Small NZ market (~5M population) limits growth, no geographic diversification</li>
                        <li>Dividend cut with new policy potentially delivering less (~15-17c vs prior 25c)</li>
                        <li>Enterprise/Government structural decline (IT -7.7%, networks -9.9%)</li>
                        <li>Balance sheet stretched at 2.3x leverage despite asset sales</li>
                        <li>Regulatory uncertainty with government telecom review</li>
                    </ul>
                </div>

                <!-- Recent Developments -->
                <div class="overview-card">
                    <h3>Recent Developments</h3>
                    <ul>
                        <li><strong>Aug 2025:</strong> Sold 75% data centre stake to PEP for up to NZ$705M (30.8x EBITDA)</li>
                        <li><strong>Aug 2025:</strong> Launched SPK-30 strategy refocusing on core connectivity</li>
                        <li><strong>Aug 2025:</strong> New dividend policy tied to FCF (70-100% payout)</li>
                        <li><strong>Jul 2025:</strong> Sold 10% HTAL stake for NZ$47M</li>
                        <li><strong>Q3 2025:</strong> Sold 17% Connexa stake to CDPQ for NZ$309M</li>
                        <li><strong>Feb 2025:</strong> Reduced workforce by ~1,300 FTE</li>
                        <li><strong>Q4 2024:</strong> Mobile market share stabilized after earlier declines</li>
                        <li><strong>Q4 2024:</strong> Announced partnerships with Nokia (network), Infosys/HPE (IT), Microsoft (cloud)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid" id="kpiGrid">
        <!-- Populated by JavaScript -->
    </div>

    <!-- Management Guidance Section -->
    <div class="guidance-section" id="guidanceSection">
        <div class="guidance-header">
            <h3>Management Guidance</h3>
            <span class="guidance-meta">As of <span id="guidanceAsOf">FY25 Results - August 2025</span> | <span id="guidanceFY">FY2026</span></span>
        </div>
        <div class="guidance-grid" id="guidanceGrid">
            <!-- Populated by JavaScript -->
        </div>
        <div class="guidance-commentary" id="guidanceCommentary">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Charts -->
    <h2 class="section-title">Financial Performance</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Revenue Trend</h3>
                <button class="help-btn" onclick="openModal('revenue')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>EBITDA & Net Income</h3>
                <button class="help-btn" onclick="openModal('profitability')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="profitabilityChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Net Margin %</h3>
                <button class="help-btn" onclick="openModal('margins')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="marginsChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>EPS Trend</h3>
                <button class="help-btn" onclick="openModal('eps')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="epsChart"></canvas>
            </div>
        </div>
    </div>

    <h2 class="section-title">Cash Flow & Capital Allocation</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Free Cash Flow</h3>
                <button class="help-btn" onclick="openModal('fcf')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="fcfChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Capital Expenditure</h3>
                <button class="help-btn" onclick="openModal('capex')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="capexChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Dividends Per Share (NZ cents)</h3>
                <button class="help-btn" onclick="openModal('dividends')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="dividendsChart"></canvas>
            </div>
        </div>
    </div>

    <h2 class="section-title">Telecom KPIs</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Mobile & Broadband Connections</h3>
                <button class="help-btn" onclick="openModal('connections')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="connectionsChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>IoT Connections Growth</h3>
                <button class="help-btn" onclick="openModal('iot')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="iotChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Mobile vs Broadband Revenue</h3>
                <button class="help-btn" onclick="openModal('revenueMix')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="revenueMixChart"></canvas>
            </div>
        </div>
    </div>

    <h2 class="section-title">Balance Sheet</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Total Debt vs Cash</h3>
                <button class="help-btn" onclick="openModal('debt')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="debtChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Shareholders' Equity</h3>
                <button class="help-btn" onclick="openModal('equity')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="equityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- DCF Valuation Section -->
    <h2 class="section-title">DCF Valuation</h2>
    <div class="dcf-section">
        <!-- Valuation Summary Cards -->
        <div class="dcf-summary">
            <div class="dcf-card highlight">
                <div class="dcf-label">Intrinsic Value</div>
                <div class="dcf-value" id="dcfIV">NZ$1.57</div>
                <div class="dcf-change negative" id="dcfUpside">-30% downside</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Entry Price (15% CAGR)</div>
                <div class="dcf-value" id="dcfEntry">NZ$1.37</div>
                <div class="dcf-sublabel">Buy below for 15% annual return</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Current Price</div>
                <div class="dcf-value" id="dcfCurrent">NZ$2.24</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Prob-Weighted IV</div>
                <div class="dcf-value" id="dcfWeighted">NZ$1.51</div>
                <div class="dcf-sublabel">20% Bull / 50% Base / 30% Bear</div>
            </div>
        </div>

        <!-- Growth Rate Warning -->
        <div class="dcf-warning" id="growthWarning" style="display: flex;">
            <span class="warning-icon">&#9888;</span>
            <span id="warningText">Significant divergence: EPS declining sharply (-9.5% 5yr CAGR) while equity barely positive (+0.9%). Reflects margin compression during SPK-30 transformation.</span>
        </div>

        <!-- DCF Inputs Display -->
        <div class="dcf-inputs">
            <h4>DCF Model Inputs</h4>
            <div class="dcf-inputs-grid">
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Base Year FCF</div>
                    <div class="dcf-input-value" id="baseFCF">NZ$330M</div>
                    <div class="dcf-input-note">Starting point for projections</div>
                </div>
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Shares Outstanding</div>
                    <div class="dcf-input-value" id="sharesOut">1.82B</div>
                </div>
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Net Debt</div>
                    <div class="dcf-input-value" id="netDebt">NZ$1,730M</div>
                    <div class="dcf-input-note">Positive = net debt</div>
                </div>
            </div>
            <div class="fcf-projections">
                <h5>Projected FCF (5-Year)</h5>
                <div class="fcf-projection-table" id="fcfProjectionTable">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Interactive Sliders -->
        <div class="dcf-controls">
            <div class="slider-group">
                <label>Growth Rate: <span id="growthValue">0.9%</span></label>
                <input type="range" id="growthSlider" min="-5" max="15" value="0.9" step="0.1">
                <div class="slider-hint" id="growthHint">Based on equity 5yr CAGR</div>
            </div>
            <div class="slider-group">
                <label>WACC: <span id="waccValue">9.0%</span></label>
                <input type="range" id="waccSlider" min="6" max="12" value="9.0" step="0.5">
            </div>
            <div class="slider-group">
                <label>Terminal Growth: <span id="terminalValue">2.0%</span></label>
                <input type="range" id="terminalSlider" min="0" max="5" value="2.0" step="0.5">
            </div>
        </div>

        <!-- Scenario Tabs -->
        <div class="scenario-tabs">
            <button class="scenario-tab active" data-scenario="base" onclick="switchScenario('base')">Base Case</button>
            <button class="scenario-tab" data-scenario="bull" onclick="switchScenario('bull')">Bull Case</button>
            <button class="scenario-tab" data-scenario="bear" onclick="switchScenario('bear')">Bear Case</button>
        </div>

        <!-- Scenario Details -->
        <div class="scenario-details" id="scenarioDetails">
            <div class="scenario-assumptions">
                <h4>Assumptions</h4>
                <div class="assumption-grid" id="assumptionGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Sensitivity Table -->
        <div class="sensitivity-section">
            <h4>Sensitivity Analysis: Intrinsic Value by WACC & Terminal Growth</h4>
            <table class="sensitivity-table" id="sensitivityMatrix">
                <!-- Populated by JavaScript -->
            </table>
        </div>

        <!-- Historical Growth Rates -->
        <div class="historical-growth">
            <h4>Historical Growth Rates (CAGR)</h4>
            <div class="growth-grid" id="growthGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // EMBEDDED CSV DATA
        const csvData = `Period,Revenue,GrossProfit,GrossMargin,EBITDA,OperatingIncome,OperatingMargin,NetIncome,NetMargin,EPS,FreeCashFlow,OperatingCashFlow,CapEx,DividendsPaid,ShareholdersEquity,TotalDebt,CashAndEquivalents,TotalAssets,TotalLiabilities,SharesOutstanding,DividendsPerShare,MobileServiceRevenue,BroadbandRevenue,MobileConnections,BroadbandConnections,IoTConnections
FY2019,3718.0,,,1151.0,,,410.0,11.0,21.6,433.0,,410.0,467.0,1465.0,1347.0,46.0,4095.0,2630.0,1870.0,25.0,899.0,639.0,2366.0,702.0,
FY2020,3744.0,,,1043.0,,,381.0,10.2,20.4,382.0,,515.0,467.0,1420.0,1316.0,15.0,4276.0,2856.0,1870.0,25.0,920.0,627.0,2485.0,702.0,
FY2021,3722.0,,,1050.0,,,418.0,11.2,22.3,433.0,,515.0,467.0,1437.0,1303.0,5.0,4195.0,2758.0,1870.0,25.0,930.0,639.0,2514.0,702.0,
H1 2022,1890.0,,,538.0,,,179.0,,9.6,183.0,,218.0,,1493.0,1313.0,12.0,4347.0,2854.0,1870.0,12.5,441.0,324.0,2615.0,702.0,623.0
FY2022,3718.0,,,1150.0,,,410.0,11.0,21.9,433.0,,410.0,467.0,1493.0,1313.0,15.0,4347.0,2854.0,1873.0,25.0,900.0,639.0,2690.0,702.0,1200.0
H1 2023,1950.0,,,510.0,,,165.0,,8.8,115.0,,250.0,,2061.0,810.0,190.0,4566.0,2505.0,1873.0,13.5,480.0,313.0,2693.0,702.0,1460.0
FY2023,3908.0,,,1193.0,,,433.0,11.1,23.2,489.0,,515.0,506.0,2061.0,1049.0,24.0,4566.0,2505.0,1873.0,27.0,980.0,626.0,2714.0,702.0,1800.0
H1 2024,1976.0,,,530.0,,,157.0,,8.4,46.0,,286.0,,1475.0,1564.0,23.0,4189.0,2714.0,1873.0,13.5,510.0,309.0,2688.0,702.0,1800.0
FY2024,3861.0,,,1163.0,,,342.0,8.9,18.7,330.0,,518.0,506.0,1475.0,1638.0,19.0,4189.0,2714.0,1873.0,27.5,1010.0,613.0,2690.0,702.0,2050.0
H1 2025,1939.0,,,448.0,,,56.0,,3.1,77.0,,252.0,,1485.0,1799.0,61.0,4293.0,2808.0,1820.0,12.5,491.0,302.0,2629.0,673.0,2200.0
FY2025,3700.0,,,1060.0,,,227.0,6.1,12.4,330.0,,429.0,458.0,1485.0,1795.0,65.0,4293.0,2808.0,1820.0,25.0,987.0,608.0,2629.0,673.0,2380.0`;

        // EMBEDDED ANALYSIS DATA
        const analysis = {
  "ticker": "SPK.NZ",
  "company_name": "Spark New Zealand Limited",
  "analysis_date": "2026-02-03",
  "overview": "Spark New Zealand is New Zealand's largest telecommunications company, providing mobile, broadband, cloud, digital services, and data centre infrastructure to consumers, SMEs, and enterprise/government customers across New Zealand. The company operates New Zealand's most reliable mobile network with 42% market share, serving 2.6 million mobile connections and 660,000 broadband connections, and is refocusing on its core connectivity business following a challenging FY25.",
  "business_model": {
    "summary": "Connectivity-focused revenue model with mobile (40% of revenue) and broadband driving 80% of gross margins, complemented by IT services, cloud solutions, and a growing data centre business that was 75% divested to Pacific Equity Partners in August 2025.",
    "revenue_streams": [
      {"name": "Mobile", "percent": 40, "trend": "declining"},
      {"name": "Other connectivity (broadband, managed networks, collaboration, IoT, voice)", "percent": 25, "trend": "mixed"},
      {"name": "Cloud and IT services", "percent": 15, "trend": "declining"},
      {"name": "Procurement and partners", "percent": 15, "trend": "stable"},
      {"name": "Data centres", "percent": 5, "trend": "growing"}
    ],
    "customer_type": "B2C (consumer, SME) and B2B (enterprise, government)",
    "geographic_mix": "100% New Zealand domestic market"
  },
  "competitive_position": {
    "main_competitors": ["One NZ (formerly Vodafone NZ)", "2degrees", "MVNOs"],
    "market_position": "#1 in mobile with 42% market share, #1 in broadband, market leader in enterprise/government",
    "moat_factors": [
      {"factor": "Network quality and coverage", "strength": "strong", "description": "Named most reliable mobile network with widest coverage by Opensignal (Sept 2024), 99% 4G coverage, 50%+ 5G population coverage"},
      {"factor": "Scale advantages", "strength": "strong", "description": "Largest player with significant infrastructure investment (2,262 mobile sites), enabling better unit economics"},
      {"factor": "Brand trust", "strength": "moderate", "description": "Most trusted brand in NZ telco sector (TRA Brand Monitor)"},
      {"factor": "Incumbent position", "strength": "moderate", "description": "Largest customer base creates switching costs and data advantages"}
    ],
    "weaknesses": [
      "Small domestic market limits growth opportunities",
      "Market saturation in core mobile and broadband",
      "Significant organizational disruption from restructuring (1,300 FTE reduction)",
      "Enterprise/Government segment facing structural headwinds from workforce reductions"
    ]
  },
  "growth_drivers": [
    "5G network expansion and monetization (now covering 50% of population)",
    "IoT business growing rapidly (2.37M+ devices, up 16% connections YoY)",
    "Data centre capacity expansion (22MW operational, 118MW+ development pipeline) with PEP partnership providing funding",
    "AI and automation driving operational efficiency and new service offerings",
    "Cost reduction program delivering $110-140M annualised savings by FY27",
    "Economic recovery in NZ expected to improve enterprise spending and consumer demand"
  ],
  "risks": {
    "business": [
      {"risk": "Mobile market saturation and intense price competition", "severity": "high", "description": "Pay monthly ARPU down 0.6% in FY25, prepaid connections declined 5.2%, aggressive pricing in enterprise segment driving 13.9% ARPU decline"},
      {"risk": "Enterprise and Government revenue decline", "severity": "high", "description": "IT services down 7.7%, managed networks down 9.9%, workforce reductions reducing mobile fleet demand"},
      {"risk": "Technology transition execution risk", "severity": "moderate", "description": "New partnership model with Nokia, Infosys, HPE, Microsoft introduces operational dependencies and integration challenges"},
      {"risk": "Customer concentration in small NZ market", "severity": "moderate", "description": "Limited geographic diversification, exposed to NZ-specific economic cycles"}
    ],
    "financial": [
      {"risk": "Declining profitability", "severity": "high", "description": "Adjusted EBITDAI down 8.9% to $1,060M, adjusted NPAT down 33.6% to $227M in FY25"},
      {"risk": "Leverage concerns", "severity": "moderate", "description": "Net debt to EBITDAI at 2.3x as of Dec 2024, though improving with asset sales"},
      {"risk": "Dividend sustainability", "severity": "moderate", "description": "New policy ties dividend to FCF (70-100% payout), FCF guidance of $290-330M for FY26 lower than historical levels"}
    ],
    "regulatory": [
      {"risk": "Telecommunications sector regulatory review", "severity": "moderate", "description": "NZ government commenced 6-9 month regulatory review in June 2025 examining if current regime remains fit for purpose"},
      {"risk": "Fibre regulation changes", "severity": "moderate", "description": "Commerce Commission reviewing Fibre Input Methodologies including cost of capital and investment rules"},
      {"risk": "Network sharing obligations", "severity": "low", "description": "Ongoing regulatory requirements for wholesale access and emergency services"}
    ],
    "macro": [
      {"risk": "NZ economic weakness", "severity": "high", "description": "Economy contracted in 2024, unemployment expected to peak at 5.5% in Dec 2025/Mar 2026, weak business investment"},
      {"risk": "Interest rate sensitivity", "severity": "moderate", "description": "Consumer spending pressures from high rates (though RBNZ cutting aggressively to 2.25% by Nov 2025)"},
      {"risk": "Inflation in supplier costs", "severity": "moderate", "description": "Network equipment, energy costs, and vendor price increases pressuring margins"}
    ],
    "execution": [
      {"risk": "Organizational capability loss", "severity": "high", "description": "1,300 FTE reduction (24% workforce cut), employee engagement dropped from 67% to 50%, risk of talent loss and execution gaps"},
      {"risk": "Technology partner dependency", "severity": "moderate", "description": "Outsourcing network operations to Nokia and IT to Infosys/HPE creates dependency risks and potential service quality issues"},
      {"risk": "Cultural disruption", "severity": "moderate", "description": "Massive change program impacting morale, integration of offshore delivery models"}
    ]
  },
  "macro_factors": {
    "industry_outlook": "NZ telecom market mature with limited growth (1.2% mobile market growth in FY25), but stabilizing in H2. Total telecom revenue expected to grow at 1.6% CAGR 2024-2029 driven by mobile data and fixed broadband. Data centre demand accelerating due to cloud adoption and AI.",
    "cyclicality": "Moderate - Consumer segment relatively defensive but enterprise/government highly sensitive to economic conditions and business investment cycles",
    "interest_rate_sensitivity": "Moderate direct (through consumer spending and business investment), but improving as RBNZ cut OCR from peak 5.5% to 2.25% by Nov 2025 with further cuts expected",
    "key_input_costs": ["Network equipment (Nokia, Ericsson)", "Energy (electricity for network and data centres)", "Property/tower rentals", "International capacity and transit", "Labor costs"]
  },
  "recent_developments": [
    {"date": "2025-Aug", "event": "Announced sale of 75% of data centre business to Pacific Equity Partners for up to NZ$705M, retaining 25% stake. Transaction valued business at 30.8x FY25 EBITDA."},
    {"date": "2025-Aug", "event": "Launched new SPK-30 five-year strategy refocusing on core connectivity, moving away from broader digital services ambition"},
    {"date": "2025-Aug", "event": "Announced revised Capital Management Framework with dividend tied to free cash flow (70-100% payout), FY26 dividend guidance at 100% of FCF"},
    {"date": "2025-Jul", "event": "Completed sale of 10% HTAL stake for NZ$47M"},
    {"date": "2025-Q3", "event": "Completed sale of remaining 17% Connexa (tower company) stake to CDPQ for NZ$309M net"},
    {"date": "2025-Feb", "event": "Reduced workforce by ~1,300 FTE as part of transformation program"},
    {"date": "2025-Jan", "event": "Partnered with Genesis Energy on 10-year renewable energy deal via Lauriston Solar Farm"},
    {"date": "2024-Dec", "event": "Moved Auckland HQ to 50 Albert Street (6-Green Star rated)"},
    {"date": "2024-Q4", "event": "Mobile market share stabilized in Q4 FY25 after earlier declines"},
    {"date": "2024-Q4", "event": "Announced strategic partnerships with Nokia (network), Infosys (IT), HPE (IT infrastructure), Microsoft (cloud)"}
  ],
  "guidance": {
    "as_of": "FY25 Results - August 2025",
    "fiscal_year": "FY2026 (ending June 30, 2026)",
    "items": [
      {
        "metric": "Free Cash Flow",
        "target": "NZ$290-330M",
        "period": "FY2026",
        "vs_prior": "new",
        "notes": "New FCF definition includes working capital changes and core business capex. Excludes spectrum and strategic investments (e.g., data centres). FY25 FCF was $330M on comparable basis."
      },
      {
        "metric": "Dividend payout ratio",
        "target": "100% of FCF",
        "period": "FY2026",
        "vs_prior": "new",
        "notes": "Changed from prior fixed cents per share approach. New policy targets 70-100% of FCF to provide flexibility."
      },
      {
        "metric": "Cost reduction (annualized benefits)",
        "target": "NZ$110-140M by end FY27",
        "period": "FY2026-FY2027",
        "vs_prior": "raised",
        "notes": "Expanded SPK-26 Operate Programme. Delivered $85M reduction in H2 FY25 vs H2 FY24. FY26 targeting $30-50M net labour cost reduction."
      },
      {
        "metric": "Capital expenditure",
        "target": "10-12% of revenue (long-run target)",
        "period": "Long-term",
        "vs_prior": "maintained",
        "notes": "FY25 capex was $429M (11.6% of revenue), down 17.2% YoY. Excludes spectrum and strategic capex (e.g., data centres)."
      }
    ],
    "management_commentary": "CEO Jolie Hodson emphasized transformation progress with cost base reset, portfolio simplification, and renewed focus on core connectivity. Chair Justine Smyth noted new SPK-30 strategy aims to deliver 'stable annuity-like returns' with sustainable FCF funding growing dividend over time. Management acknowledged performance below expectations but highlighted stabilizing trends in Q4 FY25 and momentum building into FY26."
  },
  "bull_case": [
    "Market leader position (#1 mobile 42% share, #1 broadband) with best network quality provides pricing power as market stabilizes",
    "Cost reduction program delivering $110-140M annualised savings by FY27, with $85M already achieved in H2 FY25, significantly improving margins",
    "Data centre business partnership with PEP unlocks value ($705M valuation) while retaining 25% upside in high-growth segment (118MW+ development pipeline)",
    "NZ economic recovery underway with RBNZ cutting rates aggressively (now 2.25%), unemployment peaking Q1 2026, should drive enterprise spending and consumer demand recovery",
    "AI and automation leadership in NZ market driving operational efficiency and new revenue opportunities (SparkGPT, network automation, customer service AI)",
    "IoT business growing rapidly (2.37M devices, +16% connections) provides new growth vector beyond saturated mobile/broadband",
    "Asset-light model post data centre sale and strategic partnerships (Nokia, Infosys, HPE) improves capital efficiency and ROIC (8.7% in FY25 vs cost of capital)",
    "Attractive dividend yield with new policy providing transparency (100% FCF payout FY26), supported by improved cash generation"
  ],
  "bear_case": [
    "Core mobile revenue declining (down 2.3% FY25) with structural pressure from competition, saturation, and enterprise workforce reductions - no clear path to revenue growth",
    "Profitability collapse with adjusted NPAT down 33.6% in FY25 and EBITDAI down 8.9%, reflecting structural margin pressure beyond cyclical factors",
    "Massive organizational disruption (1,300 FTE cut, engagement plummeted 67% to 50%) creates execution risk and potential service quality degradation",
    "Technology outsourcing to Nokia/Infosys/HPE introduces dependency risks and potential loss of competitive differentiation in core network operations",
    "Small NZ domestic market (~5M population) provides limited growth runway and no geographic diversification to offset local weakness",
    "Dividend cut from prior 25 cents per share with new policy potentially delivering less (70-100% of $290-330M FCF = ~15.4-17.5 cents per 1.89B shares)",
    "Enterprise and Government segment facing structural decline (IT services -7.7%, managed networks -9.9%) as customers shift to cloud/offshore providers",
    "Balance sheet stretched at 2.3x net debt/EBITDAI despite asset sales, limiting financial flexibility for growth investments or M&A",
    "Regulatory uncertainty with government review of telecom sector and Commerce Commission fibre regulation changes potentially impacting economics"
  ]
};

        // EMBEDDED DCF DATA
        const dcfData = {
  "ticker": "SPK.NZ",
  "valuation_date": "2026-02-03",
  "current_price": 2.24,

  "inputs": {
    "shares_outstanding": 1820,
    "net_debt": 1730,
    "last_fcf": 330,
    "currency": "NZ$",
    "units": "millions"
  },

  "historical_growth": {
    "revenue_3yr_cagr": -1.8,
    "revenue_5yr_cagr": -0.2,
    "eps_3yr_cagr": -16.4,
    "eps_5yr_cagr": -9.5,
    "equity_3yr_cagr": -3.6,
    "equity_5yr_cagr": 0.9,
    "fcf_3yr_cagr": -2.9,
    "fcf_5yr_cagr": -2.9,
    "selected_growth_rate": 0.9,
    "growth_rate_source": "equity_5yr_cagr",
    "growth_divergence_warning": "Significant divergence: EPS declining sharply (-9.5% 5yr CAGR) while equity barely positive (+0.9%). Reflects margin compression during SPK-30 transformation."
  },

  "assumptions": {
    "base": {
      "growth_rates": [2, 1, 1, 0, 0],
      "fcf_margin": 8.9,
      "wacc": 9.0,
      "terminal_growth": 2.0
    },
    "bull": {
      "growth_rates": [5, 4, 3, 2, 2],
      "fcf_margin": 10.0,
      "wacc": 8.5,
      "terminal_growth": 2.5
    },
    "bear": {
      "growth_rates": [-3, -3, -2, -1, -1],
      "fcf_margin": 7.0,
      "wacc": 10.0,
      "terminal_growth": 1.5
    }
  },

  "projections": {
    "base": {
      "years": ["Y1", "Y2", "Y3", "Y4", "Y5"],
      "fcf": [336.6, 340.0, 343.4, 343.4, 343.4],
      "discount_factors": [0.9174, 0.8417, 0.7722, 0.7084, 0.6499],
      "pv_fcf": [308.8, 286.2, 265.1, 243.2, 223.2]
    },
    "bull": {
      "years": ["Y1", "Y2", "Y3", "Y4", "Y5"],
      "fcf": [346.5, 360.4, 371.2, 378.6, 386.2],
      "discount_factors": [0.9217, 0.8495, 0.7829, 0.7216, 0.6650],
      "pv_fcf": [319.4, 306.2, 290.6, 273.2, 256.8]
    },
    "bear": {
      "years": ["Y1", "Y2", "Y3", "Y4", "Y5"],
      "fcf": [320.1, 310.5, 304.3, 301.2, 298.2],
      "discount_factors": [0.9091, 0.8264, 0.7513, 0.6830, 0.6209],
      "pv_fcf": [291.0, 256.6, 228.6, 205.7, 185.2]
    }
  },

  "valuation": {
    "base": {
      "sum_pv_fcf": 1326.5,
      "terminal_value": 5005.3,
      "pv_terminal": 3253.0,
      "enterprise_value": 4579.5,
      "equity_value": 2849.5,
      "intrinsic_value": 1.57,
      "upside": -29.9
    },
    "bull": {
      "sum_pv_fcf": 1446.2,
      "terminal_value": 6601.7,
      "pv_terminal": 4390.0,
      "enterprise_value": 5836.2,
      "equity_value": 4106.2,
      "intrinsic_value": 2.26,
      "upside": 0.9
    },
    "bear": {
      "sum_pv_fcf": 1167.1,
      "terminal_value": 3562.1,
      "pv_terminal": 2211.9,
      "enterprise_value": 3379.0,
      "equity_value": 1649.0,
      "intrinsic_value": 0.91,
      "upside": -59.4
    }
  },

  "entry_price": {
    "base": {
      "terminal_value_per_share": 2.75,
      "years_to_terminal": 5,
      "entry_price": 1.37,
      "entry_discount_from_current": -38.8
    },
    "bull": {
      "terminal_value_per_share": 3.63,
      "years_to_terminal": 5,
      "entry_price": 1.80,
      "entry_discount_from_current": -19.6
    },
    "bear": {
      "terminal_value_per_share": 1.96,
      "years_to_terminal": 5,
      "entry_price": 0.97,
      "entry_discount_from_current": -56.7
    }
  },

  "sensitivity": {
    "wacc_range": [7.0, 8.0, 9.0, 10.0, 11.0],
    "terminal_growth_range": [1.0, 1.5, 2.0, 2.5, 3.0],
    "matrix": [
      [2.15, 2.31, 2.50, 2.74, 3.04],
      [1.82, 1.94, 2.08, 2.25, 2.45],
      [1.57, 1.66, 1.77, 1.90, 2.05],
      [1.37, 1.45, 1.53, 1.63, 1.75],
      [1.21, 1.27, 1.34, 1.42, 1.51]
    ]
  },

  "probability_weighted": {
    "weights": {"bull": 0.20, "base": 0.50, "bear": 0.30},
    "weighted_iv": 1.51
  }
};

        // Parse CSV
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
                return obj;
            });
        }

        const data = parseCSV(csvData);

        // Sort chronologically (oldest first)
        data.sort((a, b) => {
            const parseDate = (p) => {
                const year = parseInt(p.match(/\d{4}/)?.[0] || '0');
                const isH1 = p.includes('H1');
                const isH2 = p.includes('H2');
                const isFY = p.startsWith('FY');
                const subOrder = isH1 ? 1 : isH2 ? 2 : isFY ? 3 : 0;
                return year * 10 + subOrder;
            };
            return parseDate(a.Period) - parseDate(b.Period);
        });

        // Filter for FY data only
        const fyData = data.filter(d => d.Period.startsWith('FY'));

        // Chart defaults
        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#e0e0e0', font: { size: 11 } } }
            },
            scales: {
                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        };

        const colors = {
            primary: '#00d4aa',
            secondary: '#00b894',
            tertiary: '#0984e3',
            quaternary: '#6c5ce7',
            warning: '#fdcb6e',
            danger: '#ff6b6b'
        };

        // YoY calculation
        function calcYoYChange(current, previous) {
            if (!previous || !current || previous === '' || current === '') return null;
            const curr = parseFloat(current);
            const prev = parseFloat(previous);
            if (isNaN(curr) || isNaN(prev) || prev === 0) return null;
            return ((curr - prev) / Math.abs(prev) * 100).toFixed(1);
        }

        // Format number for display
        function formatNumber(num, decimals = 0) {
            if (!num || num === '') return 'N/A';
            const n = parseFloat(num);
            if (isNaN(n)) return 'N/A';
            return n.toFixed(decimals);
        }

        // Render KPI cards
        function renderKPIs() {
            const latest = fyData[fyData.length - 1];
            const previous = fyData[fyData.length - 2];

            const kpis = [
                { label: 'Revenue', value: formatNumber(latest.Revenue, 0) + 'M', change: calcYoYChange(latest.Revenue, previous.Revenue) },
                { label: 'EBITDA', value: formatNumber(latest.EBITDA, 0) + 'M', change: calcYoYChange(latest.EBITDA, previous.EBITDA) },
                { label: 'Net Income', value: formatNumber(latest.NetIncome, 0) + 'M', change: calcYoYChange(latest.NetIncome, previous.NetIncome) },
                { label: 'Free Cash Flow', value: formatNumber(latest.FreeCashFlow, 0) + 'M', change: calcYoYChange(latest.FreeCashFlow, previous.FreeCashFlow) },
                { label: 'EPS', value: formatNumber(latest.EPS, 1) + 'c', change: calcYoYChange(latest.EPS, previous.EPS) },
                { label: 'Dividend Per Share', value: formatNumber(latest.DividendsPerShare, 1) + 'c', change: calcYoYChange(latest.DividendsPerShare, previous.DividendsPerShare) },
                { label: 'Mobile Connections', value: formatNumber(latest.MobileConnections, 0) + 'K', change: calcYoYChange(latest.MobileConnections, previous.MobileConnections) },
                { label: 'IoT Connections', value: formatNumber(latest.IoTConnections, 0) + 'K', change: calcYoYChange(latest.IoTConnections, previous.IoTConnections) }
            ];

            const grid = document.getElementById('kpiGrid');
            grid.innerHTML = kpis.map(kpi => {
                const changeClass = kpi.change ? (parseFloat(kpi.change) >= 0 ? 'positive' : 'negative') : '';
                const changeText = kpi.change ? `${parseFloat(kpi.change) >= 0 ? '+' : ''}${kpi.change}% YoY` : '';
                return `
                    <div class="kpi-card">
                        <div class="kpi-value">${kpi.value}</div>
                        <div class="kpi-label">${kpi.label}</div>
                        ${changeText ? `<div class="kpi-change ${changeClass}">${changeText}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Render guidance
        function renderGuidance() {
            if (!analysis.guidance || !analysis.guidance.items || analysis.guidance.items.length === 0) {
                document.getElementById('guidanceSection').style.display = 'none';
                return;
            }

            const guidance = analysis.guidance;
            document.getElementById('guidanceAsOf').textContent = guidance.as_of || '';
            document.getElementById('guidanceFY').textContent = guidance.fiscal_year || '';

            const grid = document.getElementById('guidanceGrid');
            grid.innerHTML = guidance.items.map(item => {
                const vsClass = item.vs_prior ? item.vs_prior.toLowerCase() : 'new';
                const vsLabel = item.vs_prior ? item.vs_prior.charAt(0).toUpperCase() + item.vs_prior.slice(1) : 'New';
                return `
                    <div class="guidance-card">
                        <div class="guidance-metric">${item.metric}</div>
                        <div class="guidance-target">${item.target}</div>
                        <div class="guidance-period">${item.period}</div>
                        <span class="guidance-vs-prior ${vsClass}">${vsLabel}</span>
                        ${item.notes ? `<div class="guidance-notes">${item.notes}</div>` : ''}
                    </div>
                `;
            }).join('');

            const commentary = document.getElementById('guidanceCommentary');
            if (guidance.management_commentary) {
                commentary.textContent = guidance.management_commentary;
                commentary.style.display = 'block';
            } else {
                commentary.style.display = 'none';
            }
        }

        // Toggle overview
        function toggleOverview() {
            const btn = document.querySelector('.overview-toggle');
            const content = document.getElementById('overviewContent');
            btn.classList.toggle('active');
            content.classList.toggle('active');
        }

        // Modal functions
        function openModal(key) {
            document.getElementById('modalTitle').textContent = metricDescriptions[key].title;
            document.getElementById('modalBody').innerHTML = metricDescriptions[key].content;
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(event) {
            if (event && event.target !== document.getElementById('modalOverlay')) return;
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        // Metric descriptions
        const metricDescriptions = {
            revenue: {
                title: "Revenue",
                content: `
                    <p><strong>Revenue</strong> measures total income from Spark's telecommunications services and products.</p>
                    <div class="metric-highlight">
                        <strong>For Spark New Zealand:</strong> Revenue has been flat to declining (-0.2% 5-year CAGR) due to market saturation in mobile and broadband, price competition, and declining enterprise/IT services revenue. Mobile represents ~40% of revenue, broadband/connectivity ~25%, with cloud/IT services and data centres making up the balance.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Mobile service revenue trends - key indicator of competitive position</li>
                        <li>Enterprise and Government segment performance - most exposed to economic cycles</li>
                        <li>Impact of SPK-30 transformation and refocus on core connectivity</li>
                        <li>Data centre revenue growth (though 75% of business sold to PEP in Aug 2025)</li>
                    </ul>
                `
            },
            profitability: {
                title: "EBITDA & Net Income",
                content: `
                    <p><strong>EBITDA</strong> (Earnings Before Interest, Tax, Depreciation, Amortization) and <strong>Net Income</strong> measure operational and bottom-line profitability.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> Profitability under significant pressure in FY25, with adjusted EBITDAI down 8.9% to NZ$1,060M and adjusted NPAT down 33.6% to NZ$227M. This reflects intense competition, declining enterprise revenue, and margin compression during transformation. Management expects cost reduction program (NZ$110-140M savings by FY27) to stabilize margins.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>EBITDA margin stabilization as cost reduction program delivers</li>
                        <li>Impact of 1,300 FTE reduction on operating costs</li>
                        <li>Depreciation trends as network investment moderates</li>
                        <li>One-time costs from transformation vs. sustainable profitability</li>
                    </ul>
                `
            },
            margins: {
                title: "Net Margin",
                content: `
                    <p><strong>Net Margin</strong> shows what percentage of revenue flows through to net profit after all expenses.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> Net margin compressed sharply to 6.1% in FY25 from 8.9% in FY24 and 11% historical levels. This reflects intense price competition in mobile (especially enterprise segment), declining high-margin enterprise IT revenue, and transformation costs. Telco industry typically operates at 8-15% net margins depending on maturity and competition.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Margin stabilization around 8-10% as cost savings materialize</li>
                        <li>Impact of mobile ARPU trends (down 0.6% pay monthly, -13.9% enterprise)</li>
                        <li>Mix shift toward higher-margin connectivity vs. lower-margin IT services</li>
                        <li>Competitive dynamics - aggressive pricing in enterprise segment</li>
                    </ul>
                `
            },
            eps: {
                title: "Earnings Per Share",
                content: `
                    <p><strong>EPS</strong> measures net profit per share, a key metric for equity investors. Reported in NZ cents per share.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> EPS declined sharply to 12.4 cents in FY25 from 18.7 cents in FY24 and 21-23 cents in prior years. This represents a -9.5% 5-year CAGR. The decline reflects both lower profitability and relatively flat share count (~1.82-1.87B shares). EPS has diverged significantly from equity growth (+0.9% CAGR), indicating margin compression during SPK-30 transformation.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>EPS recovery as cost reduction program delivers (targeting NZ$110-140M savings)</li>
                        <li>Share buyback potential once balance sheet deleverages (currently 2.3x net debt/EBITDAI)</li>
                        <li>Dividend coverage ratio under new FCF-based policy</li>
                        <li>Normalization of transformation costs vs. sustainable earnings power</li>
                    </ul>
                `
            },
            fcf: {
                title: "Free Cash Flow",
                content: `
                    <p><strong>Free Cash Flow</strong> (Operating Cash Flow minus Capital Expenditures) measures cash available for dividends, debt reduction, or growth investments.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> FCF held steady at NZ$330M in FY25 despite profit decline, as lower capex offset weaker operating cash flow. New FCF definition (working capital + core capex) excludes spectrum and strategic investments. Management guides to NZ$290-330M for FY26. New dividend policy targets 70-100% FCF payout (100% for FY26), replacing prior fixed 25 cents per share approach.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>FCF sustainability in NZ$290-330M range vs. historical NZ$400-500M</li>
                        <li>Capex management (targeting 10-12% of revenue long-term)</li>
                        <li>Working capital impacts from transformation and business mix changes</li>
                        <li>Balance sheet deleveraging from asset sales (data centre NZ$705M, HTAL, Connexa)</li>
                    </ul>
                `
            },
            capex: {
                title: "Capital Expenditure",
                content: `
                    <p><strong>Capital Expenditure</strong> represents investments in network infrastructure, IT systems, and facilities.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> Capex declined 17.2% to NZ$429M in FY25 (11.6% of revenue) as 5G rollout matured. Management targets 10-12% of revenue long-term, down from historical 12-14%. This excludes spectrum acquisitions and strategic investments (e.g., data centres). Lower capex reflects outsourcing partnerships with Nokia (network) and Infosys/HPE (IT), plus completion of major 5G build (now 50% population coverage).
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Capex intensity staying in 10-12% range vs. competitors at 12-15%</li>
                        <li>5G coverage expansion economics (currently 50% population, 99% 4G)</li>
                        <li>Impact of Nokia outsourcing on network capex needs</li>
                        <li>Data centre capex now largely off balance sheet with PEP partnership</li>
                    </ul>
                `
            },
            dividends: {
                title: "Dividends Per Share",
                content: `
                    <p><strong>Dividends Per Share</strong> shows total annual dividend payments per share, reported in NZ cents.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> Dividend held at 25.0 cents in FY25 but new policy announced for FY26+ ties dividend to Free Cash Flow (70-100% payout ratio). For FY26, targeting 100% of NZ$290-330M FCF = approximately 15.9-18.1 cents per share (based on 1.82B shares), representing a potential cut from prior 25 cents. New policy aims for "stable annuity-like returns" with sustainable growth as FCF improves.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>FY26 dividend quantum (likely 16-18 cents vs. prior 25 cents)</li>
                        <li>Board discretion within 70-100% payout range</li>
                        <li>Dividend growth trajectory as cost savings deliver FCF improvement</li>
                        <li>Dividend sustainability through economic cycles with FCF-linked policy</li>
                    </ul>
                `
            },
            connections: {
                title: "Mobile & Broadband Connections",
                content: `
                    <p><strong>Connections</strong> measure the total number of mobile and broadband subscribers, key volume metrics for telcos.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> Mobile connections at 2,629K in FY25 (down 2.3% YoY) after years of growth, reflecting enterprise workforce reductions and prepaid decline (-5.2%). Broadband at 673K (down 4.1%) due to fibre market competition. Spark maintains #1 market share in mobile (42%) and broadband, but faces saturation and price competition. Total NZ mobile market growing only ~1.2% in FY25.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Mobile connection stabilization as Q4 FY25 showed improvement</li>
                        <li>Market share defense (42% mobile) vs. One NZ and 2degrees</li>
                        <li>ARPU trends more important than volume in saturated market</li>
                        <li>5G migration driving higher ARPU for data-heavy users</li>
                    </ul>
                `
            },
            iot: {
                title: "IoT Connections",
                content: `
                    <p><strong>IoT Connections</strong> count devices connected via cellular IoT (narrowband IoT, LTE-M) for applications like smart meters, fleet management, agriculture sensors.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> IoT connections surged to 2,380K in FY25 (up 16% YoY), representing a major growth driver. Spark is NZ's largest IoT provider, benefiting from smart meter rollouts (electricity, water), agriculture digitization, and enterprise asset tracking. IoT revenue relatively small (~5% of total) but high-margin and growing rapidly. 118MW+ data centre pipeline supports IoT and cloud services.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Sustained high teens growth in IoT connections</li>
                        <li>IoT ARPU and revenue contribution (currently ~NZ$10-15 per device annually)</li>
                        <li>Win rate in smart meter deployments and enterprise IoT projects</li>
                        <li>Competitive positioning vs. One NZ and 2degrees in IoT</li>
                    </ul>
                `
            },
            revenueMix: {
                title: "Mobile vs Broadband Revenue",
                content: `
                    <p><strong>Revenue Mix</strong> shows the relative contribution of mobile service revenue vs. broadband revenue to total connectivity revenue.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> Mobile service revenue (NZ$987M in FY25, down 2.3%) represents ~40% of total revenue and is the largest single segment. Broadband revenue (NZ$608M, down 0.8%) adds another ~25%. Together, mobile and broadband drive ~80% of gross margins despite being 65% of revenue. Mobile under pressure from price competition (especially enterprise ARPU -13.9%), while broadband stabilizing after fibre market share battles.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Mobile revenue stabilization as market share and ARPU trends improve</li>
                        <li>Broadband revenue resilience (more stable than mobile historically)</li>
                        <li>5G monetization through premium data plans and fixed wireless broadband</li>
                        <li>Enterprise mobile fleet size (exposed to NZ government workforce reductions)</li>
                    </ul>
                `
            },
            debt: {
                title: "Total Debt vs Cash",
                content: `
                    <p><strong>Debt and Cash</strong> show financial leverage and liquidity position. Net debt (Debt - Cash) relative to EBITDA is a key metric.</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> Total debt increased to NZ$1,795M in FY25 while cash remained low at NZ$65M, resulting in net debt of NZ$1,730M (2.3x EBITDAI as of Dec 2024). However, asset sales completed/announced (data centres NZ$705M, HTAL NZ$47M, Connexa NZ$309M) will significantly reduce leverage. Target is to deleverage below 2.0x over medium term. Investment grade credit rating maintained.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Deleveraging from asset sale proceeds (over NZ$1B total)</li>
                        <li>Net debt/EBITDAI trending below 2.0x target</li>
                        <li>Credit rating maintenance (investment grade critical for telco funding costs)</li>
                        <li>Debt refinancing costs as RBNZ cuts rates (now 2.25%)</li>
                    </ul>
                `
            },
            equity: {
                title: "Shareholders' Equity",
                content: `
                    <p><strong>Shareholders' Equity</strong> represents the book value of assets attributable to shareholders (assets minus liabilities).</p>
                    <div class="metric-highlight">
                        <strong>For Spark:</strong> Equity held steady at NZ$1,485M in FY25, roughly flat over the past 5 years (+0.9% CAGR) despite dividends paid. This reflects retained earnings being offset by share buybacks and dividend payments. Equity/Assets ratio at 35% is typical for capital-intensive telcos. Book value per share ~NZ$0.82 vs. market price NZ$2.24, implying 2.7x price-to-book (reasonable for quality telco franchise).
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li>Equity growth as profitability stabilizes and cost savings deliver</li>
                        <li>Return on Equity (ROE) improvement from current ~15% toward 18-20%</li>
                        <li>Impact of asset sales on equity base and capital structure</li>
                        <li>Share buyback potential once leverage normalizes</li>
                    </ul>
                `
            }
        };

        // Render charts
        function renderCharts() {
            // Revenue chart
            new Chart(document.getElementById('revenueChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [{
                        label: 'Revenue (NZ$M)',
                        data: fyData.map(d => parseFloat(d.Revenue) || 0),
                        backgroundColor: colors.primary
                    }]
                },
                options: { ...chartDefaults }
            });

            // Profitability chart
            new Chart(document.getElementById('profitabilityChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [
                        {
                            label: 'EBITDA (NZ$M)',
                            data: fyData.map(d => parseFloat(d.EBITDA) || 0),
                            backgroundColor: colors.primary
                        },
                        {
                            label: 'Net Income (NZ$M)',
                            data: fyData.map(d => parseFloat(d.NetIncome) || 0),
                            backgroundColor: colors.tertiary
                        }
                    ]
                },
                options: { ...chartDefaults }
            });

            // Margins chart
            new Chart(document.getElementById('marginsChart'), {
                type: 'line',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [{
                        label: 'Net Margin %',
                        data: fyData.map(d => parseFloat(d.NetMargin) || 0),
                        borderColor: colors.primary,
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        ...chartDefaults.scales,
                        y: {
                            ...chartDefaults.scales.y,
                            ticks: {
                                ...chartDefaults.scales.y.ticks,
                                callback: value => value + '%'
                            }
                        }
                    }
                }
            });

            // EPS chart
            new Chart(document.getElementById('epsChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [{
                        label: 'EPS (NZ cents)',
                        data: fyData.map(d => parseFloat(d.EPS) || 0),
                        backgroundColor: colors.quaternary
                    }]
                },
                options: { ...chartDefaults }
            });

            // FCF chart
            new Chart(document.getElementById('fcfChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [{
                        label: 'Free Cash Flow (NZ$M)',
                        data: fyData.map(d => parseFloat(d.FreeCashFlow) || 0),
                        backgroundColor: colors.secondary
                    }]
                },
                options: { ...chartDefaults }
            });

            // CapEx chart
            new Chart(document.getElementById('capexChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [{
                        label: 'Capital Expenditure (NZ$M)',
                        data: fyData.map(d => parseFloat(d.CapEx) || 0),
                        backgroundColor: colors.warning
                    }]
                },
                options: { ...chartDefaults }
            });

            // Dividends chart
            new Chart(document.getElementById('dividendsChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [{
                        label: 'Dividends Per Share (NZ cents)',
                        data: fyData.map(d => parseFloat(d.DividendsPerShare) || 0),
                        backgroundColor: colors.primary
                    }]
                },
                options: { ...chartDefaults }
            });

            // Connections chart (all periods with data)
            new Chart(document.getElementById('connectionsChart'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.Period),
                    datasets: [
                        {
                            label: 'Mobile Connections (000s)',
                            data: data.map(d => parseFloat(d.MobileConnections) || null),
                            borderColor: colors.primary,
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Broadband Connections (000s)',
                            data: data.map(d => parseFloat(d.BroadbandConnections) || null),
                            borderColor: colors.tertiary,
                            backgroundColor: 'rgba(9, 132, 227, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: { ...chartDefaults }
            });

            // IoT chart (filter periods with IoT data)
            const iotData = data.filter(d => d.IoTConnections && d.IoTConnections !== '');
            new Chart(document.getElementById('iotChart'), {
                type: 'bar',
                data: {
                    labels: iotData.map(d => d.Period),
                    datasets: [{
                        label: 'IoT Connections (000s)',
                        data: iotData.map(d => parseFloat(d.IoTConnections) || 0),
                        backgroundColor: colors.quaternary
                    }]
                },
                options: { ...chartDefaults }
            });

            // Revenue mix chart
            new Chart(document.getElementById('revenueMixChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [
                        {
                            label: 'Mobile Service Revenue (NZ$M)',
                            data: fyData.map(d => parseFloat(d.MobileServiceRevenue) || 0),
                            backgroundColor: colors.primary
                        },
                        {
                            label: 'Broadband Revenue (NZ$M)',
                            data: fyData.map(d => parseFloat(d.BroadbandRevenue) || 0),
                            backgroundColor: colors.tertiary
                        }
                    ]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        ...chartDefaults.scales,
                        x: { ...chartDefaults.scales.x, stacked: true },
                        y: { ...chartDefaults.scales.y, stacked: true }
                    }
                }
            });

            // Debt chart
            new Chart(document.getElementById('debtChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [
                        {
                            label: 'Total Debt (NZ$M)',
                            data: fyData.map(d => parseFloat(d.TotalDebt) || 0),
                            backgroundColor: colors.danger
                        },
                        {
                            label: 'Cash (NZ$M)',
                            data: fyData.map(d => parseFloat(d.CashAndEquivalents) || 0),
                            backgroundColor: colors.secondary
                        }
                    ]
                },
                options: { ...chartDefaults }
            });

            // Equity chart
            new Chart(document.getElementById('equityChart'), {
                type: 'bar',
                data: {
                    labels: fyData.map(d => d.Period),
                    datasets: [{
                        label: 'Shareholders\' Equity (NZ$M)',
                        data: fyData.map(d => parseFloat(d.ShareholdersEquity) || 0),
                        backgroundColor: colors.primary
                    }]
                },
                options: { ...chartDefaults }
            });
        }

        // DCF Functions
        let currentScenario = 'base';

        function initDCF() {
            if (!dcfData || !dcfData.valuation) return;

            document.getElementById('dcfCurrent').textContent = 'NZ$' + dcfData.current_price.toFixed(2);

            if (dcfData.historical_growth.growth_divergence_warning) {
                document.getElementById('growthWarning').style.display = 'flex';
                document.getElementById('warningText').textContent = dcfData.historical_growth.growth_divergence_warning;
            }

            const base = dcfData.assumptions.base;
            document.getElementById('growthSlider').value = dcfData.historical_growth.selected_growth_rate;
            document.getElementById('waccSlider').value = base.wacc;
            document.getElementById('terminalSlider').value = base.terminal_growth;

            document.getElementById('growthValue').textContent = dcfData.historical_growth.selected_growth_rate + '%';
            document.getElementById('waccValue').textContent = base.wacc + '%';
            document.getElementById('terminalValue').textContent = base.terminal_growth + '%';

            document.getElementById('growthHint').textContent = 'Based on ' + dcfData.historical_growth.growth_rate_source.replace(/_/g, ' ');

            renderDCFInputs();
            renderHistoricalGrowth();
            renderSensitivityMatrix();
            updateDCFDisplay();
            switchScenario('base');
        }

        function renderDCFInputs() {
            const inputs = dcfData.inputs;
            const currency = inputs.currency || 'NZ$';
            const units = inputs.units === 'millions' ? 'M' : inputs.units === 'billions' ? 'B' : '';

            const formatNum = (n) => {
                if (Math.abs(n) >= 1000) return currency + (n/1000).toFixed(1) + 'B';
                return currency + n.toFixed(0) + units;
            };

            document.getElementById('baseFCF').textContent = formatNum(inputs.last_fcf);

            const shares = inputs.shares_outstanding;
            document.getElementById('sharesOut').textContent = shares >= 1000 ? (shares/1000).toFixed(2) + 'B' : shares.toFixed(1) + 'M';

            const netDebt = inputs.net_debt;
            const netDebtEl = document.getElementById('netDebt');
            netDebtEl.textContent = formatNum(netDebt);
            if (netDebt < 0) netDebtEl.style.color = '#00d4aa';

            renderFCFProjections();
        }

        function renderFCFProjections() {
            const startGrowth = parseFloat(document.getElementById('growthSlider')?.value || dcfData.historical_growth.selected_growth_rate);
            const baseFCF = dcfData.inputs.last_fcf;
            const currency = dcfData.inputs.currency || 'NZ$';

            const formatFCF = (n) => {
                if (Math.abs(n) >= 1000) return currency + (n/1000).toFixed(1) + 'B';
                return currency + n.toFixed(0) + 'M';
            };

            const endGrowth = 10;
            const growthRates = [];
            for (let i = 0; i < 5; i++) {
                const rate = startGrowth > endGrowth
                    ? startGrowth - (startGrowth - endGrowth) * (i / 4)
                    : startGrowth;
                growthRates.push(rate);
            }

            let fcf = baseFCF;
            const fcfValues = [baseFCF];

            for (let i = 0; i < 5; i++) {
                fcf = fcf * (1 + growthRates[i] / 100);
                fcfValues.push(fcf);
            }

            let html = `
                <div class="fcf-projection-item header">Base</div>
                <div class="fcf-projection-item header">Year 1</div>
                <div class="fcf-projection-item header">Year 2</div>
                <div class="fcf-projection-item header">Year 3</div>
                <div class="fcf-projection-item header">Year 4</div>
                <div class="fcf-projection-item header">Year 5</div>
            `;

            html += `<div class="fcf-projection-item">
                <div class="fcf-value">${formatFCF(fcfValues[0])}</div>
                <div class="growth-rate">-</div>
            </div>`;

            for (let i = 1; i <= 5; i++) {
                html += `<div class="fcf-projection-item">
                    <div class="fcf-value">${formatFCF(fcfValues[i])}</div>
                    <div class="growth-rate">${growthRates[i-1] >= 0 ? '+' : ''}${growthRates[i-1].toFixed(0)}%</div>
                </div>`;
            }

            document.getElementById('fcfProjectionTable').innerHTML = html;
        }

        function calculateDCF(startGrowth, wacc, terminalGrowth) {
            const years = 5;
            const fcf = dcfData.inputs.last_fcf;
            let pvFCF = 0;
            let projectedFCF = fcf;

            const endGrowth = 10;

            for (let i = 0; i < years; i++) {
                const yearGrowth = startGrowth > endGrowth
                    ? startGrowth - (startGrowth - endGrowth) * (i / 4)
                    : startGrowth;
                projectedFCF *= (1 + yearGrowth / 100);
                pvFCF += projectedFCF / Math.pow(1 + wacc/100, i + 1);
            }

            const terminalFCF = projectedFCF * (1 + terminalGrowth/100);
            const terminalValue = terminalFCF / (wacc/100 - terminalGrowth/100);
            const pvTerminal = terminalValue / Math.pow(1 + wacc/100, years);

            const enterpriseValue = pvFCF + pvTerminal;
            const equityValue = enterpriseValue - dcfData.inputs.net_debt;
            const iv = equityValue / dcfData.inputs.shares_outstanding;

            const terminalPerShare = terminalValue / dcfData.inputs.shares_outstanding;
            const entryPrice = terminalPerShare / Math.pow(1.15, years);

            return {
                iv: iv,
                entryPrice: entryPrice,
                terminalPerShare: terminalPerShare,
                pvFCF: pvFCF,
                pvTerminal: pvTerminal,
                enterpriseValue: enterpriseValue
            };
        }

        window.updateDCFDisplay = function() {
            const growth = parseFloat(document.getElementById('growthSlider').value);
            const wacc = parseFloat(document.getElementById('waccSlider').value);
            const terminal = parseFloat(document.getElementById('terminalSlider').value);

            document.getElementById('growthValue').textContent = growth.toFixed(1) + '%';
            document.getElementById('waccValue').textContent = wacc.toFixed(1) + '%';
            document.getElementById('terminalValue').textContent = terminal.toFixed(1) + '%';

            renderFCFProjections();

            const result = calculateDCF(growth, wacc, terminal);

            document.getElementById('dcfIV').textContent = 'NZ$' + result.iv.toFixed(2);
            document.getElementById('dcfEntry').textContent = 'NZ$' + result.entryPrice.toFixed(2);

            const upside = ((result.iv - dcfData.current_price) / dcfData.current_price * 100);
            const upsideEl = document.getElementById('dcfUpside');
            upsideEl.textContent = (upside >= 0 ? '+' : '') + upside.toFixed(0) + '% ' + (upside >= 0 ? 'upside' : 'downside');
            upsideEl.className = 'dcf-change ' + (upside >= 0 ? 'positive' : 'negative');

            document.getElementById('dcfWeighted').textContent = 'NZ$' + dcfData.probability_weighted.weighted_iv.toFixed(2);

            const grid = document.getElementById('assumptionGrid');
            if (grid) {
                grid.innerHTML = `
                    <div class="assumption-item">
                        <div class="label">Growth Rate</div>
                        <div class="value">${growth.toFixed(1)}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">WACC</div>
                        <div class="value">${wacc.toFixed(1)}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Terminal Growth</div>
                        <div class="value">${terminal.toFixed(1)}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Intrinsic Value</div>
                        <div class="value" style="color: #00d4aa;">NZ$${result.iv.toFixed(2)}</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Entry Price</div>
                        <div class="value" style="color: #00d4aa;">NZ$${result.entryPrice.toFixed(2)}</div>
                    </div>
                `;
            }
        };

        window.switchScenario = function(scenario) {
            currentScenario = scenario;

            document.querySelectorAll('.scenario-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.scenario === scenario);
            });

            const assumptions = dcfData.assumptions[scenario];
            const valuation = dcfData.valuation[scenario];

            document.getElementById('growthSlider').value = assumptions.growth_rates[0];
            document.getElementById('waccSlider').value = assumptions.wacc;
            document.getElementById('terminalSlider').value = assumptions.terminal_growth;

            const grid = document.getElementById('assumptionGrid');
            grid.innerHTML = `
                <div class="assumption-item">
                    <div class="label">Year 1 Growth</div>
                    <div class="value">${assumptions.growth_rates[0]}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Year 5 Growth</div>
                    <div class="value">${assumptions.growth_rates[4]}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">FCF Margin</div>
                    <div class="value">${assumptions.fcf_margin}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">WACC</div>
                    <div class="value">${assumptions.wacc}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Terminal Growth</div>
                    <div class="value">${assumptions.terminal_growth}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Intrinsic Value</div>
                    <div class="value" style="color: #00d4aa;">NZ$${valuation.intrinsic_value.toFixed(2)}</div>
                </div>
            `;

            updateDCFDisplay();
        };

        function renderHistoricalGrowth() {
            const growth = dcfData.historical_growth;
            const selectedSource = growth.growth_rate_source;
            const grid = document.getElementById('growthGrid');

            const metrics = [
                { key: 'revenue_3yr_cagr', label: 'Revenue 3Y' },
                { key: 'revenue_5yr_cagr', label: 'Revenue 5Y' },
                { key: 'eps_3yr_cagr', label: 'EPS 3Y' },
                { key: 'eps_5yr_cagr', label: 'EPS 5Y' },
                { key: 'equity_3yr_cagr', label: 'Equity 3Y' },
                { key: 'equity_5yr_cagr', label: 'Equity 5Y' },
                { key: 'fcf_3yr_cagr', label: 'FCF 3Y' },
                { key: 'fcf_5yr_cagr', label: 'FCF 5Y' }
            ];

            grid.innerHTML = metrics.map(m => {
                const rate = growth[m.key];
                const isSelected = m.key === selectedSource;
                const colorClass = rate >= 0 ? 'positive' : 'negative';
                return `
                    <div class="growth-item ${isSelected ? 'selected' : ''}">
                        <div class="metric">${m.label}</div>
                        <div class="rate ${colorClass}">${rate >= 0 ? '+' : ''}${rate.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');
        }

        function renderSensitivityMatrix() {
            const sens = dcfData.sensitivity;
            const table = document.getElementById('sensitivityMatrix');
            const currentPrice = dcfData.current_price;

            let html = '<tr><th>WACC \\ Term G</th>';
            sens.terminal_growth_range.forEach(tg => {
                html += `<th>${tg}%</th>`;
            });
            html += '</tr>';

            sens.wacc_range.forEach((wacc, i) => {
                html += `<tr><th>${wacc}%</th>`;
                sens.matrix[i].forEach((val, j) => {
                    const isHighlight = wacc === dcfData.assumptions.base.wacc &&
                                       sens.terminal_growth_range[j] === dcfData.assumptions.base.terminal_growth;
                    const colorClass = val >= currentPrice ? 'above-current' : 'below-current';
                    html += `<td class="${isHighlight ? 'highlight' : colorClass}">NZ$${val.toFixed(2)}</td>`;
                });
                html += '</tr>';
            });

            table.innerHTML = html;
        }

        // Initialize everything
        renderKPIs();
        renderGuidance();
        renderCharts();
        initDCF();
    </script>
</body>
</html>