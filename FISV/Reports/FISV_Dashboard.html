<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiserv (FISV) Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4aa, #00b894);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .header p {
            color: #888;
            font-size: 1.1rem;
        }

        /* Investment Overview Section */
        .overview-section {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        .overview-toggle {
            width: 100%;
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 12px;
            padding: 16px 24px;
            color: #00d4aa;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        .overview-toggle:hover {
            background: rgba(0, 212, 170, 0.2);
        }
        .overview-toggle .arrow {
            transition: transform 0.3s ease;
        }
        .overview-toggle.active .arrow {
            transform: rotate(180deg);
        }
        .overview-content {
            display: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 30px;
            margin-top: -12px;
        }
        .overview-content.active {
            display: block;
        }
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        .overview-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .overview-card h3 {
            color: #00d4aa;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .overview-card p {
            margin-bottom: 12px;
            line-height: 1.6;
        }
        .overview-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .overview-card li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            line-height: 1.5;
        }
        .overview-card li:last-child {
            border-bottom: none;
        }
        .overview-card.bull h3 { color: #00d4aa; }
        .overview-card.bear h3 { color: #ff6b6b; }
        .overview-card.risks h3 { color: #fdcb6e; }
        .risk-high { color: #ff6b6b; }
        .risk-moderate { color: #fdcb6e; }
        .risk-low { color: #00d4aa; }
        .revenue-stream {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .revenue-stream .percent {
            color: #00d4aa;
            font-weight: 600;
        }
        .trend-stable { color: #888; }
        .trend-declining { color: #ff6b6b; }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        .kpi-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 170, 0.2);
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00d4aa;
            margin-bottom: 5px;
        }
        .kpi-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .kpi-change {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .kpi-change.positive { color: #00d4aa; }
        .kpi-change.negative { color: #ff6b6b; }

        /* Guidance Section */
        .guidance-section {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        .guidance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .guidance-header h3 {
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .guidance-header h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d4aa, #00b894);
            border-radius: 2px;
        }
        .guidance-meta {
            font-size: 0.85rem;
            color: #888;
        }
        .guidance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .guidance-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
        }
        .guidance-card:hover {
            transform: translateY(-2px);
        }
        .guidance-metric {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .guidance-target {
            font-size: 1.4rem;
            font-weight: 600;
            color: #00d4aa;
            margin-bottom: 6px;
        }
        .guidance-period {
            font-size: 0.85rem;
            color: #e0e0e0;
            margin-bottom: 8px;
        }
        .guidance-vs-prior {
            display: inline-block;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .guidance-vs-prior.raised {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
        }
        .guidance-vs-prior.lowered {
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
        }
        .guidance-vs-prior.maintained {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }
        .guidance-vs-prior.new {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }
        .guidance-notes {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }
        .guidance-commentary {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 16px 20px;
            border-left: 3px solid #00d4aa;
            font-style: italic;
            color: #b0b0b0;
            line-height: 1.6;
        }
        .guidance-commentary::before {
            content: '"';
            font-size: 1.5rem;
            color: #00d4aa;
            margin-right: 4px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #fff;
            margin: 40px auto 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 212, 170, 0.3);
            max-width: 1400px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .chart-header h3 {
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-header h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d4aa, #00b894);
            border-radius: 2px;
        }
        .help-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 212, 170, 0.2);
            border: 1px solid #00d4aa;
            color: #00d4aa;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .help-btn:hover {
            background: #00d4aa;
            color: #1a1a2e;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: linear-gradient(135deg, #1e2a4a 0%, #16213e 100%);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(0, 212, 170, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            color: #00d4aa;
            font-size: 1.4rem;
            margin: 0;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: #ff6b6b;
            color: #fff;
        }
        .modal-body {
            padding: 25px;
            line-height: 1.7;
        }
        .modal-body p { margin-bottom: 15px; }
        .modal-body strong { color: #00d4aa; }
        .modal-body ul { margin: 15px 0; padding-left: 20px; }
        .modal-body li { margin-bottom: 8px; }
        .metric-highlight {
            background: rgba(0, 212, 170, 0.1);
            border-left: 3px solid #00d4aa;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        /* DCF Valuation Section */
        .dcf-section {
            max-width: 1400px;
            margin: 0 auto 40px;
        }
        .dcf-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dcf-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        .dcf-card:hover {
            transform: translateY(-3px);
        }
        .dcf-card.highlight {
            background: rgba(0, 212, 170, 0.1);
            border-color: rgba(0, 212, 170, 0.3);
        }
        .dcf-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .dcf-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #00d4aa;
        }
        .dcf-card:not(.highlight) .dcf-value {
            color: #fff;
        }
        .dcf-change {
            font-size: 1rem;
            margin-top: 8px;
            font-weight: 600;
        }
        .dcf-change.positive { color: #00d4aa; }
        .dcf-change.negative { color: #ff6b6b; }
        .dcf-sublabel {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
        }
        .dcf-warning {
            background: rgba(253, 203, 110, 0.15);
            border: 1px solid rgba(253, 203, 110, 0.4);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fdcb6e;
        }
        .warning-icon {
            font-size: 1.2rem;
        }
        .dcf-inputs {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .dcf-inputs h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .dcf-inputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .dcf-input-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .dcf-input-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .dcf-input-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #00d4aa;
        }
        .dcf-input-note {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }
        .fcf-projections h5 {
            color: #b0b0b0;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .fcf-projection-table {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px;
        }
        .fcf-projection-item {
            text-align: center;
        }
        .fcf-projection-item.header {
            font-size: 0.75rem;
            color: #888;
            font-weight: 600;
        }
        .fcf-projection-item .year {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 2px;
        }
        .fcf-projection-item .fcf-value {
            font-size: 1rem;
            color: #e0e0e0;
            font-weight: 500;
        }
        .fcf-projection-item .growth-rate {
            font-size: 0.75rem;
            color: #00d4aa;
            margin-top: 2px;
        }
        .dcf-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .slider-group label {
            font-size: 0.95rem;
            color: #e0e0e0;
            display: flex;
            justify-content: space-between;
        }
        .slider-group label span {
            color: #00d4aa;
            font-weight: 600;
        }
        .slider-group input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00d4aa;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00d4aa;
            cursor: pointer;
            border: none;
        }
        .slider-hint {
            font-size: 0.8rem;
            color: #666;
        }
        .scenario-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .scenario-tab {
            padding: 10px 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .scenario-tab:hover {
            border-color: rgba(0, 212, 170, 0.5);
            color: #e0e0e0;
        }
        .scenario-tab.active {
            background: rgba(0, 212, 170, 0.15);
            border-color: #00d4aa;
            color: #00d4aa;
        }
        .scenario-details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .scenario-details h4 {
            color: #00d4aa;
            margin-bottom: 15px;
        }
        .assumption-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .assumption-item {
            text-align: center;
        }
        .assumption-item .label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 4px;
        }
        .assumption-item .value {
            font-size: 1.1rem;
            color: #e0e0e0;
            font-weight: 500;
        }
        .sensitivity-section {
            margin-bottom: 30px;
        }
        .sensitivity-section h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        .sensitivity-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
        }
        .sensitivity-table th,
        .sensitivity-table td {
            padding: 12px 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .sensitivity-table th {
            background: rgba(0, 212, 170, 0.1);
            color: #00d4aa;
            font-weight: 600;
        }
        .sensitivity-table td {
            color: #e0e0e0;
        }
        .sensitivity-table td.highlight {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
            font-weight: 600;
        }
        .sensitivity-table td.below-current {
            color: #ff6b6b;
        }
        .sensitivity-table td.above-current {
            color: #00d4aa;
        }
        .historical-growth {
            margin-bottom: 30px;
        }
        .historical-growth h4 {
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        .growth-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        .growth-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .growth-item .metric {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 6px;
        }
        .growth-item .rate {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .growth-item .rate.positive { color: #00d4aa; }
        .growth-item .rate.negative { color: #ff6b6b; }
        .growth-item.selected {
            border-color: #00d4aa;
            background: rgba(0, 212, 170, 0.1);
        }
        .dcf-download {
            text-align: center;
            margin-top: 30px;
        }
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            background: rgba(0, 212, 170, 0.15);
            border: 1px solid #00d4aa;
            border-radius: 8px;
            color: #00d4aa;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        .download-btn:hover {
            background: #00d4aa;
            color: #1a1a2e;
        }
        .download-icon {
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .charts-container { grid-template-columns: 1fr; }
            .overview-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Fiserv (FISV) Financial Dashboard</h1>
        <p>Financial Technology & Payment Processing | Last Updated: FY2024</p>
    </div>

    <!-- Investment Overview Section -->
    <div class="overview-section">
        <button class="overview-toggle" onclick="toggleOverview()">
            <span>Investment Overview & Analysis</span>
            <span class="arrow">▼</span>
        </button>
        <div class="overview-content" id="overviewContent">
            <div class="overview-grid">
                <!-- Company Overview -->
                <div class="overview-card">
                    <h3>Company Overview</h3>
                    <p>Fiserv is a global financial technology company that provides payment processing, digital banking, and financial services technology to banks, credit unions, and merchants. Following its transformative $22 billion acquisition of First Data in 2019, Fiserv operates through two segments: Merchant Solutions (55% of revenue) providing payment acceptance and commerce-enabling solutions, and Financial Solutions (45% of revenue) delivering core banking, digital banking, and card processing platforms. The company processes 90 billion transactions annually with $3.1 trillion in gross payment volume, serving 6 million merchants and thousands of financial institutions primarily across North America.</p>
                </div>

                <!-- Business Model -->
                <div class="overview-card">
                    <h3>Business Model</h3>
                    <p>Processing and services revenue (81% of total) driven by account- and transaction-based fees under multi-year contracts with high renewal rates (99% for core banking). Revenue split approximately 55% Merchant Solutions and 45% Financial Solutions. Recurring revenue model with sticky client relationships due to high switching costs and operational integration.</p>
                    <ul>
                        <li class="revenue-stream">
                            <span>Merchant Solutions</span>
                            <span class="percent">55%</span>
                        </li>
                        <li class="revenue-stream">
                            <span>Financial Solutions</span>
                            <span class="percent">45%</span>
                        </li>
                        <li class="revenue-stream">
                            <span>Processing & Services</span>
                            <span class="percent">81%</span>
                        </li>
                        <li class="revenue-stream">
                            <span>Product Revenue</span>
                            <span class="percent">19%</span>
                        </li>
                    </ul>
                </div>

                <!-- Competitive Position -->
                <div class="overview-card">
                    <h3>Competitive Position</h3>
                    <p><strong>Competitors:</strong> FIS/Worldpay, Global Payments, Block (Square), Stripe, Adyen, Jack Henry & Associates, PayPal, Toast</p>
                    <p><strong>Market Position:</strong> Largest non-bank merchant acquirer in the U.S., processing 35.4 billion transactions worth $2.03 trillion (11% more transactions than nearest competitor FIS). Leading provider of core banking systems to community banks and credit unions with entrenched market position.</p>
                    <p><strong>Moat:</strong></p>
                    <ul>
                        <li><strong>Switching costs:</strong> Core banking systems have 99% annual retention due to operational risks and data migration complexity</li>
                        <li><strong>Scale and integration:</strong> End-to-end platform creates network effects and cross-selling opportunities</li>
                        <li><strong>Regulatory expertise:</strong> Deep understanding of financial services compliance</li>
                        <li><strong>Multi-year contracts:</strong> Long-term contracts with high renewal rates</li>
                    </ul>
                </div>

                <!-- Growth Drivers -->
                <div class="overview-card">
                    <h3>Growth Drivers</h3>
                    <ul>
                        <li>Clover platform expansion - targeting $4.5B revenue in 2026 (from $3.5B in 2025)</li>
                        <li>International expansion of Clover into Japan (late 2026), Brazil, Mexico, and Australia</li>
                        <li>AI integration via Microsoft partnership to enhance fraud detection and underwriting</li>
                        <li>Digital banking and embedded finance solutions</li>
                        <li>Cross-selling opportunities between Financial and Merchant Solutions</li>
                        <li>Carat enterprise platform growth targeting large merchants</li>
                        <li>Digital assets and cryptocurrency infrastructure</li>
                        <li>Strategic acquisitions - CardFree, TD Bank's Canadian merchant processing</li>
                    </ul>
                </div>

                <!-- Key Risks -->
                <div class="overview-card risks">
                    <h3>Key Risks</h3>
                    <ul>
                        <li><span class="risk-high">HIGH:</span> Clover execution - forced migrations caused 16% attrition, revenue down $200M</li>
                        <li><span class="risk-high">HIGH:</span> Client attrition - competitors winning clients due to service failures</li>
                        <li><span class="risk-high">HIGH:</span> Securities class action lawsuit over misleading growth claims</li>
                        <li><span class="risk-high">HIGH:</span> Growth deceleration - guidance cut from 10% to 3.5-4%</li>
                        <li><span class="risk-moderate">MODERATE:</span> High leverage - $23.7B net debt, Altman Z-Score 1.41 (distress zone)</li>
                        <li><span class="risk-moderate">MODERATE:</span> Leadership transition risk during turnaround</li>
                        <li><span class="risk-moderate">MODERATE:</span> Consumer spending exposure in Merchant Solutions</li>
                    </ul>
                </div>

                <!-- Bull Case -->
                <div class="overview-card bull">
                    <h3>Bull Case</h3>
                    <ul>
                        <li>Attractive valuation following 70% stock decline - trading at significant discount</li>
                        <li>New leadership team brings fresh perspective to address execution issues</li>
                        <li>Structural advantages remain intact - 99% retention, high switching costs</li>
                        <li>Clover international expansion and value-added services provide significant upside</li>
                        <li>2026 reset positions company for return to double-digit EPS growth in 2027</li>
                        <li>AI partnership with Microsoft positions company at forefront of fintech innovation</li>
                        <li>Recurring revenue model (81%) provides stability and visibility</li>
                        <li>Deeply oversold sentiment creates contrarian opportunity</li>
                    </ul>
                </div>

                <!-- Bear Case -->
                <div class="overview-card bear">
                    <h3>Bear Case</h3>
                    <ul>
                        <li>Credibility destroyed - dramatic guidance cuts damaged investor confidence</li>
                        <li>Competitive position deteriorating - losing clients to FIS, Jack Henry, CSI</li>
                        <li>Clover strategy failing - forced migration backfired with 16% merchant attrition</li>
                        <li>Securities litigation creates legal overhang and potential financial liability</li>
                        <li>Financial distress signals - Z-Score 1.41 with $23.7B net debt</li>
                        <li>Multi-year turnaround uncertainty - 2026 is transition year with declining EPS</li>
                        <li>Leadership transition risk - multiple simultaneous changes during crisis</li>
                        <li>Structural headwinds from cloud-native fintechs with superior UX</li>
                        <li>Value trap risk - stock could face further downside if 2026 results disappoint</li>
                    </ul>
                </div>

                <!-- Recent Developments -->
                <div class="overview-card">
                    <h3>Recent Developments</h3>
                    <ul>
                        <li><strong>Jan 2026:</strong> Board refreshment with Gordon Nixon, Céline Dufétel, Gary Shedlin</li>
                        <li><strong>Dec 2025:</strong> Co-President structure - Takis Georgakopoulos & Dhivya Suryadevara</li>
                        <li><strong>Oct 31, 2025:</strong> Paul Todd appointed CFO</li>
                        <li><strong>Oct 29, 2025:</strong> Stock collapsed 44% on guidance cuts - EPS to $8.50-8.60, growth to 3.5-4%</li>
                        <li><strong>Oct 2025:</strong> Partnership with Bank of North Dakota for Roughrider stablecoin</li>
                        <li><strong>Oct 2025:</strong> Acquired TD Bank's Canadian merchant processing business</li>
                        <li><strong>Sep 2025:</strong> Acquired CardFree and Smith Consulting Group</li>
                        <li><strong>2025:</strong> Securities class action lawsuit filed by institutional shareholders</li>
                        <li><strong>2025:</strong> AI partnership with Microsoft announced</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- Management Guidance Section -->
    <div class="guidance-section" id="guidanceSection">
        <div class="guidance-header">
            <h3>Management Guidance</h3>
            <span class="guidance-meta">As of <span id="guidanceAsOf">Q3 2025 Earnings</span> | <span id="guidanceFY">FY2025 and FY2026</span></span>
        </div>
        <div class="guidance-grid" id="guidanceGrid"></div>
        <div class="guidance-commentary" id="guidanceCommentary"></div>
    </div>

    <!-- Charts -->
    <h2 class="section-title">Financial Performance</h2>
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Revenue Growth</h3>
                <button class="help-btn" onclick="openModal('revenue')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Revenue by Type: Processing vs Product</h3>
                <button class="help-btn" onclick="openModal('revenueType')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="revenueTypeChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Segment Revenue: Merchant vs Financial</h3>
                <button class="help-btn" onclick="openModal('segments')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="segmentsChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Operating Income & Margin</h3>
                <button class="help-btn" onclick="openModal('opIncome')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="opIncomeChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Net Income & EPS</h3>
                <button class="help-btn" onclick="openModal('netIncome')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="netIncomeChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Free Cash Flow & FCF Margin</h3>
                <button class="help-btn" onclick="openModal('fcf')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="fcfChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Quarterly Revenue Trend</h3>
                <button class="help-btn" onclick="openModal('qRevenue')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="qRevenueChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Quarterly EPS Trend</h3>
                <button class="help-btn" onclick="openModal('qEPS')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="qEPSChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Operating Margin Trend - Quarterly</h3>
                <button class="help-btn" onclick="openModal('qMargin')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="qMarginChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Shares Outstanding Trend</h3>
                <button class="help-btn" onclick="openModal('shares')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="sharesChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Balance Sheet: Debt vs Equity</h3>
                <button class="help-btn" onclick="openModal('balance')">?</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- DCF Valuation Section -->
    <h2 class="section-title">DCF Valuation</h2>

    <div class="dcf-section">
        <!-- Valuation Summary Cards -->
        <div class="dcf-summary">
            <div class="dcf-card highlight">
                <div class="dcf-label">Intrinsic Value</div>
                <div class="dcf-value" id="dcfIV">$106</div>
                <div class="dcf-change negative" id="dcfUpside">-8% downside</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Entry Price (15% CAGR)</div>
                <div class="dcf-value" id="dcfEntry">$86</div>
                <div class="dcf-sublabel">Buy below for 15% annual return</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Current Price</div>
                <div class="dcf-value" id="dcfCurrent">$115</div>
            </div>
            <div class="dcf-card">
                <div class="dcf-label">Prob-Weighted IV</div>
                <div class="dcf-value" id="dcfWeighted">$113</div>
                <div class="dcf-sublabel">30% Bull / 45% Base / 25% Bear</div>
            </div>
        </div>

        <!-- Growth Rate Warning -->
        <div class="dcf-warning" id="growthWarning">
            <span class="warning-icon">&#9888;</span>
            <span id="warningText">Equity CAGR is negative due to share buybacks and First Data acquisition leverage. Using revenue CAGR as primary indicator. Note: FY2019-2024 includes First Data merger distortions. Post-merger revenue CAGR (FY2020-2024) is 8.3%. Company currently in turnaround with growth temporarily suppressed.</span>
        </div>

        <!-- DCF Inputs Display -->
        <div class="dcf-inputs">
            <h4>DCF Model Inputs</h4>
            <div class="dcf-inputs-grid">
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Base Year FCF</div>
                    <div class="dcf-input-value" id="baseFCF">$5.1B</div>
                    <div class="dcf-input-note">FY2024 starting point</div>
                </div>
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Shares Outstanding</div>
                    <div class="dcf-input-value" id="sharesOut">582.1M</div>
                </div>
                <div class="dcf-input-card">
                    <div class="dcf-input-label">Net Debt</div>
                    <div class="dcf-input-value" id="netDebt">$23.6B</div>
                    <div class="dcf-input-note">High leverage concern</div>
                </div>
            </div>
            <div class="fcf-projections">
                <h5>Projected FCF (5-Year)</h5>
                <div class="fcf-projection-table" id="fcfProjectionTable"></div>
            </div>
        </div>

        <!-- Interactive Sliders -->
        <div class="dcf-controls">
            <div class="slider-group">
                <label>Growth Rate: <span id="growthValue">8.0%</span></label>
                <input type="range" id="growthSlider" min="0" max="30" value="8.0" step="0.5">
                <div class="slider-hint" id="growthHint">Based on revenue 3yr CAGR</div>
            </div>
            <div class="slider-group">
                <label>WACC: <span id="waccValue">9.5%</span></label>
                <input type="range" id="waccSlider" min="6" max="18" value="9.5" step="0.5">
            </div>
            <div class="slider-group">
                <label>Terminal Growth: <span id="terminalValue">3.0%</span></label>
                <input type="range" id="terminalSlider" min="0" max="5" value="3.0" step="0.5">
            </div>
        </div>

        <!-- Scenario Tabs -->
        <div class="scenario-tabs">
            <button class="scenario-tab active" data-scenario="base" onclick="switchScenario('base')">Base Case</button>
            <button class="scenario-tab" data-scenario="bull" onclick="switchScenario('bull')">Bull Case</button>
            <button class="scenario-tab" data-scenario="bear" onclick="switchScenario('bear')">Bear Case</button>
        </div>

        <!-- Scenario Details -->
        <div class="scenario-details" id="scenarioDetails">
            <div class="scenario-assumptions">
                <h4>Assumptions</h4>
                <div class="assumption-grid" id="assumptionGrid"></div>
            </div>
        </div>

        <!-- Sensitivity Table -->
        <div class="sensitivity-section">
            <h4>Sensitivity Analysis: Intrinsic Value by WACC & Terminal Growth</h4>
            <table class="sensitivity-table" id="sensitivityMatrix"></table>
        </div>

        <!-- Historical Growth Rates -->
        <div class="historical-growth">
            <h4>Historical Growth Rates (CAGR)</h4>
            <div class="growth-grid" id="growthGrid"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // DATA EMBEDDED DIRECTLY
        const csvData = `Period,Revenue,GrossProfit,GrossMargin,OperatingIncome,OperatingMargin,NetIncome,NetMargin,EPS,FreeCashFlow,OperatingCashFlow,CapEx,ShareholdersEquity,TotalDebt,CashAndEquivalents,SharesOutstanding,MerchantRevenue,FinancialRevenue,ProcessingRevenue,ProductRevenue
FY2014,5066,,,1210,23.9,754,14.9,1.84,1192,1552,360,,,,,,,4219,847
FY2015,5254,,,1311,25.0,712,13.5,1.73,1196,1483,287,,,,,,,4411,843
FY2016,5505,,,1445,26.2,930,16.9,2.26,1192,1552,360,,,,,,,4625,880
FY2017,5696,,,1532,26.9,1232,21.6,2.98,1196,1483,287,,,,,,,4833,863
FY2018,5823,,,1753,30.1,1187,20.4,2.87,1192,1552,360,,,,,,,4975,848
FY2019,10187,,,1609,15.8,893,8.8,1.71,2074,2795,721,32979,21899,893,522.6,,,8573,1614
FY2020,14852,,,1852,12.5,958,6.5,1.40,3247,4147,900,32330,20684,906,683.4,,,12215,2637
FY2021,16226,,,2288,14.1,1334,8.2,1.99,2874,4034,1160,30952,21237,835,671.6,,,13307,2919
FY2022,17737,,,3740,21.1,2530,14.3,3.91,3139,4618,1479,30828,21418,902,647.9,7883,8681,14460,3277
Q1 2022,4138,,,822,19.9,594,14.4,0.93,,,,,,652.7,,,,
Q2 2022,4425,,,908,20.5,622,14.1,0.97,,,,,,650.3,,,,
Q3 2022,4480,,,937,20.9,626,14.0,0.98,,,,,,648.3,,,,
FY2023,19093,,,5014,26.3,3068,16.1,4.98,3774,5162,1388,29857,23118,1204,615.9,8722,9101,15630,3463
Q1 2023,4547,,,934,20.5,563,12.4,0.89,,,,,,631.3,,,3673,874
Q2 2023,4756,,,1131,23.8,683,14.4,1.10,,,,,,619.2,,,3924,832
Q3 2023,4873,,,1503,30.8,952,19.5,1.56,,,,,,610.3,,,4008,865
FY2024,20456,,,5879,28.7,3131,15.3,5.38,5062,6631,1569,27068,24840,1236,582.1,9631,9477,16637,3819
Q1 2024,4883,,,1181,24.2,735,15.1,1.24,,,,,,594.8,,,4000,883
Q2 2024,5107,,,1428,28.0,894,17.5,1.53,,,,,,585.4,,,4140,967
Q3 2024,5215,,,1602,30.7,564,10.8,0.98,,,,,,576.9,,,4237,978
FY2025E,21359,,,6177,28.9,3579,16.8,6.53,4997,6818,1821,25121,30199,1068,535.0,10202,9902,17022,4337
Q1 2025,5130,,,1395,27.2,851,16.6,1.51,313,648,335,25884,28297,1177,564.7,2372,2417,4045,1085
Q2 2025,5516,,,1696,30.7,1026,18.6,1.86,1499,1665,479,25215,29587,999,552.7,2644,2552,4304,1212
Q3 2025,5263,,,1436,27.3,792,15.1,1.46,1284,1805,507,25121,30199,1068,541.8,2586,2333,4273,990
Q4 2025E,5450,,,1650,30.3,910,16.7,1.70,2401,2700,500,,,,,2600,2600,4400,1050`;

        // Embed analysis JSON directly
        const analysis = {
            "ticker": "FISV",
            "company_name": "Fiserv, Inc.",
            "guidance": {
                "as_of": "Q3 2025 Earnings (October 29, 2025)",
                "fiscal_year": "FY2025 and FY2026",
                "items": [
                    {
                        "metric": "Organic Revenue Growth",
                        "target": "3.5-4%",
                        "period": "FY2025",
                        "vs_prior": "lowered",
                        "notes": "Dramatically reduced from prior 10% guidance. Argentina growth normalization revealed underlying mid-single-digit growth."
                    },
                    {
                        "metric": "Adjusted EPS",
                        "target": "$8.50-$8.60",
                        "period": "FY2025",
                        "vs_prior": "lowered",
                        "notes": "Cut from $10.15-$10.30 prior guidance, representing material earnings miss and reset."
                    },
                    {
                        "metric": "Organic Revenue Growth",
                        "target": "Low single digits",
                        "period": "FY2026",
                        "vs_prior": "new",
                        "notes": "2026 positioned as transition/reset year with growth troughing before recovery."
                    },
                    {
                        "metric": "Adjusted EPS",
                        "target": "Modestly down",
                        "period": "FY2026",
                        "vs_prior": "new",
                        "notes": "Expects another year of EPS decline in 2026 before returning to double-digit EPS growth in 2027."
                    },
                    {
                        "metric": "Adjusted Operating Margin",
                        "target": "33-35%",
                        "period": "FY2026",
                        "vs_prior": "new",
                        "notes": "Margins expected to trough in 2026 due to investments in platform consolidation and service improvements."
                    },
                    {
                        "metric": "Clover Revenue",
                        "target": "$3.3B",
                        "period": "FY2025",
                        "vs_prior": "lowered",
                        "notes": "Reduced by $200M from prior guidance due to forced migration attrition and pricing adjustments."
                    },
                    {
                        "metric": "Clover Revenue",
                        "target": "$4.5B",
                        "period": "FY2026",
                        "vs_prior": "maintained",
                        "notes": "Represents 29% CAGR from 2025-2026. Significant analyst skepticism about achievability given 2025 shortfall."
                    },
                    {
                        "metric": "Clover Value-Added Services Mix",
                        "target": "27%+",
                        "period": "FY2026",
                        "vs_prior": "raised",
                        "notes": "Up from upper-teens percentage, indicating focus on higher-margin software and services vs. processing."
                    }
                ],
                "management_commentary": "Management acknowledged execution failures and service delivery issues requiring fundamental operational improvements. Positioned 2026 as a transition year focused on rebuilding client relationships, completing platform consolidation, and restoring operational excellence. Committed to returning to double-digit EPS growth starting in 2027 through operational leverage and recurring revenue streams. New leadership team tasked with cultural and operational transformation. Q4 2025 earnings on February 10, 2026 and investor day planned for first half of 2026 to provide detailed turnaround roadmap."
            }
        };

        // Embed DCF JSON directly
        const dcfData = {
            "ticker": "FISV",
            "valuation_date": "2026-02-02",
            "current_price": 115.00,
            "inputs": {
                "shares_outstanding": 582.1,
                "net_debt": 23604,
                "last_fcf": 5062,
                "currency": "USD",
                "units": "millions"
            },
            "historical_growth": {
                "revenue_3yr_cagr": 8.0,
                "revenue_5yr_cagr": 15.0,
                "eps_3yr_cagr": 39.3,
                "eps_5yr_cagr": 25.8,
                "equity_3yr_cagr": -4.4,
                "equity_5yr_cagr": -3.9,
                "fcf_3yr_cagr": 20.6,
                "fcf_5yr_cagr": 19.6,
                "selected_growth_rate": 8.0,
                "growth_rate_source": "revenue_3yr_cagr",
                "growth_divergence_warning": "Equity CAGR is negative due to share buybacks and First Data acquisition leverage. Using revenue CAGR as primary indicator. Note: FY2019-2024 includes First Data merger distortions. Post-merger revenue CAGR (FY2020-2024) is 8.3%. Company currently in turnaround with growth temporarily suppressed."
            },
            "assumptions": {
                "base": {
                    "growth_rates": [4.0, 3.5, 5.0, 6.5, 7.0],
                    "fcf_margin": 24.0,
                    "wacc": 9.5,
                    "terminal_growth": 3.0,
                    "rationale": "Conservative case reflecting 2026 transition year guidance (low single-digit growth), modest recovery in Years 3-5 as operational improvements take hold. FCF margin stable at historical average. WACC reflects moderate risk given turnaround uncertainty but strong market position."
                },
                "bull": {
                    "growth_rates": [6.0, 8.0, 10.0, 10.0, 9.0],
                    "fcf_margin": 26.5,
                    "wacc": 8.5,
                    "terminal_growth": 3.5,
                    "rationale": "Turnaround succeeds: New leadership executes, Clover hits $4.5B by Year 2, international expansion delivers, platform consolidation drives margin expansion. Returns to historical 8-10% organic growth by Year 3. Management's 2027+ double-digit EPS growth target achieved through operational leverage."
                },
                "bear": {
                    "growth_rates": [2.0, 1.5, 2.5, 3.0, 3.5],
                    "fcf_margin": 22.0,
                    "wacc": 11.0,
                    "terminal_growth": 2.5,
                    "rationale": "Turnaround fails: Clover attrition continues, competitive losses accelerate in Financial Solutions, credibility never recovered. Growth structurally impaired by service delivery issues and market share erosion. Margin compression from competitive pricing pressure. High leverage constrains financial flexibility."
                }
            },
            "valuation": {
                "base": {
                    "intrinsic_value": 105.57,
                    "upside": -8.2
                },
                "bull": {
                    "intrinsic_value": 199.04,
                    "upside": 73.1
                },
                "bear": {
                    "intrinsic_value": 52.35,
                    "upside": -54.5
                }
            },
            "entry_price": {
                "base": {
                    "entry_price": 85.59
                },
                "bull": {
                    "entry_price": 144.72
                },
                "bear": {
                    "entry_price": 52.43
                }
            },
            "sensitivity": {
                "wacc_range": [7.5, 8.5, 9.5, 10.5, 11.5],
                "terminal_growth_range": [2.0, 2.5, 3.0, 3.5, 4.0],
                "matrix": [
                    [147.23, 160.54, 177.42, 199.19, 228.64],
                    [123.04, 132.89, 145.16, 160.54, 180.15],
                    [105.57, 112.94, 121.95, 133.24, 147.66],
                    [92.34, 98.15, 105.21, 113.96, 124.96],
                    [81.98, 86.66, 92.23, 98.96, 107.17]
                ]
            },
            "probability_weighted": {
                "weights": {
                    "bull": 0.30,
                    "base": 0.45,
                    "bear": 0.25
                },
                "weighted_iv": 113.31
            }
        };

        // Parse CSV
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
                return obj;
            });
        }

        const data = parseCSV(csvData);

        // Sort data chronologically (oldest first)
        data.sort((a, b) => {
            const parseDate = (p) => {
                const year = parseInt(p.match(/\d{4}/)?.[0] || '0');
                const isQ1 = p.includes('Q1');
                const isQ2 = p.includes('Q2');
                const isQ3 = p.includes('Q3');
                const isQ4 = p.includes('Q4');
                const isFY = p.startsWith('FY');
                const subOrder = isQ1 ? 1 : isQ2 ? 2 : isQ3 ? 4 : isQ4 ? 5 : isFY ? 7 : 0;
                return year * 10 + subOrder;
            };
            return parseDate(a.Period) - parseDate(b.Period);
        });

        // Filter for annual and quarterly data
        const fyData = data.filter(d => d.Period.startsWith('FY'));
        const qData = data.filter(d => d.Period.startsWith('Q'));

        // Toggle overview
        function toggleOverview() {
            const btn = document.querySelector('.overview-toggle');
            const content = document.getElementById('overviewContent');
            btn.classList.toggle('active');
            content.classList.toggle('active');
        }

        // Render KPIs
        function renderKPIs() {
            const latest = fyData[fyData.length - 1];
            const previous = fyData[fyData.length - 2];

            const kpis = [
                { label: 'Revenue', value: latest.Revenue, prev: previous.Revenue, format: 'B' },
                { label: 'Operating Income', value: latest.OperatingIncome, prev: previous.OperatingIncome, format: 'B' },
                { label: 'Operating Margin', value: latest.OperatingMargin, prev: previous.OperatingMargin, format: '%' },
                { label: 'EPS', value: latest.EPS, prev: previous.EPS, format: '$' },
                { label: 'Free Cash Flow', value: latest.FreeCashFlow, prev: previous.FreeCashFlow, format: 'B' },
                { label: 'FCF Margin', value: (parseFloat(latest.FreeCashFlow) / parseFloat(latest.Revenue) * 100).toFixed(1), prev: (parseFloat(previous.FreeCashFlow) / parseFloat(previous.Revenue) * 100).toFixed(1), format: '%' },
                { label: 'Net Debt', value: (parseFloat(latest.TotalDebt) - parseFloat(latest.CashAndEquivalents)), format: 'B', noChange: true },
                { label: 'Shares Outstanding', value: latest.SharesOutstanding, prev: previous.SharesOutstanding, format: 'M' }
            ];

            const grid = document.getElementById('kpiGrid');
            grid.innerHTML = kpis.map(kpi => {
                let displayValue;
                if (kpi.format === 'B') {
                    displayValue = '$' + (parseFloat(kpi.value) / 1000).toFixed(1) + 'B';
                } else if (kpi.format === 'M') {
                    displayValue = parseFloat(kpi.value).toFixed(0) + 'M';
                } else if (kpi.format === '%') {
                    displayValue = parseFloat(kpi.value).toFixed(1) + '%';
                } else if (kpi.format === '$') {
                    displayValue = '$' + parseFloat(kpi.value).toFixed(2);
                }

                let changeHtml = '';
                if (!kpi.noChange && kpi.prev) {
                    const change = ((parseFloat(kpi.value) - parseFloat(kpi.prev)) / Math.abs(parseFloat(kpi.prev)) * 100).toFixed(1);
                    const changeClass = change >= 0 ? 'positive' : 'negative';
                    changeHtml = `<div class="kpi-change ${changeClass}">${change >= 0 ? '+' : ''}${change}% YoY</div>`;
                }

                return `
                    <div class="kpi-card">
                        <div class="kpi-value">${displayValue}</div>
                        <div class="kpi-label">${kpi.label}</div>
                        ${changeHtml}
                    </div>
                `;
            }).join('');
        }

        // Render guidance
        function renderGuidance() {
            if (!analysis.guidance || !analysis.guidance.items) return;

            const guidance = analysis.guidance;
            document.getElementById('guidanceAsOf').textContent = guidance.as_of || '';
            document.getElementById('guidanceFY').textContent = guidance.fiscal_year || '';

            const grid = document.getElementById('guidanceGrid');
            grid.innerHTML = guidance.items.map(item => {
                const vsClass = item.vs_prior ? item.vs_prior.toLowerCase().replace(' ', '-') : 'new';
                const vsLabel = item.vs_prior ? item.vs_prior.charAt(0).toUpperCase() + item.vs_prior.slice(1) : 'New';
                return `
                    <div class="guidance-card">
                        <div class="guidance-metric">${item.metric}</div>
                        <div class="guidance-target">${item.target}</div>
                        <div class="guidance-period">${item.period}</div>
                        <span class="guidance-vs-prior ${vsClass}">${vsLabel}</span>
                        ${item.notes ? `<div class="guidance-notes">${item.notes}</div>` : ''}
                    </div>
                `;
            }).join('');

            const commentary = document.getElementById('guidanceCommentary');
            if (guidance.management_commentary) {
                commentary.textContent = guidance.management_commentary;
                commentary.style.display = 'block';
            } else {
                commentary.style.display = 'none';
            }
        }

        // Chart defaults
        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#e0e0e0', font: { size: 11 } } }
            },
            scales: {
                x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        };

        const colors = {
            primary: '#00d4aa',
            secondary: '#00b894',
            tertiary: '#0984e3',
            quaternary: '#6c5ce7',
            warning: '#fdcb6e',
            danger: '#ff6b6b'
        };

        // Helper to create color arrays distinguishing estimated periods
        function isEstimated(period) {
            return period && period.includes('E');
        }
        function barColors(dataArr, color) {
            const base = color;
            // Create a semi-transparent version for estimates
            const alpha = color.startsWith('#') ? color + '66' : color.replace(')', ', 0.4)').replace('rgb(', 'rgba(');
            return dataArr.map(d => isEstimated(d.Period) ? alpha : base);
        }
        function borderPattern(dataArr, color) {
            return dataArr.map(d => isEstimated(d.Period) ? color : 'transparent');
        }

        // Revenue Growth Chart
        new Chart(document.getElementById('revenueChart'), {
            type: 'bar',
            data: {
                labels: fyData.map(d => d.Period),
                datasets: [{
                    label: 'Revenue ($M)',
                    data: fyData.map(d => parseFloat(d.Revenue)),
                    backgroundColor: barColors(fyData, colors.primary),
                    borderColor: borderPattern(fyData, colors.primary),
                    borderWidth: fyData.map(d => isEstimated(d.Period) ? 2 : 0),
                    borderDash: [5, 3]
                }]
            },
            options: chartDefaults
        });

        // Revenue by Type Chart
        new Chart(document.getElementById('revenueTypeChart'), {
            type: 'bar',
            data: {
                labels: fyData.filter(d => d.ProcessingRevenue).map(d => d.Period),
                datasets: [
                    {
                        label: 'Processing & Services',
                        data: fyData.filter(d => d.ProcessingRevenue).map(d => parseFloat(d.ProcessingRevenue)),
                        backgroundColor: barColors(fyData.filter(d => d.ProcessingRevenue), colors.primary)
                    },
                    {
                        label: 'Product Revenue',
                        data: fyData.filter(d => d.ProductRevenue).map(d => parseFloat(d.ProductRevenue)),
                        backgroundColor: barColors(fyData.filter(d => d.ProductRevenue), colors.tertiary)
                    }
                ]
            },
            options: {
                ...chartDefaults,
                scales: {
                    ...chartDefaults.scales,
                    x: { ...chartDefaults.scales.x, stacked: true },
                    y: { ...chartDefaults.scales.y, stacked: true }
                }
            }
        });

        // Segment Revenue Chart
        new Chart(document.getElementById('segmentsChart'), {
            type: 'bar',
            data: {
                labels: fyData.filter(d => d.MerchantRevenue).map(d => d.Period),
                datasets: [
                    {
                        label: 'Merchant Solutions',
                        data: fyData.filter(d => d.MerchantRevenue).map(d => parseFloat(d.MerchantRevenue)),
                        backgroundColor: barColors(fyData.filter(d => d.MerchantRevenue), colors.primary)
                    },
                    {
                        label: 'Financial Solutions',
                        data: fyData.filter(d => d.FinancialRevenue).map(d => parseFloat(d.FinancialRevenue)),
                        backgroundColor: barColors(fyData.filter(d => d.FinancialRevenue), colors.secondary)
                    }
                ]
            },
            options: {
                ...chartDefaults,
                scales: {
                    ...chartDefaults.scales,
                    x: { ...chartDefaults.scales.x, stacked: true },
                    y: { ...chartDefaults.scales.y, stacked: true }
                }
            }
        });

        // Operating Income & Margin Chart
        new Chart(document.getElementById('opIncomeChart'), {
            type: 'bar',
            data: {
                labels: fyData.map(d => d.Period),
                datasets: [
                    {
                        label: 'Operating Income ($M)',
                        data: fyData.map(d => parseFloat(d.OperatingIncome)),
                        backgroundColor: barColors(fyData, colors.primary),
                        yAxisID: 'y'
                    },
                    {
                        label: 'Operating Margin (%)',
                        data: fyData.map(d => parseFloat(d.OperatingMargin)),
                        type: 'line',
                        borderColor: colors.warning,
                        backgroundColor: 'transparent',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                ...chartDefaults,
                scales: {
                    x: chartDefaults.scales.x,
                    y: { ...chartDefaults.scales.y, position: 'left' },
                    y1: { ...chartDefaults.scales.y, position: 'right', grid: { display: false } }
                }
            }
        });

        // Net Income & EPS Chart
        new Chart(document.getElementById('netIncomeChart'), {
            type: 'bar',
            data: {
                labels: fyData.map(d => d.Period),
                datasets: [
                    {
                        label: 'Net Income ($M)',
                        data: fyData.map(d => parseFloat(d.NetIncome)),
                        backgroundColor: barColors(fyData, colors.tertiary),
                        yAxisID: 'y'
                    },
                    {
                        label: 'EPS ($)',
                        data: fyData.map(d => parseFloat(d.EPS)),
                        type: 'line',
                        borderColor: colors.primary,
                        backgroundColor: 'transparent',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                ...chartDefaults,
                scales: {
                    x: chartDefaults.scales.x,
                    y: { ...chartDefaults.scales.y, position: 'left' },
                    y1: { ...chartDefaults.scales.y, position: 'right', grid: { display: false } }
                }
            }
        });

        // Free Cash Flow Chart
        new Chart(document.getElementById('fcfChart'), {
            type: 'bar',
            data: {
                labels: fyData.map(d => d.Period),
                datasets: [
                    {
                        label: 'Free Cash Flow ($M)',
                        data: fyData.map(d => parseFloat(d.FreeCashFlow)),
                        backgroundColor: barColors(fyData, colors.secondary),
                        yAxisID: 'y'
                    },
                    {
                        label: 'FCF Margin (%)',
                        data: fyData.map(d => (parseFloat(d.FreeCashFlow) / parseFloat(d.Revenue) * 100)),
                        type: 'line',
                        borderColor: colors.warning,
                        backgroundColor: 'transparent',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                ...chartDefaults,
                scales: {
                    x: chartDefaults.scales.x,
                    y: { ...chartDefaults.scales.y, position: 'left' },
                    y1: { ...chartDefaults.scales.y, position: 'right', grid: { display: false } }
                }
            }
        });

        // Quarterly Revenue Chart
        new Chart(document.getElementById('qRevenueChart'), {
            type: 'bar',
            data: {
                labels: qData.map(d => d.Period),
                datasets: [{
                    label: 'Quarterly Revenue ($M)',
                    data: qData.map(d => parseFloat(d.Revenue)),
                    backgroundColor: barColors(qData, colors.tertiary)
                }]
            },
            options: chartDefaults
        });

        // Quarterly EPS Chart
        new Chart(document.getElementById('qEPSChart'), {
            type: 'bar',
            data: {
                labels: qData.map(d => d.Period),
                datasets: [{
                    label: 'Quarterly EPS ($)',
                    data: qData.map(d => parseFloat(d.EPS)),
                    backgroundColor: barColors(qData, colors.primary)
                }]
            },
            options: chartDefaults
        });

        // Quarterly Margin Chart
        new Chart(document.getElementById('qMarginChart'), {
            type: 'line',
            data: {
                labels: qData.map(d => d.Period),
                datasets: [{
                    label: 'Operating Margin (%)',
                    data: qData.map(d => parseFloat(d.OperatingMargin)),
                    borderColor: colors.warning,
                    backgroundColor: 'transparent'
                }]
            },
            options: chartDefaults
        });

        // Shares Outstanding Chart
        new Chart(document.getElementById('sharesChart'), {
            type: 'line',
            data: {
                labels: data.filter(d => d.SharesOutstanding).map(d => d.Period),
                datasets: [{
                    label: 'Shares Outstanding (M)',
                    data: data.filter(d => d.SharesOutstanding).map(d => parseFloat(d.SharesOutstanding)),
                    borderColor: colors.quaternary,
                    backgroundColor: 'transparent'
                }]
            },
            options: chartDefaults
        });

        // Balance Sheet Chart
        new Chart(document.getElementById('balanceChart'), {
            type: 'bar',
            data: {
                labels: fyData.filter(d => d.TotalDebt).map(d => d.Period),
                datasets: [
                    {
                        label: 'Total Debt',
                        data: fyData.filter(d => d.TotalDebt).map(d => parseFloat(d.TotalDebt)),
                        backgroundColor: barColors(fyData.filter(d => d.TotalDebt), colors.danger)
                    },
                    {
                        label: 'Shareholders Equity',
                        data: fyData.filter(d => d.ShareholdersEquity).map(d => parseFloat(d.ShareholdersEquity)),
                        backgroundColor: barColors(fyData.filter(d => d.ShareholdersEquity), colors.primary)
                    }
                ]
            },
            options: chartDefaults
        });

        // Metric descriptions
        const metricDescriptions = {
            revenue: {
                title: "Revenue",
                content: `
                    <p><strong>Revenue</strong> is Fiserv's total income from payment processing, merchant services, and banking technology solutions.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> Revenue jumped from $6B to $15B+ after the 2019 First Data acquisition. Split 55% Merchant Solutions (Clover, Carat) and 45% Financial Solutions (core banking, digital banking). Processing & services revenue (81% of total) is recurring and transaction-based.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Organic growth rate:</strong> Management cut FY2025 guidance to 3.5-4% from 10% due to Argentina normalization and Clover attrition</li>
                        <li><strong>Clover trajectory:</strong> Targeting $4.5B by 2026 but significant skepticism after $200M 2025 shortfall</li>
                        <li><strong>Segment mix:</strong> Financial Solutions declining (down 3% Q3 2025) due to competitive losses</li>
                        <li><strong>Processing vs Product mix:</strong> Processing revenue more profitable and recurring</li>
                    </ul>
                `
            },
            revenueType: {
                title: "Revenue by Type: Processing vs Product",
                content: `
                    <p>Fiserv breaks revenue into <strong>Processing & Services</strong> (81% of total) and <strong>Product Revenue</strong> (19%).</p>
                    <div class="metric-highlight">
                        <strong>Processing & Services:</strong> Transaction-based fees, account-based fees, and subscription services. Highly recurring with multi-year contracts and 99% retention in core banking. This is the moat.
                    </div>
                    <div class="metric-highlight">
                        <strong>Product Revenue:</strong> Software licenses, hardware sales (Clover terminals), and professional services. Less recurring, lower margins.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Processing & Services growth:</strong> Should grow with transaction volumes and digital adoption</li>
                        <li><strong>Mix shift:</strong> Higher Processing & Services percentage indicates stronger business quality</li>
                        <li><strong>Clover hardware dependency:</strong> Product revenue includes terminal sales which are cyclical</li>
                    </ul>
                `
            },
            segments: {
                title: "Segment Revenue: Merchant vs Financial",
                content: `
                    <p>Fiserv operates two segments following the First Data acquisition:</p>
                    <div class="metric-highlight">
                        <strong>Merchant Solutions (55%):</strong> Payment acceptance via Clover (SMB) and Carat (enterprise). Includes acquiring, processing, POS systems, e-commerce, and value-added services. Currently under pressure from forced migration attrition.
                    </div>
                    <div class="metric-highlight">
                        <strong>Financial Solutions (45%):</strong> Core banking platforms, digital banking, card processing, fraud prevention for banks and credit unions. 99% retention rate but losing share to Jack Henry, FIS, CSI due to service delivery issues.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Financial Solutions trend:</strong> Declining (down 3% Q3 2025) - red flag for core business health</li>
                        <li><strong>Merchant Solutions volatility:</strong> More exposed to consumer spending and SMB health</li>
                        <li><strong>Cross-selling success:</strong> Can Fiserv leverage relationships to sell across segments?</li>
                    </ul>
                `
            },
            opIncome: {
                title: "Operating Income & Margin",
                content: `
                    <p><strong>Operating Income</strong> is profit from core operations before interest and taxes. <strong>Operating Margin</strong> shows efficiency.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> Operating margin collapsed from 30% (FY2018) to 12.5% (FY2020) after First Data acquisition due to integration costs. Has since recovered to 28.7% (FY2024). Management expects margins to trough in 2026 (33-35% adjusted) before expanding long-term as platform consolidation completes.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Margin trajectory:</strong> 2026 will be critical test - can margins hold or expand despite service investments?</li>
                        <li><strong>Platform consolidation impact:</strong> Consolidating 16 core platforms into 5 should drive efficiency gains</li>
                        <li><strong>Clover margin mix:</strong> Value-added services (targeting 27% of Clover revenue) are higher margin</li>
                        <li><strong>Competitive pricing pressure:</strong> Losing clients may force discounting to retain others</li>
                    </ul>
                `
            },
            netIncome: {
                title: "Net Income & EPS",
                content: `
                    <p><strong>Net Income</strong> is bottom-line profit. <strong>EPS</strong> is earnings per share, impacted by share buybacks.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> EPS has grown from $1.71 (FY2019) to $5.38 (FY2024), driven by both operational improvements and aggressive buybacks. Shares outstanding declined from 683M (FY2020) to 582M (FY2024). However, adjusted EPS guidance slashed to $8.50-8.60 for FY2025 and expected to decline modestly in FY2026 before recovering.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>EPS trough in 2026:</strong> Critical inflection point - does it actually recover in 2027 as promised?</li>
                        <li><strong>Buyback sustainability:</strong> With $23.7B net debt and Z-Score 1.41, can buybacks continue?</li>
                        <li><strong>Quality of earnings:</strong> Are EPS gains from operations or financial engineering?</li>
                        <li><strong>2027 double-digit EPS growth target:</strong> Very ambitious given current trajectory</li>
                    </ul>
                `
            },
            fcf: {
                title: "Free Cash Flow & FCF Margin",
                content: `
                    <p><strong>Free Cash Flow</strong> is cash from operations minus capex - the cash available for dividends, buybacks, and debt reduction.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> FCF has grown impressively from $2.1B (FY2019) to $5.1B (FY2024), with FCF margin expanding to 24.7%. This is a bright spot - the company generates strong cash despite operational challenges. FCF growth (20.6% 3yr CAGR) significantly outpaced revenue growth (8.0%).
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>FCF conversion:</strong> Fiserv converts ~87% of operating cash flow to free cash flow (low capex intensity)</li>
                        <li><strong>Debt reduction urgency:</strong> With $23.7B net debt, should prioritize deleveraging over buybacks</li>
                        <li><strong>Working capital changes:</strong> Can inflate/deflate FCF year-to-year</li>
                        <li><strong>Investment needs:</strong> Platform consolidation and service improvements may temporarily pressure FCF</li>
                    </ul>
                `
            },
            qRevenue: {
                title: "Quarterly Revenue Trend",
                content: `
                    <p>Quarterly revenue shows short-term trends and seasonality patterns.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> Q4 2024 revenue missing from data but Q1-Q3 2024 showed sequential growth. However, Q3 2025 revealed underlying weakness when Argentina normalization stripped out. Q4 2025 earnings (Feb 10, 2026) will be critical test of new management credibility.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Q4 2025 results:</strong> Will revenue and guidance stabilize or deteriorate further?</li>
                        <li><strong>Sequential growth:</strong> Quarter-over-quarter momentum more important than YoY given turnaround</li>
                        <li><strong>Clover contribution:</strong> Is Clover growing or still contracting from attrition?</li>
                        <li><strong>Financial Solutions stabilization:</strong> When does client attrition stop?</li>
                    </ul>
                `
            },
            qEPS: {
                title: "Quarterly EPS Trend",
                content: `
                    <p>Quarterly EPS reveals earnings momentum and quality.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> Q3 2024 EPS of $0.98 was significantly below Q1 ($1.24) and Q2 ($1.53), signaling deterioration. This weakness led to the October 2025 guidance catastrophe. Quarterly volatility makes it hard to assess normalized earning power.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Q4 2024 & Q1 2025 results:</strong> Is Q3 2024 weakness an anomaly or new normal?</li>
                        <li><strong>Seasonality:</strong> Merchant Solutions typically stronger in Q4 (holiday shopping)</li>
                        <li><strong>One-time items:</strong> Acquisitions, restructuring charges can distort quarterly EPS</li>
                        <li><strong>Consensus expectations:</strong> Can management rebuild credibility by meeting/beating lowered bar?</li>
                    </ul>
                `
            },
            qMargin: {
                title: "Operating Margin Trend - Quarterly",
                content: `
                    <p>Quarterly operating margin shows profitability trends and operational execution.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> Operating margin improved from 20.5% (Q1 2023) to 30.7% (Q3 2024), demonstrating operational leverage. However, management expects adjusted operating margin to moderate to 33-35% in 2026 due to investments in service improvements and platform consolidation.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Margin sustainability:</strong> Can 28-30% margins hold or will investments compress profitability?</li>
                        <li><strong>Mix effects:</strong> Higher-margin Processing & Services vs lower-margin Product revenue</li>
                        <li><strong>Pricing power:</strong> Can Fiserv raise prices despite competitive pressure?</li>
                        <li><strong>Platform consolidation payoff:</strong> When do efficiency gains materialize?</li>
                    </ul>
                `
            },
            shares: {
                title: "Shares Outstanding Trend",
                content: `
                    <p>Shares outstanding shows capital allocation - buybacks reduce share count, dilution increases it.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> Aggressive buybacks reduced shares from 683M (FY2020) to 582M (FY2024), a 15% reduction. This amplified EPS growth but with $23.7B net debt and Altman Z-Score of 1.41 (distress zone), buyback strategy is questionable. Should prioritize deleveraging.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Buyback pause?</strong> Will new leadership prioritize debt reduction over buybacks?</li>
                        <li><strong>Capital allocation discipline:</strong> Buying back stock at $200 (mid-2024) was value-destructive</li>
                        <li><strong>Dilution risk:</strong> Stock-based compensation to employees adds shares</li>
                        <li><strong>Leverage trade-off:</strong> Each dollar on buybacks is a dollar not reducing debt</li>
                    </ul>
                `
            },
            balance: {
                title: "Balance Sheet: Debt vs Equity",
                content: `
                    <p>Balance sheet health is measured by debt levels and equity strength.</p>
                    <div class="metric-highlight">
                        <strong>For Fiserv:</strong> Total debt of $24.8B with only $1.2B cash = $23.6B net debt. Shareholders' equity declined from $33.0B (FY2019) to $27.1B (FY2024) due to buybacks and dividend distributions. Altman Z-Score of 1.41 indicates elevated financial distress risk.
                    </div>
                    <p><strong>What to watch:</strong></p>
                    <ul>
                        <li><strong>Net debt / EBITDA:</strong> High leverage makes company vulnerable to interest rate shocks</li>
                        <li><strong>Deleveraging plan:</strong> Does new leadership prioritize debt reduction?</li>
                        <li><strong>Credit rating:</strong> Any downgrade would increase borrowing costs</li>
                        <li><strong>Financial flexibility:</strong> High debt limits M&A optionality and crisis resilience</li>
                        <li><strong>Covenant compliance:</strong> Are debt covenants at risk if performance deteriorates?</li>
                    </ul>
                `
            }
        };

        // Modal functions
        function openModal(key) {
            document.getElementById('modalTitle').textContent = metricDescriptions[key].title;
            document.getElementById('modalBody').innerHTML = metricDescriptions[key].content;
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeModal(event) {
            if (event && event.target !== document.getElementById('modalOverlay')) return;
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        // DCF Functions
        let currentScenario = 'base';

        function initDCF() {
            if (!dcfData || !dcfData.valuation) return;

            document.getElementById('dcfCurrent').textContent = '$' + dcfData.current_price.toFixed(0);

            if (dcfData.historical_growth.growth_divergence_warning) {
                document.getElementById('growthWarning').style.display = 'flex';
                document.getElementById('warningText').textContent = dcfData.historical_growth.growth_divergence_warning;
            }

            const base = dcfData.assumptions.base;
            document.getElementById('growthSlider').value = dcfData.historical_growth.selected_growth_rate;
            document.getElementById('waccSlider').value = base.wacc;
            document.getElementById('terminalSlider').value = base.terminal_growth;

            document.getElementById('growthValue').textContent = dcfData.historical_growth.selected_growth_rate + '%';
            document.getElementById('waccValue').textContent = base.wacc + '%';
            document.getElementById('terminalValue').textContent = base.terminal_growth + '%';

            document.getElementById('growthHint').textContent =
                'Based on ' + dcfData.historical_growth.growth_rate_source.replace(/_/g, ' ');

            renderDCFInputs();
            renderHistoricalGrowth();
            renderSensitivityMatrix();
            updateDCFDisplay();
            switchScenario('base');
        }

        function renderDCFInputs() {
            const inputs = dcfData.inputs;
            const currency = inputs.currency || '$';

            const formatNum = (n) => {
                if (Math.abs(n) >= 1000) return currency + (n/1000).toFixed(1) + 'B';
                return currency + n.toFixed(0) + 'M';
            };

            document.getElementById('baseFCF').textContent = formatNum(inputs.last_fcf);

            const shares = inputs.shares_outstanding;
            document.getElementById('sharesOut').textContent = shares.toFixed(1) + 'M';

            const netDebt = inputs.net_debt;
            const netDebtEl = document.getElementById('netDebt');
            netDebtEl.textContent = formatNum(netDebt);
            if (netDebt < 0) netDebtEl.style.color = '#00d4aa';

            renderFCFProjections();
        }

        function renderFCFProjections() {
            const startGrowth = parseFloat(document.getElementById('growthSlider')?.value || dcfData.historical_growth.selected_growth_rate);
            const baseFCF = dcfData.inputs.last_fcf;
            const currency = dcfData.inputs.currency || '$';

            const formatFCF = (n) => {
                if (Math.abs(n) >= 1000) return currency + (n/1000).toFixed(1) + 'B';
                return currency + n.toFixed(0) + 'M';
            };

            const endGrowth = 10;
            const growthRates = [];
            for (let i = 0; i < 5; i++) {
                const rate = startGrowth > endGrowth
                    ? startGrowth - (startGrowth - endGrowth) * (i / 4)
                    : startGrowth;
                growthRates.push(rate);
            }

            let fcf = baseFCF;
            const fcfValues = [baseFCF];

            for (let i = 0; i < 5; i++) {
                fcf = fcf * (1 + growthRates[i] / 100);
                fcfValues.push(fcf);
            }

            let html = `
                <div class="fcf-projection-item header">Base</div>
                <div class="fcf-projection-item header">Year 1</div>
                <div class="fcf-projection-item header">Year 2</div>
                <div class="fcf-projection-item header">Year 3</div>
                <div class="fcf-projection-item header">Year 4</div>
                <div class="fcf-projection-item header">Year 5</div>
            `;

            html += `<div class="fcf-projection-item">
                <div class="fcf-value">${formatFCF(fcfValues[0])}</div>
                <div class="growth-rate">-</div>
            </div>`;

            for (let i = 1; i <= 5; i++) {
                html += `<div class="fcf-projection-item">
                    <div class="fcf-value">${formatFCF(fcfValues[i])}</div>
                    <div class="growth-rate">+${growthRates[i-1].toFixed(0)}%</div>
                </div>`;
            }

            document.getElementById('fcfProjectionTable').innerHTML = html;
        }

        function calculateDCF(startGrowth, wacc, terminalGrowth) {
            const years = 5;
            const fcf = dcfData.inputs.last_fcf;
            let pvFCF = 0;
            let projectedFCF = fcf;

            const endGrowth = 10;

            for (let i = 0; i < years; i++) {
                const yearGrowth = startGrowth > endGrowth
                    ? startGrowth - (startGrowth - endGrowth) * (i / 4)
                    : startGrowth;
                projectedFCF *= (1 + yearGrowth / 100);
                pvFCF += projectedFCF / Math.pow(1 + wacc/100, i + 1);
            }

            const terminalFCF = projectedFCF * (1 + terminalGrowth/100);
            const terminalValue = terminalFCF / (wacc/100 - terminalGrowth/100);
            const pvTerminal = terminalValue / Math.pow(1 + wacc/100, years);

            const enterpriseValue = pvFCF + pvTerminal;
            const equityValue = enterpriseValue - dcfData.inputs.net_debt;
            const iv = equityValue / dcfData.inputs.shares_outstanding;

            const terminalPerShare = terminalValue / dcfData.inputs.shares_outstanding;
            const entryPrice = terminalPerShare / Math.pow(1.15, years);

            return {
                iv: iv,
                entryPrice: entryPrice,
                terminalPerShare: terminalPerShare,
                pvFCF: pvFCF,
                pvTerminal: pvTerminal,
                enterpriseValue: enterpriseValue
            };
        }

        window.updateDCFDisplay = function() {
            const growth = parseFloat(document.getElementById('growthSlider').value);
            const wacc = parseFloat(document.getElementById('waccSlider').value);
            const terminal = parseFloat(document.getElementById('terminalSlider').value);

            document.getElementById('growthValue').textContent = growth.toFixed(1) + '%';
            document.getElementById('waccValue').textContent = wacc.toFixed(1) + '%';
            document.getElementById('terminalValue').textContent = terminal.toFixed(1) + '%';

            renderFCFProjections();

            const result = calculateDCF(growth, wacc, terminal);

            document.getElementById('dcfIV').textContent = '$' + result.iv.toFixed(0);
            document.getElementById('dcfEntry').textContent = '$' + result.entryPrice.toFixed(0);

            const upside = ((result.iv - dcfData.current_price) / dcfData.current_price * 100);
            const upsideEl = document.getElementById('dcfUpside');
            upsideEl.textContent = (upside >= 0 ? '+' : '') + upside.toFixed(0) + '% ' + (upside >= 0 ? 'upside' : 'downside');
            upsideEl.className = 'dcf-change ' + (upside >= 0 ? 'positive' : 'negative');

            document.getElementById('dcfWeighted').textContent = '$' + dcfData.probability_weighted.weighted_iv.toFixed(0);

            const grid = document.getElementById('assumptionGrid');
            if (grid) {
                grid.innerHTML = `
                    <div class="assumption-item">
                        <div class="label">Growth Rate</div>
                        <div class="value">${growth.toFixed(1)}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">WACC</div>
                        <div class="value">${wacc.toFixed(1)}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Terminal Growth</div>
                        <div class="value">${terminal.toFixed(1)}%</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Intrinsic Value</div>
                        <div class="value" style="color: #00d4aa;">$${result.iv.toFixed(0)}</div>
                    </div>
                    <div class="assumption-item">
                        <div class="label">Entry Price</div>
                        <div class="value" style="color: #00d4aa;">$${result.entryPrice.toFixed(0)}</div>
                    </div>
                `;
            }
        };

        window.switchScenario = function(scenario) {
            currentScenario = scenario;

            document.querySelectorAll('.scenario-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.scenario === scenario);
            });

            const assumptions = dcfData.assumptions[scenario];
            const valuation = dcfData.valuation[scenario];

            renderFCFProjections();

            document.getElementById('growthSlider').value = assumptions.growth_rates[0];
            document.getElementById('waccSlider').value = assumptions.wacc;
            document.getElementById('terminalSlider').value = assumptions.terminal_growth;

            const grid = document.getElementById('assumptionGrid');
            grid.innerHTML = `
                <div class="assumption-item">
                    <div class="label">Year 1 Growth</div>
                    <div class="value">${assumptions.growth_rates[0]}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Year 5 Growth</div>
                    <div class="value">${assumptions.growth_rates[4]}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">FCF Margin</div>
                    <div class="value">${assumptions.fcf_margin}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">WACC</div>
                    <div class="value">${assumptions.wacc}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Terminal Growth</div>
                    <div class="value">${assumptions.terminal_growth}%</div>
                </div>
                <div class="assumption-item">
                    <div class="label">Intrinsic Value</div>
                    <div class="value" style="color: #00d4aa;">$${valuation.intrinsic_value.toFixed(0)}</div>
                </div>
            `;

            updateDCFDisplay();
        };

        function renderHistoricalGrowth() {
            const growth = dcfData.historical_growth;
            const selectedSource = growth.growth_rate_source;
            const grid = document.getElementById('growthGrid');

            const metrics = [
                { key: 'revenue_3yr_cagr', label: 'Revenue 3Y' },
                { key: 'revenue_5yr_cagr', label: 'Revenue 5Y' },
                { key: 'eps_3yr_cagr', label: 'EPS 3Y' },
                { key: 'eps_5yr_cagr', label: 'EPS 5Y' },
                { key: 'equity_3yr_cagr', label: 'Equity 3Y' },
                { key: 'equity_5yr_cagr', label: 'Equity 5Y' },
                { key: 'fcf_3yr_cagr', label: 'FCF 3Y' },
                { key: 'fcf_5yr_cagr', label: 'FCF 5Y' }
            ];

            grid.innerHTML = metrics.map(m => {
                const rate = growth[m.key];
                const isSelected = m.key === selectedSource;
                const colorClass = rate >= 0 ? 'positive' : 'negative';
                return `
                    <div class="growth-item ${isSelected ? 'selected' : ''}">
                        <div class="metric">${m.label}</div>
                        <div class="rate ${colorClass}">${rate >= 0 ? '+' : ''}${rate.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');
        }

        function renderSensitivityMatrix() {
            const sens = dcfData.sensitivity;
            const table = document.getElementById('sensitivityMatrix');
            const currentPrice = dcfData.current_price;

            let html = '<tr><th>WACC \\ Term G</th>';
            sens.terminal_growth_range.forEach(tg => {
                html += `<th>${tg}%</th>`;
            });
            html += '</tr>';

            sens.wacc_range.forEach((wacc, i) => {
                html += `<tr><th>${wacc}%</th>`;
                sens.matrix[i].forEach((val, j) => {
                    const isHighlight = wacc === dcfData.assumptions.base.wacc &&
                                       sens.terminal_growth_range[j] === dcfData.assumptions.base.terminal_growth;
                    const colorClass = val >= currentPrice ? 'above-current' : 'below-current';
                    html += `<td class="${isHighlight ? 'highlight' : colorClass}">$${val.toFixed(0)}</td>`;
                });
                html += '</tr>';
            });

            table.innerHTML = html;
        }

        // Initialize everything
        renderKPIs();
        renderGuidance();
        initDCF();

        // Bind slider events
        (function() {
            var growthSlider = document.getElementById('growthSlider');
            var waccSlider = document.getElementById('waccSlider');
            var terminalSlider = document.getElementById('terminalSlider');

            if (growthSlider) {
                growthSlider.oninput = window.updateDCFDisplay;
                growthSlider.onchange = window.updateDCFDisplay;
            }
            if (waccSlider) {
                waccSlider.oninput = window.updateDCFDisplay;
                waccSlider.onchange = window.updateDCFDisplay;
            }
            if (terminalSlider) {
                terminalSlider.oninput = window.updateDCFDisplay;
                terminalSlider.onchange = window.updateDCFDisplay;
            }
        })();
    </script>
</body>
</html>
